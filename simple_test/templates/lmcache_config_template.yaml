# LMCache 配置模板 - 连接到 Mooncake Store

# =============================================================================
# 基础配置
# =============================================================================

# KV Cache 分块大小
chunk_size: 256  # 推荐值: 128-512，越小缓存粒度越细

# Mooncake Store URL
remote_url: "mooncakestore://YOUR_MOONCAKE_IP:50052/"  # 替换为你的 Mooncake Master IP:Port

# 序列化方式
remote_serde: "naive"  # 使用 naive 序列化

# 本地 CPU 缓存（可选）
local_cpu: false  # 是否启用本地 CPU 缓存
max_local_cpu_size: 100  # 本地 CPU 缓存大小（MB）

# =============================================================================
# Mooncake 详细配置
# =============================================================================

extra_config:
  # -------------------------------------------------------------------------
  # 网络配置
  # -------------------------------------------------------------------------

  # 本机主机名或 IP（运行 vLLM 的机器）
  local_hostname: "YOUR_LOCAL_IP"  # 替换为你的本机 IP

  # Mooncake Metadata Server 地址
  metadata_server: "http://YOUR_MOONCAKE_IP:8080/metadata"  # 替换为 Mooncake IP

  # -------------------------------------------------------------------------
  # 传输协议配置
  # -------------------------------------------------------------------------

  # 传输协议
  protocol: "rdma"  # 选项: "rdma" 或 "tcp"
  # - rdma: 高性能，需要 RDMA 网卡（InfiniBand/RoCE）
  # - tcp:  兼容性好，性能较低

  # RDMA 设备名称（仅当 protocol="rdma" 时需要）
  device_name: "mlx5_0"  # 查看: rdma link
  # 多设备用逗号分隔: "mlx5_0,mlx5_1"

  # -------------------------------------------------------------------------
  # Mooncake Master 配置
  # -------------------------------------------------------------------------

  # Mooncake Master 服务器地址
  master_server_address: "YOUR_MOONCAKE_IP:50052"  # 替换为 Mooncake Master 地址

  # -------------------------------------------------------------------------
  # 缓存大小配置
  # -------------------------------------------------------------------------

  # 全局缓存段大小（字节）
  global_segment_size: 107374182400  # 100GB
  # 推荐值:
  # - 72B 模型:  100GB (107374182400)
  # - 671B 模型: 200GB (214748364800)
  # 注意: 不要超过可用内存的 70%

  # 本地传输缓冲区大小（字节）
  local_buffer_size: 2147483648  # 2GB
  # 推荐值:
  # - 标准: 2GB (2147483648)
  # - 高性能: 4GB (4294967296)

  # -------------------------------------------------------------------------
  # 超时和性能配置
  # -------------------------------------------------------------------------

  # 传输超时时间（秒）
  transfer_timeout: 10
  # 推荐值:
  # - 72B 模型: 10 秒
  # - 671B 模型: 20 秒

  # 是否保存 chunk 元数据
  save_chunk_meta: false  # 一般设为 false

# =============================================================================
# 配置示例
# =============================================================================

# --- 示例 1: 使用 TCP 协议（简单配置）---
# chunk_size: 256
# remote_url: "mooncakestore://192.168.1.100:50052/"
# remote_serde: "naive"
# local_cpu: false
# max_local_cpu_size: 100
#
# extra_config:
#   local_hostname: "192.168.1.101"
#   metadata_server: "http://192.168.1.100:8080/metadata"
#   protocol: "tcp"
#   master_server_address: "192.168.1.100:50052"
#   global_segment_size: 107374182400  # 100GB
#   local_buffer_size: 2147483648      # 2GB
#   transfer_timeout: 10
#   save_chunk_meta: false

# --- 示例 2: 使用 RDMA 协议（高性能配置）---
# chunk_size: 256
# remote_url: "mooncakestore://192.168.1.100:50052/"
# remote_serde: "naive"
# local_cpu: false
# max_local_cpu_size: 100
#
# extra_config:
#   local_hostname: "192.168.1.101"
#   metadata_server: "http://192.168.1.100:8080/metadata"
#   protocol: "rdma"
#   device_name: "mlx5_0,mlx5_1"  # 多网卡
#   master_server_address: "192.168.1.100:50052"
#   global_segment_size: 214748364800  # 200GB (671B 模型)
#   local_buffer_size: 4294967296      # 4GB
#   transfer_timeout: 20
#   save_chunk_meta: false

# --- 示例 3: 容器环境配置 ---
# chunk_size: 256
# remote_url: "mooncakestore://mooncake-master:50052/"  # 使用容器名
# remote_serde: "naive"
# local_cpu: false
# max_local_cpu_size: 100
#
# extra_config:
#   local_hostname: "vllm-server"  # 容器主机名
#   metadata_server: "http://mooncake-master:8080/metadata"
#   protocol: "tcp"  # 容器内一般用 TCP
#   master_server_address: "mooncake-master:50052"
#   global_segment_size: 107374182400
#   local_buffer_size: 2147483648
#   transfer_timeout: 10
#   save_chunk_meta: false

# =============================================================================
# 使用说明
# =============================================================================

# 1. 复制此文件并重命名
#    cp lmcache_config_template.yaml lmcache_config.yaml

# 2. 修改所有 YOUR_XXX_IP 为实际 IP 地址

# 3. 根据你的硬件选择协议
#    - 有 RDMA: protocol: "rdma"
#    - 无 RDMA: protocol: "tcp"

# 4. 根据模型大小调整 global_segment_size
#    - 72B:  100GB
#    - 671B: 200GB+

# 5. 启动服务时加载配置
#    export LMCACHE_CONFIG_FILE=/path/to/lmcache_config.yaml
#    export LMCACHE_USE_EXPERIMENTAL=True
#    vllm serve YOUR_MODEL ...

# =============================================================================
# 验证配置
# =============================================================================

# 1. 检查 Mooncake Master 连接
#    curl http://YOUR_MOONCAKE_IP:9004/metrics | grep master_key_count

# 2. 检查 Metadata Server
#    curl http://YOUR_MOONCAKE_IP:8080/metadata

# 3. 检查 RDMA 设备（如果使用 RDMA）
#    rdma link
#    # 或
#    ibstatus

# 4. 启动服务后查看日志
#    # 应该看到: "LMCache config loaded" 和 "Using Mooncake Store backend"

# =============================================================================
# 性能调优
# =============================================================================

# 调优参数 1: chunk_size
# - 更小的值（128）: 更细粒度的缓存，可能提高命中率
# - 更大的值（512）: 减少元数据开销，提高传输效率
# - 建议从 256 开始测试

# 调优参数 2: local_buffer_size
# - 增大可以提升传输批处理效率
# - 推荐: 2GB-4GB

# 调优参数 3: protocol + device_name
# - RDMA 比 TCP 快 2-5 倍
# - 多 RDMA 设备可聚合带宽

# 调优参数 4: transfer_timeout
# - 大模型需要更长超时
# - 网络慢时增加此值
