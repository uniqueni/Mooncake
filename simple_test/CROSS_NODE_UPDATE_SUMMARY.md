# ğŸŒ è·¨èŠ‚ç‚¹æµ‹è¯•åŠŸèƒ½æ›´æ–°æ€»ç»“

## æ›´æ–°å†…å®¹

æœ¬æ¬¡æ›´æ–°ä¸º Mooncake KV Cache æµ‹è¯•æ¡†æ¶æ·»åŠ äº†**è·¨èŠ‚ç‚¹æµ‹è¯•**æ”¯æŒï¼Œå¯ä»¥éªŒè¯ä¸åŒ vLLM å®ä¾‹é—´çš„ KV Cache ä¼ è¾“èƒ½åŠ›ã€‚

---

## æ ¸å¿ƒåŠŸèƒ½

### 1. è‡ªåŠ¨è·Ÿè¸ªæµ‹è¯•èŠ‚ç‚¹

æµ‹è¯•è„šæœ¬ (`test_simple.py`) ç°åœ¨ä¼šè®°å½•æ¯è½®æµ‹è¯•ä½¿ç”¨çš„ endpointï¼š

```python
# RoundStats æ–°å¢å­—æ®µ
endpoint_url: Optional[str] = None  # è®°å½•ä½¿ç”¨çš„ endpoint URL
```

### 2. æŠ¥å‘Šä¸­æ˜¾ç¤ºèŠ‚ç‚¹ä¿¡æ¯

æŠ¥å‘Šå·¥å…· (`generate_multi_scenario_report.py`) ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶æ˜¾ç¤ºè·¨èŠ‚ç‚¹æµ‹è¯•ï¼š

#### ç‰¹æ€§ 1: åœºæ™¯æ ‡è¯†
è·¨èŠ‚ç‚¹æµ‹è¯•åœ¨è¡¨æ ¼ä¸­å¸¦æœ‰ ğŸŒ æ ‡è¯†ï¼š
```markdown
| æµ‹è¯•åœºæ™¯ | Baseline | Cache Hit | é™ä½ | çŠ¶æ€ |
|---------|----------|-----------|------|------|
| ğŸŒ è…¾è®¯äº‘-è·¨èŠ‚ç‚¹-Qwen2.5-72B | 1500 ms | 450 ms | 70.0% | âœ… |
```

#### ç‰¹æ€§ 2: èŠ‚ç‚¹ä¿¡æ¯æ±‡æ€»
æŠ¥å‘Šå¼€å¤´æ˜¾ç¤ºæ‰€æœ‰è·¨èŠ‚ç‚¹æµ‹è¯•çš„è¯¦ç»†ä¿¡æ¯ï¼š
```markdown
### ğŸŒ è·¨èŠ‚ç‚¹æµ‹è¯•ä¿¡æ¯

æœ¬æ¬¡æµ‹è¯•åŒ…å« **1** ä¸ªè·¨èŠ‚ç‚¹åœºæ™¯ï¼š

1. **è…¾è®¯äº‘-è·¨èŠ‚ç‚¹-Qwen2.5-72B**
   - èŠ‚ç‚¹ A (å­˜å‚¨ç¼“å­˜): `http://10.237.65.81:8080/v1`
   - èŠ‚ç‚¹ B (åŠ è½½ç¼“å­˜): `http://10.237.65.95:8080/v1`
```

#### ç‰¹æ€§ 3: è¯¦ç»†æ•°æ®ä¸­çš„èŠ‚ç‚¹ä¿¡æ¯
æ¯ä¸ªåœºæ™¯çš„è¯¦ç»†æ•°æ®ä¼šæ˜¾ç¤ºå…·ä½“èŠ‚ç‚¹åœ°å€ï¼š
```markdown
#### ğŸŒ è·¨èŠ‚ç‚¹æµ‹è¯•ä¿¡æ¯

- **Round 1 (Baseline)**: èŠ‚ç‚¹ A - `http://10.237.65.81:8080/v1`
- **Round 2 (Cache Hit)**: èŠ‚ç‚¹ B - `http://10.237.65.95:8080/v1`
- **KV Cache ä¼ è¾“**: âœ… ä»èŠ‚ç‚¹ A ä¼ è¾“åˆ°èŠ‚ç‚¹ B
```

---

## ä¿®æ”¹çš„æ–‡ä»¶

### 1. `scripts/test_simple.py`

**ä¿®æ”¹å†…å®¹**ï¼š
- `RoundStats` æ•°æ®ç±»æ·»åŠ  `endpoint_url` å­—æ®µï¼ˆç¬¬ 72 è¡Œï¼‰
- `_calc_stats()` æ–¹æ³•æ¥å— `endpoint_url` å‚æ•°ï¼ˆç¬¬ 358 è¡Œï¼‰
- `run_scenario()` ä¼ é€’ `round_api_url` ç»™ `_calc_stats()`ï¼ˆç¬¬ 345 è¡Œï¼‰
- `save_results()` åœ¨æ–‡ä»¶åä¸­åŒ…å«åœºæ™¯å‰ç¼€ï¼ˆç¬¬ 446-454 è¡Œï¼‰

**å…³é”®ä»£ç **ï¼š
```python
@dataclass
class RoundStats:
    # ... å…¶ä»–å­—æ®µ ...
    endpoint_url: Optional[str] = None  # æ–°å¢

def _calc_stats(self, results, scenario, round_num, total_time, endpoint_url=None):
    # ... è®¡ç®—ç»Ÿè®¡ ...
    return RoundStats(
        # ... å…¶ä»–å‚æ•° ...
        endpoint_url=endpoint_url
    )
```

### 2. `reports/generate_multi_scenario_report.py`

**ä¿®æ”¹å†…å®¹**ï¼š
- æ·»åŠ  `_get_cross_node_summary()` æ–¹æ³•ï¼ˆç¬¬ 111-150 è¡Œï¼‰
- ä¿®æ”¹ `generate_summary_table()` æ˜¾ç¤ºè·¨èŠ‚ç‚¹æ ‡è¯†ï¼ˆç¬¬ 163-180 è¡Œï¼‰
- ä¿®æ”¹æ‰€æœ‰æ±‡æ€»è¡¨æ ¼æ·»åŠ  ğŸŒ æ ‡è¯†ï¼ˆç¬¬ 183-233 è¡Œï¼‰
- ä¿®æ”¹ `generate_detailed_tables()` æ˜¾ç¤ºèŠ‚ç‚¹ä¿¡æ¯ï¼ˆç¬¬ 177-192 è¡Œï¼‰

**å…³é”®ä»£ç **ï¼š
```python
def _get_cross_node_summary(self) -> str:
    """ç”Ÿæˆè·¨èŠ‚ç‚¹æµ‹è¯•æ±‡æ€»"""
    # æ£€æµ‹è·¨èŠ‚ç‚¹æµ‹è¯•å¹¶ç”Ÿæˆæ±‡æ€»ä¿¡æ¯

def generate_detailed_tables(self) -> str:
    # æ£€æµ‹å¹¶æ˜¾ç¤ºèŠ‚ç‚¹ä¿¡æ¯
    if is_cross_node:
        lines.append("#### ğŸŒ è·¨èŠ‚ç‚¹æµ‹è¯•ä¿¡æ¯")
        lines.append(f"- **Round 1**: èŠ‚ç‚¹ A - `{endpoint1}`")
        lines.append(f"- **Round 2**: èŠ‚ç‚¹ B - `{endpoint2}`")
```

---

## æ–°å¢çš„æ–‡ä»¶

### 1. `configs/test_config_cross_node_example.yaml`

å®Œæ•´çš„è·¨èŠ‚ç‚¹æµ‹è¯•é…ç½®ç¤ºä¾‹ï¼ŒåŒ…å«ï¼š
- `endpoints_per_round` é…ç½®è¯´æ˜
- è¯¦ç»†çš„æ³¨é‡Šå’Œä½¿ç”¨è¯´æ˜
- æµ‹è¯•æµç¨‹å’ŒéªŒè¯è¦ç‚¹

**å…³é”®é…ç½®**ï¼š
```yaml
endpoints_per_round:
  1: "http://10.237.65.81:8080/v1"  # Round 1: èŠ‚ç‚¹ A
  2: "http://10.237.65.95:8080/v1"  # Round 2: èŠ‚ç‚¹ B
```

### 2. `docs/CROSS_NODE_TESTING_GUIDE.md`

è¯¦ç»†çš„è·¨èŠ‚ç‚¹æµ‹è¯•æŒ‡å—ï¼ŒåŒ…å«ï¼š
- æµ‹è¯•åŸç†å’Œå·¥ä½œæµç¨‹å›¾
- å®Œæ•´é…ç½®æ­¥éª¤
- æŠ¥å‘Šè§£è¯»è¯´æ˜
- éªŒè¯è¦ç‚¹å’Œæ•…éšœæ’æŸ¥
- å®Œæ•´æµ‹è¯•ç¤ºä¾‹

---

## ä½¿ç”¨æ–¹æ³•

### å¿«é€Ÿå¼€å§‹

```bash
cd simple_test

# 1. åˆ›å»ºè·¨èŠ‚ç‚¹é…ç½®
cp configs/test_config_cross_node_example.yaml configs/test_cross_node.yaml
vim configs/test_cross_node.yaml  # ä¿®æ”¹èŠ‚ç‚¹åœ°å€

# 2. è¿è¡Œæµ‹è¯•
python3 scripts/test_simple.py --config configs/test_cross_node.yaml

# 3. ç”ŸæˆæŠ¥å‘Š
python3 reports/generate_multi_scenario_report.py \
    --scenario "è·¨èŠ‚ç‚¹æµ‹è¯•-Qwen2.5-72B" \
    --stats test_results/with-cache_*_stats_*.json \
    --output cross_node_report.md

# 4. æŸ¥çœ‹æŠ¥å‘Š
cat cross_node_report.md
```

### é…ç½®è¦ç‚¹

**å¿…é¡»é…ç½®**ï¼š
```yaml
endpoints_per_round:
  1: "http://èŠ‚ç‚¹A:ç«¯å£/v1"  # Round 1 çš„ endpoint
  2: "http://èŠ‚ç‚¹B:ç«¯å£/v1"  # Round 2 çš„ endpoint
```

**å‰ææ¡ä»¶**ï¼š
- ä¸¤ä¸ªèŠ‚ç‚¹éƒ½é…ç½®äº† LMCache è¿æ¥ Mooncake
- ä¸¤ä¸ªèŠ‚ç‚¹ä½¿ç”¨ç›¸åŒçš„æ¨¡å‹
- Mooncake é›†ç¾¤æ­£å¸¸è¿è¡Œ

---

## æŠ¥å‘Šç¤ºä¾‹

### å•åœºæ™¯æŠ¥å‘Š

ä½¿ç”¨ `compare_results.py` ç”Ÿæˆçš„æŠ¥å‘Šä¼šåŒ…å«ï¼š

```markdown
### è·¨èŠ‚ç‚¹æµ‹è¯•ä¿¡æ¯ ğŸŒ

- **Round 1 (Baseline)**: èŠ‚ç‚¹ A - `http://10.237.65.81:8080/v1`
- **Round 2 (Cache Hit)**: èŠ‚ç‚¹ B - `http://10.237.65.95:8080/v1`
- **KV Cache ä¼ è¾“**: âœ… ä»èŠ‚ç‚¹ A ä¼ è¾“åˆ°èŠ‚ç‚¹ B

### æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | Round 1 | Round 2 | æ”¹å–„ |
|------|---------|---------|------|
| TTFT | 1500 ms | 450 ms | -70% |
| ååé‡ | 1.2 req/s | 3.5 req/s | +192% |
```

### å¤šåœºæ™¯å¯¹æ¯”æŠ¥å‘Š

ä½¿ç”¨ `generate_multi_scenario_report.py` ç”Ÿæˆçš„æŠ¥å‘Šä¼šåŒ…å«ï¼š

```markdown
## ğŸ“Š æµ‹è¯•ç»“æœæ±‡æ€»

### ğŸŒ è·¨èŠ‚ç‚¹æµ‹è¯•ä¿¡æ¯

æœ¬æ¬¡æµ‹è¯•åŒ…å« **2** ä¸ªè·¨èŠ‚ç‚¹åœºæ™¯ï¼š

1. **è…¾è®¯äº‘-è·¨èŠ‚ç‚¹-Qwen2.5-72B**
   - èŠ‚ç‚¹ A (å­˜å‚¨ç¼“å­˜): `http://10.237.65.81:8080/v1`
   - èŠ‚ç‚¹ B (åŠ è½½ç¼“å­˜): `http://10.237.65.95:8080/v1`

2. **ç«å±±äº‘-è·¨èŠ‚ç‚¹-Deepseek-R1**
   - èŠ‚ç‚¹ A (å­˜å‚¨ç¼“å­˜): `http://192.168.1.100:8000/v1`
   - èŠ‚ç‚¹ B (åŠ è½½ç¼“å­˜): `http://192.168.1.101:8000/v1`

### TTFT å¯¹æ¯”

| æµ‹è¯•åœºæ™¯ | Baseline | Cache Hit | é™ä½ | çŠ¶æ€ |
|---------|----------|-----------|------|------|
| ğŸŒ è…¾è®¯äº‘-è·¨èŠ‚ç‚¹-Qwen2.5-72B | 1500 ms | 450 ms | 70% | âœ… |
| ğŸŒ ç«å±±äº‘-è·¨èŠ‚ç‚¹-Deepseek-R1 | 1400 ms | 420 ms | 70% | âœ… |
| è…¾è®¯äº‘-å•æœº-Qwen2.5-72B | 1500 ms | 400 ms | 73% | âœ… |
```

---

## éªŒè¯æ–¹æ³•

### 1. æ£€æŸ¥é…ç½®æ­£ç¡®æ€§

è¿è¡Œæµ‹è¯•æ—¶ï¼Œæ§åˆ¶å°ä¼šæ˜¾ç¤ºï¼š
```
ğŸ“Š Round 1/2
   ğŸ¥¶ Cold Start
   ğŸŒ è·¨èŠ‚ç‚¹æµ‹è¯• - ä½¿ç”¨ endpoint: http://10.237.65.81:8080/v1
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ç­‰å¾… 5s...

ğŸ“Š Round 2/2
   ğŸ”¥ Cache Hit
   ğŸŒ è·¨èŠ‚ç‚¹æµ‹è¯• - ä½¿ç”¨ endpoint: http://10.237.65.95:8080/v1
```

### 2. æ£€æŸ¥ç»“æœæ–‡ä»¶

`test_results/` ç›®å½•ä¸­çš„ stats JSON æ–‡ä»¶ä¼šåŒ…å«ï¼š
```json
{
  "scenario": "long_context_high_reuse",
  "round_num": 2,
  "endpoint_url": "http://10.237.65.95:8080/v1",
  "avg_ttft": 0.45,
  ...
}
```

### 3. æ£€æŸ¥æŠ¥å‘Šå†…å®¹

æŠ¥å‘Šä¸­ä¼šæ˜¾ç¤ºï¼š
- ğŸŒ æ ‡è¯†ï¼ˆè·¨èŠ‚ç‚¹åœºæ™¯ï¼‰
- èŠ‚ç‚¹ A å’ŒèŠ‚ç‚¹ B çš„åœ°å€
- "KV Cache ä¼ è¾“: âœ… ä»èŠ‚ç‚¹ A ä¼ è¾“åˆ°èŠ‚ç‚¹ B"

---

## æ€§èƒ½é¢„æœŸ

### ä¼˜ç§€æŒ‡æ ‡

- **TTFT é™ä½**: â‰¥60%
- **ååé‡æå‡**: â‰¥150%

è¾¾åˆ°è¿™äº›æŒ‡æ ‡è¯´æ˜ï¼š
- âœ… Mooncake æˆåŠŸåœ¨èŠ‚ç‚¹é—´ä¼ è¾“ KV Cache
- âœ… èŠ‚ç‚¹ B æˆåŠŸåŠ è½½å¹¶ä½¿ç”¨äº†èŠ‚ç‚¹ A çš„ç¼“å­˜
- âœ… è·¨èŠ‚ç‚¹ä¼ è¾“æ€§èƒ½è‰¯å¥½

### ä¸å•æœºæµ‹è¯•å¯¹æ¯”

è·¨èŠ‚ç‚¹æµ‹è¯•çš„ TTFT å¯èƒ½ç•¥é«˜äºå•æœºï¼ˆå¤šäº†ç½‘ç»œä¼ è¾“å¼€é”€ï¼‰ï¼š

| æµ‹è¯•ç±»å‹ | TTFT é™ä½ | è¯´æ˜ |
|---------|----------|------|
| å•æœºæµ‹è¯• | 73% | æœ¬åœ°ç¼“å­˜ï¼Œæ— ç½‘ç»œå¼€é”€ |
| è·¨èŠ‚ç‚¹æµ‹è¯• | 70% | æœ‰ç½‘ç»œä¼ è¾“ï¼Œä½†ä»ç„¶è¾¾æ ‡ |

å·®å¼‚ 3% æ˜¯æ­£å¸¸çš„ï¼Œå› ä¸ºè·¨èŠ‚ç‚¹ä¼ è¾“éœ€è¦é€šè¿‡ç½‘ç»œï¼ˆå³ä½¿ä½¿ç”¨ RDMAï¼‰ã€‚

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: æŠ¥å‘Šä¸­æ²¡æœ‰æ˜¾ç¤ºèŠ‚ç‚¹ä¿¡æ¯

**åŸå› **: å¯èƒ½æ²¡æœ‰é…ç½® `endpoints_per_round`

**è§£å†³**:
```yaml
# åœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ 
endpoints_per_round:
  1: "http://èŠ‚ç‚¹A/v1"
  2: "http://èŠ‚ç‚¹B/v1"
```

### é—®é¢˜ 2: TTFT æ²¡æœ‰é™ä½

**åŸå› **: èŠ‚ç‚¹ B å¯èƒ½æ²¡æœ‰æ­£ç¡®åŠ è½½ç¼“å­˜

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥èŠ‚ç‚¹ B çš„ LMCache é…ç½®
2. æ£€æŸ¥ Mooncake æ˜¯å¦å­˜å‚¨äº† KV Cache
3. æ£€æŸ¥ä¸¤ä¸ªèŠ‚ç‚¹çš„ Mooncake é…ç½®æ˜¯å¦ä¸€è‡´

**è¯¦ç»†æ’æŸ¥**: æŸ¥çœ‹ `docs/CROSS_NODE_TESTING_GUIDE.md`

### é—®é¢˜ 3: è¿æ¥èŠ‚ç‚¹ B å¤±è´¥

**åŸå› **: ç½‘ç»œè¿æ¥é—®é¢˜æˆ–èŠ‚ç‚¹ B æœªå¯åŠ¨

**æ’æŸ¥**:
```bash
# æ£€æŸ¥èŠ‚ç‚¹ B æ˜¯å¦å¯åŠ¨
curl http://èŠ‚ç‚¹B:ç«¯å£/v1/models

# æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
ping èŠ‚ç‚¹B
telnet èŠ‚ç‚¹B ç«¯å£
```

---

## æ–‡æ¡£ç´¢å¼•

### å¿«é€Ÿå¼€å§‹
- **README.md** - æ€»ä½“è¯´æ˜
- **START_HERE_MANUAL.md** - æ‰‹åŠ¨æ¸…ç†æ–¹å¼ï¼ˆæ¨èï¼‰
- **QUICKSTART.md** - 3 åˆ†é’Ÿå¿«é€Ÿå¼€å§‹

### è·¨èŠ‚ç‚¹æµ‹è¯•
- **docs/CROSS_NODE_TESTING_GUIDE.md** - å®Œæ•´çš„è·¨èŠ‚ç‚¹æµ‹è¯•æŒ‡å—
- **configs/test_config_cross_node_example.yaml** - é…ç½®ç¤ºä¾‹

### é‡è¦è¯´æ˜
- **IMPORTANT_CACHE_ISOLATION.md** - ç¼“å­˜éš”ç¦»é—®é¢˜ï¼ˆå¿…è¯»ï¼ï¼‰
- **SUMMARY.md** - æ–‡ä»¶æ•´ç†æ€»ç»“

---

## å…¼å®¹æ€§

### å‘åå…¼å®¹

- âœ… ä¸å½±å“ç°æœ‰çš„å•æœºæµ‹è¯•
- âœ… `endpoint_url` å­—æ®µæ˜¯å¯é€‰çš„
- âœ… æ—§çš„ stats æ–‡ä»¶ä»ç„¶å¯ä»¥æ­£å¸¸ç”ŸæˆæŠ¥å‘Š
- âœ… å¦‚æœæ²¡æœ‰é…ç½® `endpoints_per_round`ï¼Œè¡Œä¸ºå’Œä¹‹å‰å®Œå…¨ä¸€è‡´

### æœ€ä½è¦æ±‚

- Python 3.7+
- openai åŒ…ï¼ˆå·²æœ‰ï¼‰
- matplotlibï¼ˆå¯é€‰ï¼Œç”¨äºå›¾è¡¨ï¼‰

---

## æ€»ç»“

### æ–°å¢åŠŸèƒ½

1. âœ… è‡ªåŠ¨è·Ÿè¸ªæ¯è½®æµ‹è¯•ä½¿ç”¨çš„ endpoint
2. âœ… è‡ªåŠ¨æ£€æµ‹è·¨èŠ‚ç‚¹æµ‹è¯•
3. âœ… æŠ¥å‘Šä¸­æ˜¾ç¤ºèŠ‚ç‚¹ä¿¡æ¯å’Œ ğŸŒ æ ‡è¯†
4. âœ… ç”Ÿæˆè·¨èŠ‚ç‚¹æµ‹è¯•æ±‡æ€»
5. âœ… å®Œæ•´çš„é…ç½®ç¤ºä¾‹å’Œæ–‡æ¡£

### ä½¿ç”¨æ­¥éª¤

```bash
# 1. é…ç½®è·¨èŠ‚ç‚¹æµ‹è¯•
vim configs/test_cross_node.yaml

# 2. è¿è¡Œæµ‹è¯•
python3 scripts/test_simple.py --config configs/test_cross_node.yaml

# 3. ç”ŸæˆæŠ¥å‘Š
python3 reports/generate_multi_scenario_report.py \
    --scenario "è·¨èŠ‚ç‚¹æµ‹è¯•" --stats test_results/stats.json \
    --output report.md

# 4. æŸ¥çœ‹æŠ¥å‘Šï¼ˆä¼šæ˜¾ç¤ºèŠ‚ç‚¹ä¿¡æ¯ï¼‰
cat report.md
```

### æ–‡æ¡£

- ğŸ“– è¯¦ç»†æŒ‡å—: `docs/CROSS_NODE_TESTING_GUIDE.md`
- ğŸ“ é…ç½®ç¤ºä¾‹: `configs/test_config_cross_node_example.yaml`
- ğŸ“‹ æ€»ä½“è¯´æ˜: `README.md`

---

**æ›´æ–°å®Œæˆï¼** ç°åœ¨å¯ä»¥è½»æ¾æµ‹è¯• Mooncake çš„è·¨èŠ‚ç‚¹ KV Cache ä¼ è¾“èƒ½åŠ›ã€‚ğŸ‰
