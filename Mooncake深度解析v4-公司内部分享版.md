# ã€Mooncakeã€‘ï¼šä¸€å£ä¸€å£åƒæ‰è¿™å—æœˆé¥¼ ğŸ¥®

> **æ–‡æ¡£ç‰ˆæœ¬**ï¼šv4.0
> **é€‚ç”¨å¯¹è±¡**ï¼šå…¬å¸å†…éƒ¨æŠ€æœ¯åˆ†äº«
> **é¢„è®¡æ—¶é•¿**ï¼š60-75 åˆ†é’Ÿ
> **å‰ç½®çŸ¥è¯†**ï¼šäº†è§£ LLM æ¨ç†åŸºæœ¬æµç¨‹ï¼ˆPrefill/Decodeï¼‰
>
> **v4 æ›´æ–°è¯´æ˜**ï¼š
> - ğŸ†š æ–°å¢ Mooncake vs Dynamo å¯¹æ¯”åˆ†æ
> - ğŸ¢ æ–°å¢å¤šé›†ç¾¤ã€è·¨äº‘å‚å•†ã€K8s ç¯å¢ƒä¸‹çš„å·¥ç¨‹è½åœ°æ–¹æ¡ˆ
> - ğŸ“Š ç»“åˆå®é™…ä¸šåŠ¡åœºæ™¯çš„ PD åˆ†ç¦» + KVCache éƒ¨ç½²æ¶æ„
> - ğŸ¯ ä¿æŒæŠ€æœ¯ä¸¥è°¨æ€§ï¼Œèšç„¦å·¥ç¨‹å®è·µ
>
> **ä¸ºä»€ä¹ˆå« Mooncakeï¼ˆæœˆé¥¼ï¼‰ï¼Ÿ**
>
> é¡¹ç›®åç§°æ¥æºäºç³»ç»Ÿçš„å±‚æ¬¡åŒ–è®¾è®¡ï¼š
> - **ä¼ è¾“å±‚** (RDMA)ï¼šå¿«é€Ÿä¼ è¾“çš„"å¤–çš®"
> - **å­˜å‚¨å±‚** (DRAM)ï¼šæ•°æ®å­˜å‚¨çš„"é¦…æ–™"
> - **å…ƒæ•°æ®å±‚** (Master Service)ï¼šåè°ƒç®¡ç†çš„"åŒ…è£…"
>
> æœ¬æ–‡å°†æŒ‰ç…§ç”±æµ…å…¥æ·±çš„é¡ºåºï¼Œé€å±‚å‰–æ Mooncake çš„è®¾è®¡ä¸å®ç°ï¼Œå¹¶æ·±å…¥æ¢è®¨å·¥ç¨‹è½åœ°æ–¹æ¡ˆã€‚

---

## ğŸ“‘ ç›®å½•

> å»ºè®®æŒ‰é¡ºåºé˜…è¯»ã€‚å¦‚æœå·²ç†Ÿæ‚‰åŸºç¡€æ¦‚å¿µï¼Œå¯è·³è¿‡ç¬¬ 0 éƒ¨åˆ†ç›´æ¥é˜…è¯»æ¶æ„è¯¦è§£ã€‚

### ç¬¬é›¶éƒ¨åˆ†ï¼šåŸºç¡€æ¦‚å¿µï¼ˆ5 åˆ†é’Ÿï¼‰
0. [æ ¸å¿ƒæ¦‚å¿µé€ŸæŸ¥è¡¨](#0-æ ¸å¿ƒæ¦‚å¿µé€ŸæŸ¥è¡¨)

### ç¬¬ä¸€éƒ¨åˆ†ï¼šèƒŒæ™¯ä¸é—®é¢˜ï¼ˆ5 åˆ†é’Ÿï¼‰
1. [ä¸ºä»€ä¹ˆéœ€è¦ Mooncakeï¼Ÿ](#1-ä¸ºä»€ä¹ˆéœ€è¦-mooncake)
2. [æ ¸å¿ƒé—®é¢˜åˆ†æ](#2-æ ¸å¿ƒé—®é¢˜åˆ†æ)

### ç¬¬äºŒéƒ¨åˆ†ï¼šMooncake æ¶æ„è¯¦è§£ï¼ˆ20 åˆ†é’Ÿï¼‰
3. [æ•´ä½“æ¶æ„æ¦‚è§ˆ](#3-æ•´ä½“æ¶æ„æ¦‚è§ˆ)
4. [Transfer Engineï¼šé«˜é€Ÿä¼ è¾“å±‚](#4-transfer-engineé«˜é€Ÿä¼ è¾“å±‚)
5. [Mooncake Storeï¼šåˆ†å¸ƒå¼å­˜å‚¨å±‚](#5-mooncake-storeåˆ†å¸ƒå¼å­˜å‚¨å±‚)

### ç¬¬ä¸‰éƒ¨åˆ†ï¼šå·¥ä½œåŸç†æ·±å…¥ï¼ˆ15 åˆ†é’Ÿï¼‰
6. [RDMA é›¶æ‹·è´æŠ€æœ¯](#6-rdma-é›¶æ‹·è´æŠ€æœ¯)
7. [å…ƒæ•°æ®ç®¡ç†ä¸é©±é€ç­–ç•¥](#7-å…ƒæ•°æ®ç®¡ç†ä¸é©±é€ç­–ç•¥)
8. [å®Œæ•´è¯·æ±‚æµç¨‹](#8-å®Œæ•´è¯·æ±‚æµç¨‹)

### ç¬¬å››éƒ¨åˆ†ï¼šå®æˆ˜è½åœ°ï¼ˆ20 åˆ†é’Ÿï¼‰
9. [éƒ¨ç½²æ¶æ„è®¾è®¡](#9-éƒ¨ç½²æ¶æ„è®¾è®¡)
10. [ä¸ vLLM + LMCache é›†æˆ](#10-ä¸-vllm--lmcache-é›†æˆ)
11. [æ€§èƒ½æµ‹è¯•ä¸è°ƒä¼˜](#11-æ€§èƒ½æµ‹è¯•ä¸è°ƒä¼˜)
12. **[Mooncake vs Dynamoï¼šæŠ€æœ¯å¯¹æ¯”](#12-mooncake-vs-dynamoæŠ€æœ¯å¯¹æ¯”)** â­ æ–°å¢
13. **[å¤šé›†ç¾¤è·¨äº‘ K8s ç¯å¢ƒä¸‹çš„å·¥ç¨‹è½åœ°](#13-å¤šé›†ç¾¤è·¨äº‘-k8s-ç¯å¢ƒä¸‹çš„å·¥ç¨‹è½åœ°)** â­ æ–°å¢

### ç¬¬äº”éƒ¨åˆ†ï¼šæ€»ç»“ä¸å±•æœ›ï¼ˆ5 åˆ†é’Ÿï¼‰
14. [é€‚ç”¨åœºæ™¯åˆ†æ](#14-é€‚ç”¨åœºæ™¯åˆ†æ)
15. [è¸©å‘ç»éªŒåˆ†äº«](#15-è¸©å‘ç»éªŒåˆ†äº«)
16. [åç»­ä¼˜åŒ–æ–¹å‘](#16-åç»­ä¼˜åŒ–æ–¹å‘)

---

## ç¬¬é›¶éƒ¨åˆ†ï¼šåŸºç¡€æ¦‚å¿µ

### 0. æ ¸å¿ƒæ¦‚å¿µé€ŸæŸ¥è¡¨

> åœ¨æ·±å…¥äº†è§£ Mooncake ä¹‹å‰ï¼Œå…ˆç†è§£ä»¥ä¸‹æ ¸å¿ƒæ¦‚å¿µã€‚è¿™äº›æœ¯è¯­ä¼šè´¯ç©¿å…¨æ–‡ï¼Œå»ºè®®å…ˆå¿«é€Ÿæµè§ˆä¸€éã€‚
>
> ğŸ’¡ **é˜…è¯»å»ºè®®**ï¼šå¦‚æœå·²ç†Ÿæ‚‰è¿™äº›æ¦‚å¿µï¼Œå¯ç›´æ¥è·³åˆ°ç¬¬ä¸€éƒ¨åˆ†ã€‚

#### 0.1 LLM æ¨ç†ç›¸å…³

| æœ¯è¯­ | è‹±æ–‡å…¨ç§° | è§£é‡Š | ç±»æ¯” |
|------|---------|------|------|
| **LLM** | Large Language Model | å¤§è¯­è¨€æ¨¡å‹ï¼Œå¦‚ GPTã€Qwen ç­‰ | è®­ç»ƒå¥½çš„ AI æ¨¡å‹ |
| **Inference** | Inference | æ¨ç†ï¼Œä½¿ç”¨è®­ç»ƒå¥½çš„æ¨¡å‹ç”Ÿæˆå›ç­” | æ¨¡å‹åœ¨å·¥ä½œçŠ¶æ€ |
| **Token** | Token | æ–‡æœ¬çš„æœ€å°å•ä½ï¼ˆé€šå¸¸ 1 token â‰ˆ 0.75 ä¸ªè‹±æ–‡å•è¯ï¼Œ1 ä¸ªä¸­æ–‡å­—ï¼‰ | å¥å­çš„åŸºæœ¬å•å…ƒ |
| **Prefill** | Prefill | é¢„å¡«å……é˜¶æ®µï¼Œå¤„ç†è¾“å…¥ promptï¼Œè®¡ç®— KV Cache | ç†è§£è¾“å…¥çš„é˜¶æ®µ |
| **Decode** | Decode | è§£ç é˜¶æ®µï¼Œé€ä¸ªç”Ÿæˆè¾“å‡º token | ç”Ÿæˆè¾“å‡ºçš„é˜¶æ®µ |
| **KV Cache** | Key-Value Cache | æ³¨æ„åŠ›æœºåˆ¶çš„ä¸­é—´ç»“æœç¼“å­˜ | è®¡ç®—è¿‡ç¨‹çš„"ç¬”è®°" |
| **Prompt** | Prompt | è¾“å…¥çš„é—®é¢˜æˆ–æŒ‡ä»¤ | ç”¨æˆ·çš„è¾“å…¥ |

**KV Cache è¯¦è§£ï¼šä¸ºä»€ä¹ˆéœ€è¦å®ƒï¼Ÿ**

```python
# åœºæ™¯ï¼šAI ç”Ÿæˆ "ä»Šå¤©å¤©æ°”å¾ˆå¥½"

ã€æ²¡æœ‰ KV Cacheã€‘
ç”Ÿæˆ "å¤©":
  - è®¡ç®— "ä»Šå¤©" ä¸ "å¤©" çš„æ³¨æ„åŠ› â†’ é‡æ–°è®¡ç®—
ç”Ÿæˆ "æ°”":
  - è®¡ç®— "ä»Šå¤©å¤©" ä¸ "æ°”" çš„æ³¨æ„åŠ› â†’ é‡æ–°è®¡ç®—
ç”Ÿæˆ "å¾ˆ":
  - è®¡ç®— "ä»Šå¤©å¤©æ°”" ä¸ "å¾ˆ" çš„æ³¨æ„åŠ› â†’ é‡æ–°è®¡ç®—
ç”Ÿæˆ "å¥½":
  - è®¡ç®— "ä»Šå¤©å¤©æ°”å¾ˆ" ä¸ "å¥½" çš„æ³¨æ„åŠ› â†’ é‡æ–°è®¡ç®—

æ—¶é—´å¤æ‚åº¦ï¼šO(nÂ²)ï¼Œæ¯ä¸ª token éƒ½è¦é‡æ–°è®¡ç®—æ‰€æœ‰å†å² token

ã€æœ‰ KV Cacheã€‘
Prefill é˜¶æ®µï¼š
  - "ä»Šå¤©" çš„ K, V â†’ ç¼“å­˜
  - "å¤©æ°”" çš„ K, V â†’ ç¼“å­˜

Decode é˜¶æ®µï¼š
  - ç”Ÿæˆ "å¾ˆ"ï¼šç›´æ¥è¯»å–ç¼“å­˜çš„ K, V â†’ O(1)
  - ç”Ÿæˆ "å¥½"ï¼šç›´æ¥è¯»å–ç¼“å­˜çš„ K, V â†’ O(1)

æ—¶é—´å¤æ‚åº¦ï¼šO(n)ï¼Œé¿å…é‡å¤è®¡ç®—

ğŸ’¡ æ€§èƒ½æå‡ï¼šO(nÂ²) â†’ O(n)
   ä»£ä»·ï¼šéœ€è¦å­˜å‚¨ç©ºé—´æ¥ä¿å­˜ KV Cache
```

#### 0.2 ç¡¬ä»¶ä¸ç½‘ç»œ

| æœ¯è¯­ | è‹±æ–‡å…¨ç§° | è§£é‡Š | æ€§èƒ½æŒ‡æ ‡ |
|------|---------|------|----------|
| **GPU** | Graphics Processing Unit | å›¾å½¢å¤„ç†å•å…ƒï¼Œç”¨äº AI è®¡ç®— | A100: 80GB æ˜¾å­˜ï¼Œ$15K |
| **DRAM** | Dynamic Random Access Memory | åŠ¨æ€éšæœºå­˜å–å†…å­˜ï¼ˆæœåŠ¡å™¨å†…å­˜ï¼‰ | 512GB = $2K |
| **RDMA** | Remote Direct Memory Access | è¿œç¨‹ç›´æ¥å†…å­˜è®¿é—®ï¼Œé›¶æ‹·è´ç½‘ç»œæŠ€æœ¯ | å»¶è¿Ÿ 1-2 usï¼Œå¸¦å®½ 200 Gbps |
| **NIC** | Network Interface Card | ç½‘å¡ | Mellanox CX-6 = 200 Gbps |
| **NUMA** | Non-Uniform Memory Access | éç»Ÿä¸€å†…å­˜è®¿é—®æ¶æ„ | å¤š CPU æœåŠ¡å™¨çš„å†…å­˜ç»„ç»‡æ–¹å¼ |
| **PCIe** | Peripheral Component Interconnect Express | é«˜é€Ÿä¸²è¡Œæ€»çº¿æ ‡å‡† | GPU/NIC è¿æ¥åˆ° CPU çš„é€šé“ |
| **NVMe** | Non-Volatile Memory Express | é«˜é€Ÿ SSD åè®® | è¯»å†™é€Ÿåº¦ 7 GB/s |

**RDMA è¯¦è§£**ï¼š
```
ä¼ ç»Ÿç½‘ç»œï¼ˆTCP/IPï¼‰ï¼š
åº”ç”¨ç¨‹åº â†’ æ‹·è´åˆ°å†…æ ¸ â†’ æ‹·è´åˆ°ç½‘å¡ â†’ å‘é€
          â†‘ CPU å‚ä¸    â†‘ CPU å‚ä¸

RDMAï¼š
åº”ç”¨ç¨‹åº â†’ ç›´æ¥å‘é€ï¼ˆç½‘å¡ DMAï¼‰
          â†‘ CPU ä¸å‚ä¸ï¼

ä¼˜åŠ¿ï¼š
- é›¶æ‹·è´ï¼ˆZero-Copyï¼‰ï¼šæ•°æ®ä¸ç»è¿‡ CPU
- é›¶ CPUï¼ˆZero-CPUï¼‰ï¼šCPU å¯ä»¥åšå…¶ä»–äº‹
- ä½å»¶è¿Ÿï¼š1-2 å¾®ç§’ vs 50-100 å¾®ç§’
- é«˜å¸¦å®½ï¼š200 Gbps (25 GB/s)
```

#### 0.3 Mooncake æ ¸å¿ƒæ¦‚å¿µ

| æœ¯è¯­ | è§£é‡Š | ä½œç”¨ |
|------|------|------|
| **Mooncake Store** | Mooncake å­˜å‚¨æœåŠ¡ï¼Œç®¡ç†åˆ†å¸ƒå¼ KV Cache | å…¨å±€ KV Cache å­˜å‚¨æ±  |
| **Master Service** | ä¸»æ§èŠ‚ç‚¹ï¼Œç®¡ç†å…ƒæ•°æ® | è®°å½•æ¯ä¸ª KV Cache å­˜åœ¨å“ªäº›èŠ‚ç‚¹ |
| **Storage Node** | å­˜å‚¨èŠ‚ç‚¹ï¼Œæä¾› DRAM å­˜å‚¨ | å®é™…å­˜å‚¨ KV Cache æ•°æ® |
| **Transfer Engine** | ä¼ è¾“å¼•æ“ï¼Œè´Ÿè´£ RDMA ä¼ è¾“ | åœ¨èŠ‚ç‚¹é—´é«˜é€Ÿä¼ è¾“æ•°æ® |
| **Replica** | å‰¯æœ¬ï¼ŒåŒä¸€ä»½æ•°æ®çš„æ‹·è´ | æé«˜å¯ç”¨æ€§å’Œè®¿é—®é€Ÿåº¦ |
| **Segment** | å†…å­˜æ®µï¼ŒStorage Node ä¸Šçš„å­˜å‚¨å•å…ƒ | ç±»ä¼¼"ç£ç›˜åˆ†åŒº" |
| **Lease** | ç§Ÿçº¦ï¼ŒKV Cache çš„ç”Ÿå­˜æ—¶é—´ | è¿‡æœŸè‡ªåŠ¨åˆ é™¤ï¼Œç±»ä¼¼"ä¸´æ—¶æ–‡ä»¶" |
| **Eviction** | é©±é€ï¼Œåˆ é™¤æ—§æ•°æ®è…¾å‡ºç©ºé—´ | ç±»ä¼¼ LRU ç¼“å­˜æ·˜æ±° |

**LMCache ç¼“å­˜å±‚çº§**ï¼š
```
LMCache ä¸‰å±‚ç¼“å­˜æ¶æ„ï¼š

L1: GPU æ˜¾å­˜ (æœ¬åœ°ï¼Œæœ€å¿«)
  - å®¹é‡: 40-80 GB
  - å»¶è¿Ÿ: å¾®ç§’çº§
  - ä½œç”¨: å½“å‰æ¨ç†ä»»åŠ¡çš„ KV Cache

L2: CPU å†…å­˜ (æœ¬åœ°ï¼Œå¿«)
  - å®¹é‡: 100-500 GB
  - å»¶è¿Ÿ: æ¯«ç§’çº§
  - ä½œç”¨: æœ€è¿‘ä½¿ç”¨çš„ KV Cache

L3: Mooncake (å…¨å±€ï¼Œå¤§)
  - å®¹é‡: TB çº§
  - å»¶è¿Ÿ: 0.4 ç§’ (RDMA)
  - ä½œç”¨: å…¨å±€å…±äº«çš„ KV Cache

æŸ¥æ‰¾é¡ºåº: L1 â†’ L2 â†’ L3
  - L1 å‘½ä¸­: 0 å»¶è¿Ÿï¼ˆæœ¬åœ° GPUï¼‰
  - L2 å‘½ä¸­: ~0.01sï¼ˆæœ¬åœ°å†…å­˜ï¼‰
  - L3 å‘½ä¸­: ~0.4sï¼ˆRDMA ä¼ è¾“ï¼‰
  - L3 æœªå‘½ä¸­: é‡æ–° Prefill (~10s)
```

#### 0.4 å…³é”®æ•°å€¼å‚è€ƒ

```
ã€æ—¶é—´ã€‘
- GPU Prefill 1000 tokens: ~1-10 ç§’ï¼ˆå–å†³äºæ¨¡å‹å¤§å°ï¼‰
- RDMA ä¼ è¾“ 10 GB: ~0.4 ç§’
- TCP ä¼ è¾“ 10 GB: ~8 ç§’
- æœ¬åœ°å†…å­˜è®¿é—®: å¾®ç§’çº§

ã€å®¹é‡ã€‘
- Qwen2.5-72B å•ä¸ªè¯·æ±‚ KV Cache (128K tokens): ~40 GB
- A100 GPU æ˜¾å­˜: 80 GB
- å…¸å‹æœåŠ¡å™¨å†…å­˜: 512 GB - 2 TB
- Mooncake é›†ç¾¤æ€»å®¹é‡: 10-100 TB

ã€å¸¦å®½ã€‘
- GPU HBM å¸¦å®½: 2 TB/s
- RDMA ç½‘ç»œ: 200 Gbps (25 GB/s)
- PCIe 4.0 x16: 32 GB/s
- ä¸‡å…†ä»¥å¤ªç½‘: 10 Gbps (1.25 GB/s)

ã€æˆæœ¬ï¼ˆå‚è€ƒä»·æ ¼ï¼‰ã€‘
- A100 80GB GPU: $15,000
- 512 GB DDR4 å†…å­˜: $2,000
- Mellanox CX-6 RDMA ç½‘å¡: $1,500
- äº‘ç«¯ A100 ç§Ÿèµ: $3.5/å°æ—¶
```

#### 0.5 å¸¸è§ç¼©å†™

| ç¼©å†™ | å…¨ç§° | ä¸­æ–‡ |
|------|------|------|
| **QPS** | Queries Per Second | æ¯ç§’æŸ¥è¯¢æ•° |
| **TPS** | Transactions Per Second | æ¯ç§’äº‹åŠ¡æ•° |
| **TTFT** | Time To First Token | é¦– Token æ—¶é—´ |
| **TPOT** | Time Per Output Token | æ¯è¾“å‡º Token æ—¶é—´ |
| **TP** | Tensor Parallel | å¼ é‡å¹¶è¡Œ |
| **PP** | Pipeline Parallel | æµæ°´çº¿å¹¶è¡Œ |
| **HA** | High Availability | é«˜å¯ç”¨ |
| **TTL** | Time To Live | ç”Ÿå­˜æ—¶é—´ |
| **RPC** | Remote Procedure Call | è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ |
| **etcd** | etcd | åˆ†å¸ƒå¼é”®å€¼å­˜å‚¨ï¼ˆå…ƒæ•°æ®å­˜å‚¨ï¼‰ |

---

## ğŸ¥— ç¬¬ä¸€éƒ¨åˆ†ï¼šèƒŒæ™¯ä¸é—®é¢˜

### 1. ä¸ºä»€ä¹ˆéœ€è¦ Mooncakeï¼Ÿ

> **æ ¸å¿ƒçŸ›ç›¾**ï¼šGPU æ˜¾å­˜æ˜‚è´µä¸”æœ‰é™ï¼ŒKV Cache å ç”¨å¤§é‡ç©ºé—´å´åªç”¨ä¸€æ¬¡å°±ä¸¢å¼ƒ
>
> Mooncake çš„æ ¸å¿ƒæ€æƒ³ï¼š**ç”¨å»‰ä»·çš„ DRAM å­˜å‚¨ KV Cacheï¼Œç”¨é«˜é€Ÿ RDMA ç½‘ç»œä¼ è¾“**
> - GPU æ˜¾å­˜ï¼š$15K / 80GB â‰ˆ $187.5 per GB
> - DRAM å†…å­˜ï¼š$2K / 512GB â‰ˆ $3.9 per GB
> - æˆæœ¬å·®å¼‚ï¼š**48 å€**

#### 1.1 LLM æ¨ç†çš„æ ¸å¿ƒé—®é¢˜

åœ¨ä¼ ç»Ÿçš„ LLM æ¨ç†æ¶æ„ä¸­ï¼Œæˆ‘ä»¬é¢ä¸´ä¸‰å¤§æ ¸å¿ƒé—®é¢˜ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ä¼ ç»Ÿ LLM æ¨ç†æ¶æ„                       â”‚
â”‚                                                          â”‚
â”‚  ç”¨æˆ·è¯·æ±‚ â†’ Prefillï¼ˆè®¡ç®— KV Cacheï¼‰â†’ Decode â†’ è¾“å‡º   â”‚
â”‚              â†“                                           â”‚
â”‚         ã€é—®é¢˜ 1ã€‘æ¯æ¬¡éƒ½è¦é‡æ–°è®¡ç®—                       â”‚
â”‚         ã€é—®é¢˜ 2ã€‘KV Cache å ç”¨å¤§é‡ GPU æ˜¾å­˜            â”‚
â”‚         ã€é—®é¢˜ 3ã€‘æ— æ³•è·¨è¯·æ±‚å¤ç”¨                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 1.2 å…·ä½“é—®é¢˜ç¤ºä¾‹

**åœºæ™¯ 1ï¼šé‡å¤è®¡ç®—çš„æµªè´¹**

```python
# ç”¨æˆ·ç¬¬ä¸€æ¬¡è¯·æ±‚
prompt_1 = "è¯·ç”¨ Python å®ç°å¿«é€Ÿæ’åºç®—æ³•"
# â†’ Prefill è€—æ—¶ 5 ç§’ï¼Œç”Ÿæˆ KV Cacheï¼ˆ10GBï¼‰

# ç”¨æˆ·ç¬¬äºŒæ¬¡è¯·æ±‚ï¼ˆè¿½é—®ï¼‰
prompt_2 = "è¯·ç”¨ Python å®ç°å¿«é€Ÿæ’åºç®—æ³•ï¼Œå¹¶åŠ ä¸Šè¯¦ç»†æ³¨é‡Š"
# â†’ åˆé‡æ–° Prefill ä¸€éï¼Œè€—æ—¶ 5 ç§’
# â†’ ä½†å‰é¢çš„ prompt_1 éƒ¨åˆ†æ˜æ˜å·²ç»è®¡ç®—è¿‡äº†ï¼
```

**é—®é¢˜åˆ†æ**ï¼š
- âŒ GPU é‡å¤è®¡ç®—ç›¸åŒå†…å®¹
- âŒ ç¬¬äºŒæ¬¡è¯·æ±‚çš„å‰ç¼€éƒ¨åˆ†ï¼ˆprompt_1ï¼‰å®Œå…¨æµªè´¹

**åœºæ™¯ 2ï¼šGPU æ˜¾å­˜ä¸è¶³**

```python
# Qwen2.5-72B æ¨¡å‹
model_params = {
    "num_layers": 80,
    "hidden_size": 8192,
    "num_heads": 64
}

# å•ä¸ªè¯·æ±‚çš„ KV Cache å¤§å°ï¼ˆ128K tokensï¼‰
seq_len = 128000
kv_cache_size = (
    seq_len *           # åºåˆ—é•¿åº¦
    80 *                # å±‚æ•°
    8192 *              # éšè—å±‚ç»´åº¦
    2 *                 # K å’Œ V
    2 / (1024**3)       # float16 = 2 bytesï¼Œè½¬ GB
)
# çº¦ 40 GBï¼

# A100 80GB GPU
gpu_memory = 80  # GB
available_for_kv = 40  # GBï¼ˆå‰©ä½™ç»™æ¨¡å‹æƒé‡ã€æ¿€æ´»å€¼ç­‰ï¼‰

max_concurrent_requests = available_for_kv / kv_cache_size
# = 40 / 40 = 1 ä¸ªè¯·æ±‚ï¼
```

**é—®é¢˜åˆ†æ**ï¼š
- âŒ å•ä¸ªé•¿æ–‡æœ¬è¯·æ±‚å°±å æ»¡ GPU æ˜¾å­˜
- âŒ æ— æ³•æ”¯æŒå¹¶å‘
- âŒ GPU åˆ©ç”¨ç‡æä½

**åœºæ™¯ 3ï¼šå¤šè½®å¯¹è¯çš„é‡å¤ Prefill**

```python
# 10 è½®å¯¹è¯
conversation = []
for turn in range(10):
    # å†å²å¯¹è¯è¶Šæ¥è¶Šé•¿
    prompt = format_conversation(conversation)  # ç¬¬ 1 è½®ï¼š100 tokens
                                                # ç¬¬ 2 è½®ï¼š300 tokens
                                                # ç¬¬ 10 è½®ï¼š5000 tokens

    # æ¯è½®éƒ½è¦ Prefill å…¨éƒ¨å†å²ï¼
    kv_cache = prefill(prompt)  # ç¬¬ 10 è½®è¦ Prefill 5000 tokens
    response = decode(kv_cache)

    conversation.append(response)
```

**é—®é¢˜åˆ†æ**ï¼š
- âŒ ç¬¬ 10 è½®éœ€è¦ Prefill 5000 tokens
- âŒ ä½†å†å²çš„ 4900 tokens éƒ½å·²ç»è®¡ç®—è¿‡
- âŒ åªæœ‰æ–°å¢çš„ 100 tokens æ˜¯éœ€è¦çš„

---

### 2. æ ¸å¿ƒé—®é¢˜åˆ†æ

#### 2.1 é—®é¢˜æœ¬è´¨

ä¼ ç»Ÿæ¶æ„çš„æ ¸å¿ƒé—®é¢˜æ˜¯ï¼š**KV Cache çš„ç”Ÿå‘½å‘¨æœŸä»…é™äºå•æ¬¡è¯·æ±‚**

```
ä¼ ç»Ÿæ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¯·æ±‚ 1    â”‚    â”‚ è¯·æ±‚ 2    â”‚    â”‚ è¯·æ±‚ 3    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚Prefillâ”‚ â”‚    â”‚ â”‚Prefillâ”‚ â”‚    â”‚ â”‚Prefillâ”‚ â”‚
â”‚ â”‚ç”ŸæˆKV â”‚ â”‚    â”‚ â”‚ç”ŸæˆKV â”‚ â”‚    â”‚ â”‚ç”ŸæˆKV â”‚ â”‚
â”‚ â””â”€â”€â”¬â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”¬â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”¬â”€â”€â”€â”˜ â”‚
â”‚    â”‚ä¸¢å¼ƒ  â”‚    â”‚    â”‚ä¸¢å¼ƒ  â”‚    â”‚    â”‚ä¸¢å¼ƒ  â”‚
â”‚    â†“      â”‚    â”‚    â†“      â”‚    â”‚    â†“      â”‚
â”‚   ğŸ—‘ï¸     â”‚    â”‚   ğŸ—‘ï¸     â”‚    â”‚   ğŸ—‘ï¸     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é—®é¢˜ï¼š
1. å³ä½¿æ˜¯ç›¸åŒçš„ promptï¼Œæ¯æ¬¡éƒ½è¦é‡æ–°è®¡ç®—
2. KV Cache æ— æ³•è·¨è¯·æ±‚å¤ç”¨
3. GPU åšäº†å¤§é‡é‡å¤åŠ³åŠ¨
```

#### 2.2 ç†æƒ³æ–¹æ¡ˆ

æˆ‘ä»¬éœ€è¦ä¸€ä¸ª**å…¨å±€çš„ KV Cache ç®¡ç†ç³»ç»Ÿ**ï¼š

```
ç†æƒ³æ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¯·æ±‚ 1    â”‚    â”‚ è¯·æ±‚ 2    â”‚    â”‚ è¯·æ±‚ 3    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚Prefillâ”‚ â”‚    â”‚ â”‚Lookup â”‚ â”‚    â”‚ â”‚Lookup â”‚ â”‚
â”‚ â”‚ç”ŸæˆKV â”‚ â”‚    â”‚ â”‚å‘½ä¸­ï¼ â”‚ â”‚    â”‚ â”‚å‘½ä¸­ï¼ â”‚ â”‚
â”‚ â””â”€â”€â”¬â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”¬â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”¬â”€â”€â”€â”˜ â”‚
â”‚    â”‚      â”‚    â”‚    â”‚      â”‚    â”‚    â”‚      â”‚
â”‚    â†“å­˜å‚¨  â”‚    â”‚    â†“å¤ç”¨  â”‚    â”‚    â†“å¤ç”¨  â”‚
â””â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”˜
     â”‚                â”‚                â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   å…¨å±€ KV Cache    â”‚
            â”‚   å…±äº«å­˜å‚¨æ±        â”‚
            â”‚   (Mooncake Store) â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜åŠ¿ï¼š
âœ… KV Cache å…¨å±€å…±äº«
âœ… å‰ç¼€åŒ¹é…è‡ªåŠ¨å¤ç”¨
âœ… GPU ä¸å†é‡å¤è®¡ç®—
```

#### 2.3 æŠ€æœ¯æŒ‘æˆ˜

è¦å®ç°è¿™ä¸ªç†æƒ³æ–¹æ¡ˆï¼Œéœ€è¦è§£å†³ä»¥ä¸‹æŠ€æœ¯é—®é¢˜ï¼š

| æŒ‘æˆ˜ | éš¾ç‚¹ | Mooncake æ–¹æ¡ˆ |
|------|------|--------------|
| **å­˜å‚¨å®¹é‡** | GPU æ˜¾å­˜åªæœ‰ 80GB | ç”¨ DRAMï¼ˆTB çº§ï¼‰å­˜å‚¨ |
| **ä¼ è¾“é€Ÿåº¦** | ç½‘ç»œæ…¢ï¼ˆ1 Gbps = 0.125 GB/sï¼‰ | RDMA é›¶æ‹·è´ï¼ˆ200 Gbps = 25 GB/sï¼‰ |
| **æŸ¥æ‰¾æ•ˆç‡** | æµ·é‡ KV Cache å¦‚ä½•å¿«é€Ÿå®šä½ï¼Ÿ | å“ˆå¸Œç´¢å¼• + åˆ†ç‰‡å…ƒæ•°æ® |
| **å¹¶å‘ç®¡ç†** | 1000+ èŠ‚ç‚¹åŒæ—¶è¯»å†™æ€ä¹ˆåŠï¼Ÿ | åˆ†å¸ƒå¼å…ƒæ•°æ® + Lease æœºåˆ¶ |
| **æ•…éšœå®¹é”™** | å­˜å‚¨èŠ‚ç‚¹æŒ‚äº†æ€ä¹ˆåŠï¼Ÿ | å¤šå‰¯æœ¬ + è‡ªåŠ¨æ•…éšœè½¬ç§» |

#### 2.4 Mooncake çš„è§£å†³æ€è·¯

**æ ¸å¿ƒè®¾è®¡ç†å¿µ: ç‰ºç‰²å†…å­˜æ¢å–è®¡ç®—æ•ˆç‡**

```
ä¼ ç»Ÿæ¶æ„çš„é—®é¢˜:
âŒ GPU æ˜¾å­˜æ˜‚è´µä¸”æœ‰é™ (A100 80GB = $15K)
âŒ KV Cache ç”¨å®Œå³ä¸¢å¼ƒ (æµªè´¹è®¡ç®—èµ„æº)
âŒ é‡å¤è®¡ç®—å¯¼è‡´ GPU åˆ©ç”¨ç‡ä½ (< 30%)

Mooncake çš„æƒè¡¡:
âœ… ç”¨å»‰ä»·çš„ DRAM (512GB = $2K) å­˜å‚¨ KV Cache
âœ… ç”¨ RDMA é«˜é€Ÿç½‘ç»œ (200 Gbps) ä¼ è¾“æ•°æ®
âœ… ç‰ºç‰²å°‘é‡ç½‘ç»œå»¶è¿Ÿ (0.4s) æ¢å–å¤§å¹…è®¡ç®—èŠ‚çœ (10s â†’ 1s)

ROI: 1 TB DRAM ($4K) å¯èŠ‚çœ 10+ å¼  GPU ($150K+)
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Mooncake æ¶æ„                        â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ Prefill é›†ç¾¤ â”‚     â”‚ Decode é›†ç¾¤  â”‚                 â”‚
â”‚  â”‚  (è®¡ç®—å¯†é›†)  â”‚     â”‚  (å»¶è¿Ÿæ•æ„Ÿ)  â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚         â”‚ å­˜å‚¨ KV            â”‚ å–ç”¨ KV                  â”‚
â”‚         â”‚                    â”‚                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚      Mooncake Store               â”‚                 â”‚
â”‚  â”‚  ã€ç‰ºç‰²å†…å­˜ã€‘                      â”‚                 â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                 â”‚
â”‚  â”‚  â”‚  Master Service (å…ƒæ•°æ®)    â”‚  â”‚                 â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                 â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                 â”‚
â”‚  â”‚  â”‚  Storage Nodes (DRAM æ± )    â”‚  â”‚                 â”‚
â”‚  â”‚  â”‚  Node1: 512GB  ğŸ’° æˆæœ¬      â”‚  â”‚                 â”‚
â”‚  â”‚  â”‚  Node2: 512GB  ğŸ’° æˆæœ¬      â”‚  â”‚                 â”‚
â”‚  â”‚  â”‚  Node3: 512GB  ğŸ’° æˆæœ¬      â”‚  â”‚                 â”‚
â”‚  â”‚  â”‚  æ€»å†…å­˜: 1.5 TB = $6K       â”‚  â”‚                 â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚         â†•                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚   Transfer Engine (RDMA)         â”‚                  â”‚
â”‚  â”‚   ã€æ¢å–æ•ˆç‡ã€‘                   â”‚                  â”‚
â”‚  â”‚   - é›¶æ‹·è´ä¼ è¾“ (25 GB/s)        â”‚                  â”‚
â”‚  â”‚   - GPU é‡å¤è®¡ç®—é™ä½ 80%         â”‚                  â”‚
â”‚  â”‚   - ååé‡æå‡ 5-10x             â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ ¸å¿ƒç†å¿µï¼š
1. **å†…å­˜æ¢æ•ˆç‡** â†’ ç”¨ DRAM ä»£æ›¿é‡å¤è®¡ç®—
2. Prefill-Decode è§£è€¦ â†’ å„è‡ªä¼˜åŒ–
3. KV Cache é›†ä¸­å­˜å‚¨ â†’ å…¨å±€å¤ç”¨
4. RDMA é«˜é€Ÿä¼ è¾“ â†’ æ¥è¿‘æœ¬åœ°è®¿é—®
5. æ™ºèƒ½å…ƒæ•°æ®ç®¡ç† â†’ é«˜æ•ˆæŸ¥æ‰¾ä¸é©±é€

æˆæœ¬æ”¶ç›Š:
- å¢åŠ æˆæœ¬: 1.5 TB DRAM = $6K
- èŠ‚çœæˆæœ¬: å‡å°‘ 15 å¼  A100 GPU = $225K
- ROI: 3750% (ä¸€æ¬¡æ€§æŠ•å…¥å›æœ¬)
```

#### 2.5 KV Cache å‘½ä¸­é€»è¾‘è¯¦è§£

Mooncake çš„æ ¸å¿ƒä»·å€¼åœ¨äº **KV Cache çš„å¤ç”¨**ï¼Œä¸‹é¢è¯¦ç»†è§£é‡Šå‘½ä¸­é€»è¾‘ï¼š

**å‰ç¼€åŒ¹é…åŸç†**

```python
# ç¤ºä¾‹ï¼šå¤šè½®å¯¹è¯åœºæ™¯
conversation_history = [
    "ç”¨æˆ·: ä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½ï¼Ÿ",
    "AI: äººå·¥æ™ºèƒ½æ˜¯...ï¼ˆ300 tokensï¼‰",
    "ç”¨æˆ·: å®ƒæœ‰å“ªäº›åº”ç”¨ï¼Ÿ",
    "AI: ä¸»è¦åº”ç”¨åŒ…æ‹¬...ï¼ˆ400 tokensï¼‰",
]

# ç¬¬ 5 è½®å¯¹è¯
new_user_input = "ç”¨æˆ·: å…·ä½“è¯´è¯´åœ¨åŒ»ç–—é¢†åŸŸçš„åº”ç”¨"

# æ„å»ºå®Œæ•´ prompt
full_prompt = "\n".join(conversation_history) + "\n" + new_user_input
# æ€»é•¿åº¦: 1500 tokens (å†å² 1400 + æ–°è¾“å…¥ 100)

# ========== ä¼ ç»Ÿæ–¹å¼ ==========
# âŒ éœ€è¦ Prefill å…¨éƒ¨ 1500 tokens
prefill_time_traditional = 1500 * 0.01  # å‡è®¾æ¯ token 10ms
# = 15 ç§’

# ========== Mooncake æ–¹å¼ ==========
# 1. è®¡ç®— prompt çš„å“ˆå¸Œ/å‰ç¼€é”®
history_key = hash(conversation_history)  # å‰ 1400 tokens çš„é”®

# 2. æŸ¥è¯¢ Mooncake Store
kv_cache_result = mooncake_store.lookup(history_key)

if kv_cache_result.hit:
    # âœ… å‘½ä¸­ï¼åªéœ€è¦ Prefill æ–°å¢çš„ 100 tokens
    cached_kv = kv_cache_result.data  # è¿œç¨‹æ‹‰å– KV Cache (RDMA ä¼ è¾“)
    new_kv = prefill(new_user_input)  # åªè®¡ç®—æ–°å¢éƒ¨åˆ†

    full_kv = concat(cached_kv, new_kv)

    prefill_time_mooncake = 100 * 0.01  # åªéœ€è®¡ç®— 100 tokens
    # = 1 ç§’

    # ä¼ è¾“æ—¶é—´ (RDMA)
    kv_size = 10 GB  # å‡è®¾å†å² KV Cache å¤§å°
    rdma_bandwidth = 25 GB/s  # 200 Gbps RDMA
    transfer_time = 10 / 25  # = 0.4 ç§’

    total_time = 1 + 0.4  # = 1.4 ç§’

    # åŠ é€Ÿæ¯”: 15 / 1.4 = 10.7x
```

**å‘½ä¸­åˆ¤æ–­æµç¨‹**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               KV Cache æŸ¥æ‰¾æµç¨‹                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. Prompt åˆ°è¾¾
   â†“
   "è¯·ç”¨ Python å®ç°å¿«é€Ÿæ’åºï¼Œå¹¶åŠ ä¸Šè¯¦ç»†æ³¨é‡Š"

2. åˆ†è¯ Tokenization
   â†“
   [101, 1234, 5678, ..., 9012]  # Token IDs

3. å‰ç¼€åˆ‡åˆ†
   â†“
   å°è¯•ä¸åŒçš„å‰ç¼€é•¿åº¦è¿›è¡ŒåŒ¹é…ï¼š
   - å…¨é‡åŒ¹é…: tokens[0:100]   â†’ Key: "hash_100"
   - 90% åŒ¹é…:  tokens[0:90]    â†’ Key: "hash_90"
   - 80% åŒ¹é…:  tokens[0:80]    â†’ Key: "hash_80"

4. æŸ¥è¯¢ Mooncake Store
   â†“
   GET(Key="hash_90")

5. å‘½ä¸­åˆ¤æ–­
   â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ å‘½ä¸­ (Hit)   â”‚  â†’ æ‹‰å– KV Cache + Prefill å‰©ä½™ 10%
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         OR
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ æœªå‘½ä¸­ (Miss)â”‚  â†’ å®Œæ•´ Prefill 100% + å­˜å‚¨åˆ° Store
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

6. KV Cache åˆå¹¶
   â†“
   Cached_KV[0:90] + New_KV[90:100] = Full_KV[0:100]

7. Decode ç”Ÿæˆ
   â†“
   ä½¿ç”¨ Full_KV ç”Ÿæˆå›å¤
```

**å®é™…ä»£ç ç¤ºä¾‹ï¼ˆåŸºäº LMCache é›†æˆï¼‰**

```python
# LMCache é…ç½® - ä¸‰å±‚ç¼“å­˜æ¶æ„
from lmcache import LMCacheEngine

config = {
    "chunk_size": 256,  # æ¯ä¸ª chunk çš„ token æ•°
    "enable_prefix_caching": True,

    # L1: æœ¬åœ° GPU å†…å­˜ï¼ˆæœ€å¿«ï¼‰
    "local_device": "cuda",
    "local_size": "40GB",

    # L2: æœ¬åœ° CPU å†…å­˜
    "cpu_cache_size": "100GB",

    # L3: Mooncake è¿œç¨‹å­˜å‚¨ï¼ˆæœ€å¤§ï¼‰
    "remote_backend": "mooncake",
    "mooncake_config": {
        "metadata_server": "etcd://10.0.0.1:2379",
        "local_server_name": "worker-1",
    }
}

cache_engine = LMCacheEngine(config)

# æ¨ç†æ—¶è‡ªåŠ¨ä½¿ç”¨ KV Cache
def inference_with_cache(prompt, model):
    # 1. LMCache è‡ªåŠ¨æŸ¥æ‰¾å‰ç¼€åŒ¹é…
    #    - å…ˆæŸ¥ L1 (GPU)
    #    - å†æŸ¥ L2 (CPU)
    #    - æœ€åæŸ¥ L3 (Mooncake)

    # 2. è·å–ç¼“å­˜çš„ KV
    cached_tokens, kv_cache = cache_engine.get(prompt)

    print(f"ç¼“å­˜å‘½ä¸­: {cached_tokens} tokens")
    print(f"éœ€è¦è®¡ç®—: {len(prompt) - cached_tokens} tokens")

    # 3. åª Prefill æœªç¼“å­˜çš„éƒ¨åˆ†
    if cached_tokens > 0:
        remaining_prompt = prompt[cached_tokens:]
        new_kv = model.prefill(remaining_prompt, past_kv=kv_cache)
        full_kv = kv_cache + new_kv
    else:
        full_kv = model.prefill(prompt)

    # 4. Decode ç”Ÿæˆ
    output = model.decode(full_kv)

    # 5. å°†æ–°çš„ KV Cache å­˜å‚¨åˆ° Mooncake
    cache_engine.put(prompt, full_kv)

    return output
```

**å…³é”®ä¼˜åŒ–ç‚¹**

| ä¼˜åŒ–ç»´åº¦ | ä¼ ç»Ÿæ–¹å¼ | Mooncake æ–¹å¼ | æå‡ |
|---------|---------|--------------|------|
| **é‡å¤è®¡ç®—** | æ¯æ¬¡éƒ½ Prefill | å‰ç¼€å‘½ä¸­ï¼Œåªè®¡ç®—æ–°å¢ | 10-100x |
| **æ˜¾å­˜å ç”¨** | æ¯è¯·æ±‚ç‹¬å  | è¿œç¨‹å­˜å‚¨ï¼ŒæŒ‰éœ€æ‹‰å– | èŠ‚çœ 80% |
| **å¹¶å‘èƒ½åŠ›** | å—é™äºæ˜¾å­˜ | è§£è€¦å­˜å‚¨ä¸è®¡ç®— | æå‡ 5-10x |
| **å¤šè½®å¯¹è¯** | ç´¯ç§¯é‡ç®— | å¢é‡è®¡ç®— | éšè½®æ¬¡çº¿æ€§æ”¹å–„ |

**å‘½ä¸­ç‡ç»Ÿè®¡ç¤ºä¾‹**

```python
# å®é™…ç”Ÿäº§ç¯å¢ƒæ•°æ®
åœºæ™¯ 1: å®¢æœæœºå™¨äººï¼ˆé«˜é‡å¤æ€§ï¼‰
â”œâ”€ å¹³å‡å‘½ä¸­ç‡: 87%
â”œâ”€ å¹³å‡å‘½ä¸­é•¿åº¦: 1200 tokens
â””â”€ Prefill æ—¶é—´é™ä½: 85%

åœºæ™¯ 2: RAG é—®ç­”ï¼ˆä¸­ç­‰é‡å¤æ€§ï¼‰
â”œâ”€ å¹³å‡å‘½ä¸­ç‡: 65%
â”œâ”€ å¹³å‡å‘½ä¸­é•¿åº¦: 800 tokens
â””â”€ Prefill æ—¶é—´é™ä½: 60%

åœºæ™¯ 3: ä»£ç è¡¥å…¨ï¼ˆä½é‡å¤æ€§ï¼‰
â”œâ”€ å¹³å‡å‘½ä¸­ç‡: 40%
â”œâ”€ å¹³å‡å‘½ä¸­é•¿åº¦: 400 tokens
â””â”€ Prefill æ—¶é—´é™ä½: 35%

ç»“è®º: å³ä½¿åœ¨ä½é‡å¤æ€§åœºæ™¯ä¸‹ï¼Œä»æœ‰ 35% çš„æ€§èƒ½æå‡ï¼
```

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šMooncake æ¶æ„è¯¦è§£

### 3. æ•´ä½“æ¶æ„æ¦‚è§ˆ

#### 3.1 ä¸‰å±‚æ¶æ„è®¾è®¡

Mooncake é‡‡ç”¨ç»å…¸çš„**ä¸‰å±‚æ¶æ„**ï¼šåº”ç”¨å±‚ã€ä¼ è¾“å±‚ã€å­˜å‚¨å±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        åº”ç”¨å±‚ï¼ˆApplication Layerï¼‰               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   vLLM       â”‚  â”‚   LMCache    â”‚  â”‚  Custom App  â”‚          â”‚
â”‚  â”‚   (æ¨ç†å¼•æ“) â”‚  â”‚  (ç¼“å­˜ä¸­é—´å±‚)â”‚  â”‚  (ç”¨æˆ·åº”ç”¨)  â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚         â”‚                  â”‚                  â”‚                   â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                            â”‚                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ API è°ƒç”¨
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¼ è¾“å±‚ï¼ˆTransfer Engineï¼‰                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚               MultiTransportï¼ˆå¤šåè®®æ”¯æŒï¼‰               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚   â”‚
â”‚  â”‚  â”‚RDMA        â”‚  â”‚TCP Socket  â”‚  â”‚NVMe-oF     â”‚         â”‚   â”‚
â”‚  â”‚  â”‚Transport   â”‚  â”‚Transport   â”‚  â”‚Transport   â”‚         â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â”‚   â”‚
â”‚  â”‚        â”‚               â”‚               â”‚                 â”‚   â”‚
â”‚  â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚   â”‚
â”‚  â”‚                        â”‚                                 â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚   â”‚
â”‚  â”‚  â”‚         Topology-Aware Routing              â”‚         â”‚   â”‚
â”‚  â”‚  â”‚  - NUMA æ„ŸçŸ¥                                â”‚         â”‚   â”‚
â”‚  â”‚  â”‚  - PCIe æ‹“æ‰‘ä¼˜åŒ–                            â”‚         â”‚   â”‚
â”‚  â”‚  â”‚  - å¤šç½‘å¡èšåˆ                              â”‚         â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚          TransferMetadataï¼ˆå…ƒæ•°æ®ç®¡ç†ï¼‰                  â”‚   â”‚
â”‚  â”‚  - æ®µæ³¨å†Œä¸å‘ç°                                          â”‚   â”‚
â”‚  â”‚  - è¿œç¨‹å†…å­˜åœ°å€è§£æ                                      â”‚   â”‚
â”‚  â”‚  - è¿æ¥ç®¡ç†                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ RDMA/TCP ä¼ è¾“
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  å­˜å‚¨å±‚ï¼ˆMooncake Storeï¼‰                        â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚            Master Serviceï¼ˆä¸»èŠ‚ç‚¹ï¼‰                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  å…ƒæ•°æ®ç®¡ç†ï¼ˆåˆ†ç‰‡å“ˆå¸Œï¼Œ1024 shardsï¼‰              â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  - Object Metadata: Key â†’ Replica List           â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  - Segment Management: èŠ‚ç‚¹èµ„æºç®¡ç†               â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  - Lease Mechanism: TTL è¿‡æœŸæ§åˆ¶                  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  - Eviction Strategy: Near-LRU é©±é€               â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  æŒä¹…åŒ–æ”¯æŒï¼ˆå¯é€‰ï¼‰ï¼š                                     â”‚   â”‚
â”‚  â”‚  - etcd: å…ƒæ•°æ®æŒä¹…åŒ–                                    â”‚   â”‚
â”‚  â”‚  - ç£ç›˜å‰¯æœ¬: å†…å­˜æ•°æ®è½ç›˜                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â†•                                     â”‚
â”‚                    RPC é€šä¿¡ï¼ˆMaster â†” Workerï¼‰                   â”‚
â”‚                            â†•                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚          Storage Nodesï¼ˆå­˜å‚¨å·¥ä½œèŠ‚ç‚¹ï¼‰                   â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  Node 1:              Node 2:              Node 3:       â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ DRAM Pool    â”‚    â”‚ DRAM Pool    â”‚    â”‚ DRAM Poolâ”‚   â”‚   â”‚
â”‚  â”‚  â”‚ (512GB)      â”‚    â”‚ (512GB)      â”‚    â”‚ (512GB)  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚              â”‚    â”‚              â”‚    â”‚          â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ Segment 1    â”‚    â”‚ Segment 2    â”‚    â”‚ Segment 3â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ Segment 2    â”‚    â”‚ Segment 3    â”‚    â”‚ Segment 1â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ (å‰¯æœ¬)       â”‚    â”‚ (å‰¯æœ¬)       â”‚    â”‚ (å‰¯æœ¬)   â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  å¯é€‰ç£ç›˜å‰¯æœ¬ï¼š                                           â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ Disk Storage â”‚    â”‚ Disk Storage â”‚    â”‚ Disk ...  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ (NVMe SSD)   â”‚    â”‚ (NVMe SSD)   â”‚    â”‚          â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.2 æ ¸å¿ƒç»„ä»¶äº¤äº’æµç¨‹

ä¸‹é¢é€šè¿‡ä¸€ä¸ªå®Œæ•´çš„ **PUT-GET** æµç¨‹ï¼Œå±•ç¤ºå„ç»„ä»¶å¦‚ä½•åä½œï¼š

```
åœºæ™¯ï¼šPrefill å®Œæˆåï¼Œå­˜å‚¨ KV Cache åˆ° Mooncakeï¼Œç„¶å Decode æ—¶å–å›

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. PUT Start â”‚  vLLM/LMCache è°ƒç”¨
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Master Service                                             â”‚
â”‚                                                            â”‚
â”‚  PutStart(key="prompt_hash_123", size=10GB, replicas=2)   â”‚
â”‚      â†“                                                     â”‚
â”‚  [æ£€æŸ¥ç©ºé—´] æ˜¯å¦æœ‰è¶³å¤Ÿçš„å­˜å‚¨ç©ºé—´ï¼Ÿ                          â”‚
â”‚      â†“ YES                                                 â”‚
â”‚  [åˆ†é…å‰¯æœ¬] AllocationStrategy é€‰æ‹©å­˜å‚¨èŠ‚ç‚¹ï¼š               â”‚
â”‚      - Replica 1 â†’ Node A (Segment A, offset 0-10GB)      â”‚
â”‚      - Replica 2 â†’ Node B (Segment B, offset 0-10GB)      â”‚
â”‚      â†“                                                     â”‚
â”‚  [åˆ›å»ºå…ƒæ•°æ®] ObjectMetadata {                             â”‚
â”‚      key: "prompt_hash_123",                              â”‚
â”‚      replicas: [                                           â”‚
â”‚          {node: A, segment: SegA, offset: 0, size: 10GB, â”‚
â”‚           status: WRITING},                               â”‚
â”‚          {node: B, segment: SegB, offset: 0, size: 10GB, â”‚
â”‚           status: WRITING}                                â”‚
â”‚      ],                                                    â”‚
â”‚      lease_timeout: now() + 60s                           â”‚
â”‚  }                                                         â”‚
â”‚      â†“                                                     â”‚
â”‚  è¿”å› Replica åˆ—è¡¨ç»™å®¢æˆ·ç«¯                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Data Transfer  (Transfer Engine)                     â”‚
â”‚                                                          â”‚
â”‚  å®¢æˆ·ç«¯æ”¶åˆ° Replica åˆ—è¡¨åï¼Œå¼€å§‹ä¼ è¾“æ•°æ®ï¼š                â”‚
â”‚                                                          â”‚
â”‚  TransferEngine.submitTransfer({                         â”‚
â”‚      targets: [                                          â”‚
â”‚          {remote_node: A, remote_addr: 0x7fff...,       â”‚
â”‚           local_addr: 0x7f00..., size: 10GB},           â”‚
â”‚          {remote_node: B, remote_addr: 0x7eee...,       â”‚
â”‚           local_addr: 0x7f00..., size: 10GB}            â”‚
â”‚      ]                                                   â”‚
â”‚  })                                                      â”‚
â”‚      â†“                                                   â”‚
â”‚  [åè®®é€‰æ‹©] MultiTransport æ ¹æ®æ‹“æ‰‘é€‰æ‹©ï¼š                 â”‚
â”‚      - Node A: åŒ NUMA â†’ ä½¿ç”¨ RDMA NIC 0                â”‚
â”‚      - Node B: è·¨ NUMA â†’ ä½¿ç”¨ RDMA NIC 1                â”‚
â”‚      â†“                                                   â”‚
â”‚  [RDMA ä¼ è¾“] GPU â†’ Node A/B DRAM                        â”‚
â”‚      - GPUDirect RDMAï¼ˆé›¶æ‹·è´ï¼‰                          â”‚
â”‚      - å¸¦å®½: 25 GB/s                                     â”‚
â”‚      - è€—æ—¶: 10GB Ã· 25GB/s = 0.4 ç§’                     â”‚
â”‚      â†“                                                   â”‚
â”‚  ä¼ è¾“å®Œæˆ                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. PUT End  (å®Œæˆå†™å…¥)                                   â”‚
â”‚                                                          â”‚
â”‚  Master Service                                          â”‚
â”‚      PutEnd(key="prompt_hash_123")                       â”‚
â”‚      â†“                                                   â”‚
â”‚  [æ›´æ–°çŠ¶æ€] å°† Replica çŠ¶æ€ä» WRITING â†’ COMPLETE        â”‚
â”‚      ObjectMetadata.replicas[0].status = COMPLETE       â”‚
â”‚      ObjectMetadata.replicas[1].status = COMPLETE       â”‚
â”‚      â†“                                                   â”‚
â”‚  [æˆäºˆç§Ÿçº¦] GrantLease(ttl=60s)                          â”‚
â”‚      lease_timeout = now() + 60s                         â”‚
â”‚                                                          â”‚
â”‚  âœ… KV Cache å­˜å‚¨å®Œæˆï¼Œå¯ä¾›è¯»å–ï¼                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. GET (Decode æ—¶è¯»å–)                                   â”‚
â”‚                                                          â”‚
â”‚  å®¢æˆ·ç«¯æŸ¥è¯¢ KV Cacheï¼š                                   â”‚
â”‚      GetReplicaList(key="prompt_hash_123")               â”‚
â”‚      â†“                                                   â”‚
â”‚  Master Service è¿”å›ï¼š                                   â”‚
â”‚      {                                                   â”‚
â”‚          replicas: [                                     â”‚
â”‚              {node: A, addr: 0x7fff..., size: 10GB},    â”‚
â”‚              {node: B, addr: 0x7eee..., size: 10GB}     â”‚
â”‚          ],                                              â”‚
â”‚          lease_ttl: 45s  (å‰©ä½™æ—¶é—´)                      â”‚
â”‚      }                                                   â”‚
â”‚      â†“                                                   â”‚
â”‚  å®¢æˆ·ç«¯é€‰æ‹©æœ€è¿‘çš„å‰¯æœ¬ï¼ˆNode Aï¼‰                          â”‚
â”‚      â†“                                                   â”‚
â”‚  TransferEngine ä» Node A æ‹‰å–æ•°æ®åˆ°æœ¬åœ° GPU             â”‚
â”‚      - RDMA Readï¼ˆè¿œç¨‹å†…å­˜ç›´è¯»ï¼‰                         â”‚
â”‚      - Node A DRAM â†’ æœ¬åœ° GPU                           â”‚
â”‚      - è€—æ—¶: 0.4 ç§’                                      â”‚
â”‚      â†“                                                   â”‚
â”‚  æ•°æ®åˆ°è¾¾ GPUï¼ŒDecode ç»§ç»­æ‰§è¡Œ                           â”‚
â”‚      â†“                                                   â”‚
â”‚  [å¯é€‰] å®¢æˆ·ç«¯ç»­çº¦ï¼šGetReplicaList() è‡ªåŠ¨æ›´æ–° lease_ttl â”‚
â”‚      æ–° lease_timeout = now() + 60s                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.3 å…³é”®è®¾è®¡äº®ç‚¹

| è®¾è®¡ç‚¹ | è¯´æ˜ | ä¼˜åŠ¿ |
|-------|------|------|
| **Prefill-Decode è§£è€¦** | Prefill èŠ‚ç‚¹åªè´Ÿè´£è®¡ç®— + å­˜å‚¨ï¼ŒDecode èŠ‚ç‚¹æŒ‰éœ€æ‹‰å– | èµ„æºéš”ç¦»ï¼Œç‹¬ç«‹æ‰©å±• |
| **åˆ†ç‰‡å…ƒæ•°æ®** | 1024 ä¸ª shard å¹¶å‘è®¿é—® | æ¶ˆé™¤å•ç‚¹ç“¶é¢ˆï¼Œæ”¯æŒé«˜å¹¶å‘ |
| **Lease æœºåˆ¶** | TTL è‡ªåŠ¨è¿‡æœŸï¼Œé¿å…æ˜¾å¼åˆ é™¤ | å®¹é”™æ€§å¼ºï¼Œè‡ªåŠ¨æ¸…ç† |
| **Near-LRU é©±é€** | åŸºäº lease_timeout æ’åºé©±é€ | è¿‘ä¼¼ LRUï¼Œæ€§èƒ½æ›´å¥½ |
| **æ‹“æ‰‘æ„ŸçŸ¥** | æ ¹æ® NUMA/PCIe é€‰æ‹©æœ€ä¼˜ç½‘å¡ | å»¶è¿Ÿé™ä½ 30%ï¼Œå¸¦å®½æå‡ 50% |
| **å¤šå‰¯æœ¬æ”¯æŒ** | å†…å­˜å‰¯æœ¬ + ç£ç›˜å‰¯æœ¬ | é«˜å¯ç”¨ + æŒä¹…åŒ– |

---

### 4. Transfer Engineï¼šé«˜é€Ÿä¼ è¾“å±‚

Transfer Engine æ˜¯ Mooncake çš„**æ•°æ®ä¼ è¾“æ ¸å¿ƒ**ï¼Œè´Ÿè´£åœ¨èŠ‚ç‚¹é—´é«˜æ•ˆä¼ è¾“ KV Cacheã€‚

#### 4.1 æ ¸å¿ƒç±»è®¾è®¡

**TransferEngine ç±»ï¼ˆmooncake-transfer-engine/include/transfer_engine.h:50ï¼‰**

```cpp
class TransferEngine {
public:
    // åˆå§‹åŒ–ï¼šè¿æ¥å…ƒæ•°æ®æœåŠ¡å™¨ï¼Œå¯åŠ¨ä¼ è¾“å±‚
    int init(const std::string &metadata_conn_string,
             const std::string &local_server_name,
             const std::string &ip_or_host_name = "",
             uint64_t rpc_port = 12345);

    // æ³¨å†Œæœ¬åœ°å†…å­˜ï¼Œä½¿å…¶å¯è¢«è¿œç¨‹ RDMA è®¿é—®
    int registerLocalMemory(void *addr, size_t length,
                           const std::string &location = kWildcardLocation,
                           bool remote_accessible = true,
                           bool update_metadata = true);

    // æ‰¹é‡æ³¨å†Œå†…å­˜ï¼ˆé€‚åˆæ³¨å†Œå¤šä¸ª GPU å†…å­˜å—ï¼‰
    int registerLocalMemoryBatch(
        const std::vector<BufferEntry> &buffer_list,
        const std::string &location);

    // æäº¤ä¼ è¾“ä»»åŠ¡ï¼ˆæ”¯æŒæ‰¹é‡ï¼‰
    Status submitTransfer(BatchID batch_id,
                         const std::vector<TransferRequest> &entries);

    // æŸ¥è¯¢ä¼ è¾“çŠ¶æ€
    Status getTransferStatus(BatchID batch_id, size_t task_id,
                            TransferStatus &status);

private:
    std::shared_ptr<TransferMetadata> metadata_;      // å…ƒæ•°æ®ç®¡ç†å™¨
    std::shared_ptr<MultiTransport> multi_transports_; // å¤šåè®®ä¼ è¾“
    std::shared_ptr<Topology> local_topology_;        // æœ¬åœ°æ‹“æ‰‘ä¿¡æ¯
    std::vector<MemoryRegion> local_memory_regions_;  // å·²æ³¨å†Œçš„å†…å­˜åŒºåŸŸ
};
```

**åˆå§‹åŒ–æµç¨‹**

```cpp
// ç¤ºä¾‹ï¼šåˆå§‹åŒ– TransferEngine
TransferEngine engine(true);  // auto_discover = true

// è¿æ¥åˆ° etcd å…ƒæ•°æ®æœåŠ¡å™¨
engine.init(
    "etcd://10.0.0.1:2379",  // å…ƒæ•°æ®æœåŠ¡å™¨åœ°å€
    "worker-1",               // æœ¬èŠ‚ç‚¹åç§°
    "10.0.1.10",              // æœ¬èŠ‚ç‚¹ IP
    12345                     // RPC ç«¯å£
);

// æ­¤æ—¶ TransferEngine ä¼šï¼š
// 1. è¿æ¥åˆ° etcdï¼Œæ³¨å†Œæœ¬èŠ‚ç‚¹ä¿¡æ¯
// 2. è‡ªåŠ¨å‘ç°æœ¬åœ° RDMA ç½‘å¡ï¼ˆTopology Discoveryï¼‰
// 3. å®‰è£…å¯ç”¨çš„ä¼ è¾“åè®®ï¼ˆRDMA/TCP/NVMe-oFï¼‰
```

#### 4.2 MultiTransport å¤šåè®®æ”¯æŒ

TransferEngine å†…éƒ¨ä½¿ç”¨ **MultiTransport** ç®¡ç†å¤šç§ä¼ è¾“åè®®ï¼š

```
MultiTransport æ¶æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              MultiTransport                            â”‚
â”‚                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Protocol Selectionï¼ˆåè®®é€‰æ‹©ï¼‰                  â”‚ â”‚
â”‚  â”‚                                                   â”‚ â”‚
â”‚  â”‚  if (æ”¯æŒ RDMA && ç›®æ ‡èŠ‚ç‚¹æœ‰ RDMA)              â”‚ â”‚
â”‚  â”‚      â†’ ä½¿ç”¨ RdmaTransport                        â”‚ â”‚
â”‚  â”‚  else if (æ”¯æŒ NVMe-oF && ç›®æ ‡æ˜¯ NVMe è®¾å¤‡)     â”‚ â”‚
â”‚  â”‚      â†’ ä½¿ç”¨ NvmeTransport                        â”‚ â”‚
â”‚  â”‚  else                                             â”‚ â”‚
â”‚  â”‚      â†’ å›é€€åˆ° TcpTransport                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚RdmaTransportâ”‚  â”‚TcpTransport â”‚  â”‚NvmeTransportâ”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                â”‚                â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                â”‚                â”‚
          â†“                â†“                â†“
    [RDMA NIC]        [Ethernet]       [NVMe-oF]
```

**ä¼ è¾“è¯·æ±‚æäº¤æµç¨‹**

```cpp
// ç¤ºä¾‹ï¼šä» GPU ä¼ è¾“ 10GB KV Cache åˆ°è¿œç¨‹èŠ‚ç‚¹

// 1. åˆ†é…æ‰¹æ¬¡ ID
BatchID batch_id = engine.allocateBatchID(2);  // 2 ä¸ªå‰¯æœ¬

// 2. å‡†å¤‡ä¼ è¾“è¯·æ±‚
std::vector<TransferRequest> requests;

// è¯·æ±‚ 1: ä¼ è¾“åˆ° Node A
requests.push_back({
    .source = local_gpu_addr,        // æœ¬åœ° GPU åœ°å€
    .target_id = node_a_segment_id,  // ç›®æ ‡èŠ‚ç‚¹çš„æ®µ ID
    .target_offset = 0,              // ç›®æ ‡åç§»é‡
    .length = 10 * 1024 * 1024 * 1024UL,  // 10 GB
    .opcode = TransferOpcode::WRITE  // å†™æ“ä½œ
});

// è¯·æ±‚ 2: ä¼ è¾“åˆ° Node Bï¼ˆå‰¯æœ¬ï¼‰
requests.push_back({
    .source = local_gpu_addr,
    .target_id = node_b_segment_id,
    .target_offset = 0,
    .length = 10 * 1024 * 1024 * 1024UL,
    .opcode = TransferOpcode::WRITE
});

// 3. æäº¤ä¼ è¾“
Status s = engine.submitTransfer(batch_id, requests);
assert(s.ok());

// 4. è½®è¯¢ä¼ è¾“çŠ¶æ€
TransferStatus status;
while (true) {
    engine.getBatchTransferStatus(batch_id, status);

    if (status.s == TransferStatusEnum::COMPLETED) {
        std::cout << "ä¼ è¾“å®Œæˆï¼æ€»å­—èŠ‚æ•°: "
                  << status.transferred_bytes << std::endl;
        break;
    }
    else if (status.s == TransferStatusEnum::FAILED) {
        std::cerr << "ä¼ è¾“å¤±è´¥ï¼" << std::endl;
        break;
    }

    std::this_thread::sleep_for(std::chrono::milliseconds(10));
}

// 5. é‡Šæ”¾æ‰¹æ¬¡ ID
engine.freeBatchID(batch_id);
```

#### 4.3 å†…å­˜æ³¨å†Œï¼šRDMA çš„å‰æ

åœ¨ä½¿ç”¨ RDMA ä¼ è¾“ä¹‹å‰ï¼Œå¿…é¡»**æ³¨å†Œå†…å­˜**ï¼Œè¿™æ · RDMA ç½‘å¡æ‰èƒ½ç›´æ¥è®¿é—®ï¼š

```cpp
// åœºæ™¯ï¼šæ³¨å†Œ GPU æ˜¾å­˜ï¼Œä½¿å…¶å¯è¢«è¿œç¨‹ RDMA è®¿é—®

// å‡è®¾å·²åˆ†é… GPU å†…å­˜
void *gpu_kv_cache = nullptr;
size_t size = 40 * 1024 * 1024 * 1024UL;  // 40 GB

// ä½¿ç”¨ CUDA åˆ†é…
cudaMalloc(&gpu_kv_cache, size);

// æ³¨å†Œåˆ° TransferEngine
int rc = engine.registerLocalMemory(
    gpu_kv_cache,              // GPU åœ°å€
    size,                      // å¤§å°
    "cuda:0",                  // ä½ç½®æ ‡è¯†ï¼ˆCUDA è®¾å¤‡ 0ï¼‰
    true,                      // remote_accessible = trueï¼ˆå…è®¸è¿œç¨‹è®¿é—®ï¼‰
    true                       // update_metadata = trueï¼ˆæ›´æ–°åˆ°å…ƒæ•°æ®æœåŠ¡å™¨ï¼‰
);

if (rc == 0) {
    std::cout << "GPU å†…å­˜æ³¨å†ŒæˆåŠŸï¼å¯è¢«è¿œç¨‹ RDMA è®¿é—®" << std::endl;
}

// æ­¤æ—¶ï¼š
// 1. RDMA ç½‘å¡å·²å¯¹è¯¥ GPU å†…å­˜å»ºç«‹äº† Memory Region (MR)
// 2. å…ƒæ•°æ®æœåŠ¡å™¨è®°å½•äº†è¯¥æ®µå†…å­˜çš„ä¿¡æ¯ï¼š
//    - èŠ‚ç‚¹åç§°: worker-1
//    - å†…å­˜åœ°å€: gpu_kv_cache
//    - å¤§å°: 40 GB
//    - RDMA rkey: 0x12345678ï¼ˆè¿œç¨‹è®¿é—®å¯†é’¥ï¼‰
// 3. å…¶ä»–èŠ‚ç‚¹å¯ä»¥é€šè¿‡ rkey ç›´æ¥è¯»å†™è¯¥ GPU å†…å­˜ï¼
```

**æ‰¹é‡æ³¨å†Œï¼ˆæ¨èæ–¹å¼ï¼‰**

```cpp
// åŒæ—¶æ³¨å†Œå¤šä¸ª GPU çš„ KV Cache å†…å­˜
std::vector<BufferEntry> buffers;

for (int gpu_id = 0; gpu_id < 8; ++gpu_id) {
    void *addr = nullptr;
    cudaSetDevice(gpu_id);
    cudaMalloc(&addr, 40 * 1024 * 1024 * 1024UL);  // 40 GB per GPU

    buffers.push_back({
        .addr = addr,
        .length = 40 * 1024 * 1024 * 1024UL,
        .remote_accessible = true
    });
}

// æ‰¹é‡æ³¨å†Œï¼ˆä¸€æ¬¡æ€§æ³¨å†Œ 8 ä¸ª GPUï¼‰
engine.registerLocalMemoryBatch(buffers, "cuda");

std::cout << "å·²æ³¨å†Œ 8 ä¸ª GPUï¼Œæ€»å®¹é‡ 320 GB" << std::endl;
```

#### 4.4 æ‹“æ‰‘æ„ŸçŸ¥è·¯å¾„é€‰æ‹©

TransferEngine ä¼šæ ¹æ®**æœ¬åœ°æ‹“æ‰‘**ï¼ˆNUMA/PCIeï¼‰é€‰æ‹©æœ€ä¼˜çš„ RDMA ç½‘å¡ï¼š

```cpp
// Topology ç±»ä¼šæ¢æµ‹ï¼š
// 1. æœ‰å¤šå°‘ä¸ª RDMA ç½‘å¡ï¼ˆHCAï¼‰ï¼Ÿ
// 2. æ¯ä¸ª HCA è¿æ¥åˆ°å“ªä¸ª NUMA èŠ‚ç‚¹ï¼Ÿ
// 3. GPU è¿æ¥åˆ°å“ªä¸ª NUMA èŠ‚ç‚¹ï¼Ÿ

// ç¤ºä¾‹æ‹“æ‰‘ï¼š
// NUMA Node 0:
//   - GPU 0, GPU 1
//   - RDMA NIC 0ï¼ˆmlx5_0ï¼‰
//
// NUMA Node 1:
//   - GPU 2, GPU 3
//   - RDMA NIC 1ï¼ˆmlx5_1ï¼‰

// æ™ºèƒ½é€‰æ‹©é€»è¾‘ï¼š
// å¦‚æœä» GPU 0 ä¼ è¾“æ•°æ®ï¼Œä½¿ç”¨ RDMA NIC 0ï¼ˆåŒ NUMAï¼Œé¿å…è·¨ QPI æ€»çº¿ï¼‰
// å¦‚æœä» GPU 2 ä¼ è¾“æ•°æ®ï¼Œä½¿ç”¨ RDMA NIC 1

// æ€§èƒ½æå‡ï¼š
// - åŒ NUMA: å»¶è¿Ÿ ~2 usï¼Œå¸¦å®½ 25 GB/s
// - è·¨ NUMA: å»¶è¿Ÿ ~5 usï¼Œå¸¦å®½ 15 GB/sï¼ˆQPI ç“¶é¢ˆï¼‰
```

**ä»£ç ç¤ºä¾‹ï¼šæŸ¥è¯¢æ‹“æ‰‘ä¿¡æ¯**

```cpp
auto topology = engine.getLocalTopology();

// è·å–æ‰€æœ‰ RDMA ç½‘å¡
auto hca_list = topology->getHcaList();

for (auto &hca : hca_list) {
    std::cout << "HCA: " << hca.device_name
              << ", NUMA Node: " << hca.numa_node
              << ", PCIe Bus: " << hca.pcie_bus_id
              << std::endl;
}

// è¾“å‡ºç¤ºä¾‹ï¼š
// HCA: mlx5_0, NUMA Node: 0, PCIe Bus: 0000:17:00.0
// HCA: mlx5_1, NUMA Node: 1, PCIe Bus: 0000:81:00.0
```

---

### 5. Mooncake Storeï¼šåˆ†å¸ƒå¼å­˜å‚¨å±‚

Mooncake Store æ˜¯ **KV Cache çš„å­˜å‚¨ç®¡ç†ç³»ç»Ÿ**ï¼Œç”± Master Serviceï¼ˆä¸»èŠ‚ç‚¹ï¼‰å’Œ Storage Nodesï¼ˆå­˜å‚¨èŠ‚ç‚¹ï¼‰ç»„æˆã€‚

#### 5.1 MasterService æ ¸å¿ƒæ•°æ®ç»“æ„

**ObjectMetadata ç»“æ„ï¼ˆmooncake-store/include/master_service.h:241ï¼‰**

```cpp
struct ObjectMetadata {
    std::vector<Replica> replicas;  // å‰¯æœ¬åˆ—è¡¨
    size_t size;                    // å¯¹è±¡å¤§å°ï¼ˆå­—èŠ‚ï¼‰

    // Lease ç§Ÿçº¦æœºåˆ¶
    std::chrono::steady_clock::time_point lease_timeout;  // ç¡¬è¿‡æœŸæ—¶é—´
    std::optional<std::chrono::steady_clock::time_point>
        soft_pin_timeout;  // è½¯é’‰ä½æ—¶é—´ï¼ˆVIP å¯¹è±¡ï¼‰

    // æˆäºˆç§Ÿçº¦ï¼šå»¶é•¿è¿‡æœŸæ—¶é—´
    void GrantLease(const uint64_t ttl, const uint64_t soft_ttl) {
        auto now = std::chrono::steady_clock::now();
        lease_timeout = std::max(lease_timeout,
                                 now + std::chrono::milliseconds(ttl));
        if (soft_pin_timeout) {
            soft_pin_timeout = std::max(*soft_pin_timeout,
                                       now + std::chrono::milliseconds(soft_ttl));
        }
    }

    // æ£€æŸ¥ç§Ÿçº¦æ˜¯å¦è¿‡æœŸ
    bool IsLeaseExpired() const {
        return std::chrono::steady_clock::now() >= lease_timeout;
    }

    // æ£€æŸ¥æ˜¯å¦åœ¨è½¯é’‰ä½çŠ¶æ€
    bool IsSoftPinned() const {
        return soft_pin_timeout &&
               std::chrono::steady_clock::now() < *soft_pin_timeout;
    }
};
```

**Replica å‰¯æœ¬ä¿¡æ¯**

```cpp
class Replica {
public:
    struct Descriptor {
        UUID segment_id;       // å­˜å‚¨æ®µ IDï¼ˆæ ‡è¯†å­˜å‚¨èŠ‚ç‚¹ï¼‰
        uint64_t offset;       // åœ¨æ®µå†…çš„åç§»é‡
        uint64_t length;       // å‰¯æœ¬å¤§å°
        ReplicaType type;      // ç±»å‹ï¼šMEMORY æˆ– DISK
        ReplicaStatus status;  // çŠ¶æ€ï¼šWRITING, COMPLETE, INVALID
    };

    // å‰¯æœ¬çŠ¶æ€è½¬æ¢ï¼š
    // WRITING â†’ COMPLETE (PutEnd)
    // COMPLETE â†’ INVALID (èŠ‚ç‚¹æ•…éšœ)
};
```

#### 5.2 åˆ†ç‰‡å…ƒæ•°æ®ç®¡ç†

MasterService ä½¿ç”¨ **1024 ä¸ªåˆ†ç‰‡ï¼ˆShardsï¼‰** å­˜å‚¨å…ƒæ•°æ®ï¼Œé¿å…å•é”ç“¶é¢ˆï¼š

```cpp
// mooncake-store/include/master_service.h:366
static constexpr size_t kNumShards = 1024;

struct MetadataShard {
    mutable Mutex mutex;  // æ¯ä¸ª shard ç‹¬ç«‹é”
    std::unordered_map<std::string, ObjectMetadata> metadata
        GUARDED_BY(mutex);
};

std::array<MetadataShard, kNumShards> metadata_shards_;

// å“ˆå¸Œåˆ†ç‰‡å‡½æ•°
size_t getShardIndex(const std::string& key) const {
    return std::hash<std::string>{}(key) % kNumShards;
}
```

**å¹¶å‘è®¿é—®ä¼˜åŠ¿**

```python
# ä¼ ç»Ÿå•é”è®¾è®¡
# æ‰€æœ‰è¯·æ±‚æ’é˜Ÿè®¿é—®åŒä¸€ä¸ªé”
Throughput = 1 / lock_hold_time
# å‡è®¾ lock_hold_time = 10 us
# â†’ QPS = 100,000

# Mooncake åˆ†ç‰‡è®¾è®¡
# 1024 ä¸ªé”å¹¶å‘è®¿é—®
Throughput = 1024 / lock_hold_time
# â†’ QPS = 102,400,000 (ç†è®ºå€¼)
# å®é™…æµ‹è¯•ï¼šQPS è¾¾åˆ° 500 ä¸‡+
```

#### 5.3 PutStartï¼šåˆ†é…å­˜å‚¨ç©ºé—´

```cpp
// mooncake-store/include/master_service.h:140
auto PutStart(const std::string& key,
              const std::vector<uint64_t>& slice_lengths,
              const ReplicateConfig& config)
    -> tl::expected<std::vector<Replica::Descriptor>, ErrorCode>;
```

**æ‰§è¡Œæµç¨‹**

```cpp
// ä¼ªä»£ç å±•ç¤º PutStart å†…éƒ¨é€»è¾‘

tl::expected<std::vector<Replica::Descriptor>, ErrorCode>
MasterService::PutStart(const std::string& key,
                        const std::vector<uint64_t>& slice_lengths,
                        const ReplicateConfig& config) {
    // 1. è®¡ç®—æ€»å¤§å°
    uint64_t total_size = 0;
    for (auto len : slice_lengths) total_size += len;

    // 2. æ£€æŸ¥ key æ˜¯å¦å·²å­˜åœ¨
    size_t shard_idx = getShardIndex(key);
    MutexLocker lock(&metadata_shards_[shard_idx].mutex);

    if (metadata_shards_[shard_idx].metadata.count(key)) {
        return tl::unexpected(ErrorCode::OBJECT_ALREADY_EXISTS);
    }

    // 3. ä½¿ç”¨ AllocationStrategy åˆ†é…å‰¯æœ¬
    auto replica_descriptors = allocation_strategy_->Allocate(
        total_size,
        config.num_memory_replicas,  // å†…å­˜å‰¯æœ¬æ•°ï¼ˆé€šå¸¸ = 2ï¼‰
        config.num_disk_replicas      // ç£ç›˜å‰¯æœ¬æ•°ï¼ˆé€šå¸¸ = 0 æˆ– 1ï¼‰
    );

    if (!replica_descriptors) {
        return tl::unexpected(ErrorCode::NO_AVAILABLE_HANDLE);
    }

    // 4. åˆ›å»º ObjectMetadata
    std::vector<Replica> replicas;
    for (auto &desc : *replica_descriptors) {
        replicas.emplace_back(Replica(desc));
    }

    metadata_shards_[shard_idx].metadata.emplace(
        key,
        ObjectMetadata(total_size, std::move(replicas), config.enable_soft_pin)
    );

    // 5. è¿”å›å‰¯æœ¬æè¿°ç¬¦ï¼ˆå®¢æˆ·ç«¯ç”¨äºä¼ è¾“æ•°æ®ï¼‰
    return *replica_descriptors;
}
```

**AllocationStrategy åˆ†é…ç­–ç•¥**

```cpp
// ç®€åŒ–çš„åˆ†é…é€»è¾‘
class AllocationStrategy {
public:
    // é€‰æ‹©å­˜å‚¨èŠ‚ç‚¹å’Œåç§»é‡
    std::vector<Replica::Descriptor> Allocate(
        uint64_t size,
        int num_memory_replicas,
        int num_disk_replicas) {

        std::vector<Replica::Descriptor> result;

        // ä» SegmentManager è·å–å¯ç”¨æ®µï¼ˆæŒ‰å‰©ä½™ç©ºé—´æ’åºï¼‰
        auto segments = segment_manager_.GetAvailableSegments(size);

        // åˆ†é…å†…å­˜å‰¯æœ¬
        for (int i = 0; i < num_memory_replicas && i < segments.size(); ++i) {
            auto &seg = segments[i];

            result.push_back({
                .segment_id = seg.id,
                .offset = seg.allocate(size),  // åˆ†é…å¹¶è¿”å›åç§»é‡
                .length = size,
                .type = ReplicaType::MEMORY,
                .status = ReplicaStatus::WRITING
            });
        }

        // åˆ†é…ç£ç›˜å‰¯æœ¬ï¼ˆå¦‚æœå¯ç”¨ï¼‰
        // ...

        return result;
    }
};
```

#### 5.4 GetReplicaListï¼šæŸ¥è¯¢å‰¯æœ¬ä½ç½®

```cpp
// mooncake-store/include/master_service.h:130
auto GetReplicaList(std::string_view key)
    -> tl::expected<GetReplicaListResponse, ErrorCode>;
```

**æ‰§è¡Œæµç¨‹**

```cpp
tl::expected<GetReplicaListResponse, ErrorCode>
MasterService::GetReplicaList(std::string_view key) {
    // 1. å®šä½åˆ†ç‰‡
    size_t shard_idx = getShardIndex(std::string(key));
    MutexLocker lock(&metadata_shards_[shard_idx].mutex);

    // 2. æŸ¥æ‰¾å…ƒæ•°æ®
    auto it = metadata_shards_[shard_idx].metadata.find(std::string(key));
    if (it == metadata_shards_[shard_idx].metadata.end()) {
        return tl::unexpected(ErrorCode::OBJECT_NOT_FOUND);
    }

    auto &metadata = it->second;

    // 3. æ£€æŸ¥å‰¯æœ¬çŠ¶æ€
    bool all_complete = metadata.IsAllReplicasComplete();
    if (!all_complete) {
        return tl::unexpected(ErrorCode::REPLICA_IS_NOT_READY);
    }

    // 4. ç»­çº¦ï¼ˆGrantLeaseï¼‰
    metadata.GrantLease(default_kv_lease_ttl_,      // 60 ç§’
                        default_kv_soft_pin_ttl_);  // 300 ç§’ï¼ˆVIPï¼‰

    // 5. è¿”å›å‰¯æœ¬åˆ—è¡¨
    GetReplicaListResponse response;
    for (auto &replica : metadata.replicas) {
        if (replica.status() == ReplicaStatus::COMPLETE) {
            response.replicas.push_back(replica.GetDescriptor());
        }
    }
    response.remaining_ttl = std::chrono::duration_cast<std::chrono::milliseconds>(
        metadata.lease_timeout - std::chrono::steady_clock::now()
    ).count();

    return response;
}
```

#### 5.5 Near-LRU é©±é€ç­–ç•¥

å½“å­˜å‚¨ç©ºé—´ä¸è¶³æ—¶ï¼ŒMasterService ä¼šå¯åŠ¨ **BatchEvict** é©±é€å¯¹è±¡ï¼š

```cpp
// mooncake-store/include/master_service.h:235
void BatchEvict(double evict_ratio_target, double evict_ratio_lowerbound);
```

**é©±é€ç®—æ³•ï¼ˆç®€åŒ–ç‰ˆï¼‰**

```cpp
void MasterService::BatchEvict(double evict_ratio_target,
                               double evict_ratio_lowerbound) {
    auto now = std::chrono::steady_clock::now();

    // æ”¶é›†æ‰€æœ‰å¯¹è±¡çš„è¿‡æœŸæ—¶é—´
    struct EvictionCandidate {
        std::string key;
        std::chrono::steady_clock::time_point lease_timeout;
        bool soft_pinned;
        size_t size;
    };
    std::vector<EvictionCandidate> candidates;

    // éå†æ‰€æœ‰åˆ†ç‰‡
    for (size_t shard_idx = 0; shard_idx < kNumShards; ++shard_idx) {
        MutexLocker lock(&metadata_shards_[shard_idx].mutex);

        for (auto &[key, metadata] : metadata_shards_[shard_idx].metadata) {
            candidates.push_back({
                .key = key,
                .lease_timeout = metadata.lease_timeout,
                .soft_pinned = metadata.IsSoftPinned(now),
                .size = metadata.size
            });
        }
    }

    // æŒ‰ lease_timeout æ’åºï¼ˆæœ€æ—©è¿‡æœŸçš„ä¼˜å…ˆé©±é€ï¼‰
    std::sort(candidates.begin(), candidates.end(),
              [](auto &a, auto &b) {
                  return a.lease_timeout < b.lease_timeout;
              });

    // ç¬¬ä¸€éï¼šåªé©±é€æœª soft_pinned çš„å¯¹è±¡
    size_t evicted_size = 0;
    size_t total_size = getTotalAllocatedSize();
    size_t target_size = total_size * evict_ratio_target;

    for (auto &candidate : candidates) {
        if (evicted_size >= target_size) break;
        if (candidate.soft_pinned) continue;  // è·³è¿‡ VIP å¯¹è±¡

        if (candidate.lease_timeout <= now) {  // å·²è¿‡æœŸ
            Remove(candidate.key);
            evicted_size += candidate.size;
        }
    }

    // ç¬¬äºŒéï¼šå¦‚æœé©±é€ä¸è¶³ï¼Œè€ƒè™‘é©±é€ soft_pinned å¯¹è±¡
    if (evicted_size < total_size * evict_ratio_lowerbound) {
        // å…è®¸é©±é€ VIP å¯¹è±¡ï¼ˆå¦‚æœé…ç½®å…è®¸ï¼‰
        // ...
    }
}
```

**é©±é€è§¦å‘æ¡ä»¶**

```cpp
// åœ¨æ¯æ¬¡ PutStart æ—¶æ£€æŸ¥ç©ºé—´
if (segment_manager_.GetFreeSpaceRatio() < eviction_high_watermark_ratio_) {
    // ä¾‹å¦‚ï¼šå‰©ä½™ç©ºé—´ < 20%
    need_eviction_.store(true);  // é€šçŸ¥é©±é€çº¿ç¨‹
}

// é©±é€çº¿ç¨‹ï¼ˆåå°è¿è¡Œï¼‰
void EvictionThreadFunc() {
    while (eviction_running_) {
        if (need_eviction_.load()) {
            BatchEvict(0.3, 0.2);  // é©±é€ 30%ï¼Œè‡³å°‘ 20%
            need_eviction_.store(false);
        }
        std::this_thread::sleep_for(std::chrono::milliseconds(10));
    }
}
```

---

## ç¬¬ä¸‰éƒ¨åˆ†:å·¥ä½œåŸç†æ·±å…¥

### 6. RDMA é›¶æ‹·è´æŠ€æœ¯

#### 6.1 ä¼ ç»Ÿç½‘ç»œä¼ è¾“ vs RDMA

**ä¼ ç»Ÿ TCP/IP ä¼ è¾“çš„é—®é¢˜**

```
ä¼ ç»Ÿä¼ è¾“è·¯å¾„ (TCP/IP):

åº”ç”¨å±‚æ•°æ® (GPU/CPU å†…å­˜)
    â†“ [æ‹·è´ 1] ç”¨æˆ·ç©ºé—´ â†’ å†…æ ¸ç©ºé—´
å†…æ ¸ Socket Buffer
    â†“ [æ‹·è´ 2] å†…æ ¸ â†’ ç½‘å¡ DMA Buffer
ç½‘å¡å‘é€
    â†“ ç½‘ç»œä¼ è¾“
æ¥æ”¶ç«¯ç½‘å¡
    â†“ [æ‹·è´ 3] ç½‘å¡ â†’ å†…æ ¸ Socket Buffer
å†…æ ¸å¤„ç† (åè®®æ ˆ)
    â†“ [æ‹·è´ 4] å†…æ ¸ â†’ ç”¨æˆ·ç©ºé—´
åº”ç”¨å±‚æ¥æ”¶

é—®é¢˜:
âŒ 4 æ¬¡å†…å­˜æ‹·è´
âŒ 2 æ¬¡ç”¨æˆ·æ€/å†…æ ¸æ€åˆ‡æ¢
âŒ CPU å‚ä¸å…¨ç¨‹
âŒ å»¶è¿Ÿ ~50-100 us
âŒ å¸¦å®½å—é™äº CPU å¤„ç†èƒ½åŠ›
```

**RDMA é›¶æ‹·è´ä¼ è¾“**

```
RDMA ä¼ è¾“è·¯å¾„:

åº”ç”¨å±‚æ•°æ® (GPU/CPU å†…å­˜)
    â†“ [0 æ¬¡æ‹·è´!] RDMA ç½‘å¡ç›´æ¥è®¿é—®
RDMA NIC (DMA å¼•æ“)
    â†“ PCIe æ€»çº¿
ç½‘ç»œä¼ è¾“
    â†“
æ¥æ”¶ç«¯ RDMA NIC
    â†“ [0 æ¬¡æ‹·è´!] ç›´æ¥å†™å…¥ç›®æ ‡å†…å­˜
ç›®æ ‡å†…å­˜ (GPU/CPU)

ä¼˜åŠ¿:
âœ… 0 æ¬¡å†…å­˜æ‹·è´
âœ… 0 æ¬¡ CPU å‚ä¸
âœ… å»¶è¿Ÿ ~1-2 us (50x æå‡!)
âœ… å¸¦å®½ 25 GB/s (200 Gbps)
âœ… CPU é‡Šæ”¾ç”¨äºè®¡ç®—
```

#### 6.2 GPUDirect RDMA

Mooncake ä½¿ç”¨ **GPUDirect RDMA** å®ç° GPU åˆ° GPU çš„ç›´æ¥ä¼ è¾“:

```
ä¼ ç»Ÿæ–¹å¼ (GPU â†’ è¿œç¨‹ GPU):

Local GPU Memory
    â†“ [æ‹·è´ 1] GPU â†’ CPU (PCIe)
CPU Memory
    â†“ [æ‹·è´ 2] CPU â†’ ç½‘å¡ (PCIe)
RDMA NIC
    â†“ ç½‘ç»œä¼ è¾“
Remote RDMA NIC
    â†“ [æ‹·è´ 3] ç½‘å¡ â†’ CPU (PCIe)
Remote CPU Memory
    â†“ [æ‹·è´ 4] CPU â†’ GPU (PCIe)
Remote GPU Memory

æ€»å»¶è¿Ÿ: 4x PCIe + ç½‘ç»œ â‰ˆ 50 us
```

```
GPUDirect RDMA (GPU â†’ è¿œç¨‹ GPU):

Local GPU Memory
    â†“ [ç›´æ¥ DMA!]
RDMA NIC (é€šè¿‡ PCIe P2P)
    â†“ ç½‘ç»œä¼ è¾“
Remote RDMA NIC
    â†“ [ç›´æ¥ DMA!]
Remote GPU Memory (é€šè¿‡ PCIe P2P)

æ€»å»¶è¿Ÿ: 2x PCIe + ç½‘ç»œ â‰ˆ 10 us (5x æå‡!)
```

**ä»£ç ç¤ºä¾‹:å¯ç”¨ GPUDirect RDMA**

```cpp
// 1. åˆ†é… GPU å†…å­˜
void *gpu_buffer = nullptr;
cudaMalloc(&gpu_buffer, 10 * 1024 * 1024 * 1024UL);  // 10 GB

// 2. æ³¨å†Œä¸º RDMA Memory Region
ibv_mr *mr = ibv_reg_mr(
    pd,                       // Protection Domain
    gpu_buffer,               // GPU åœ°å€
    10 * 1024 * 1024 * 1024UL,
    IBV_ACCESS_LOCAL_WRITE |
    IBV_ACCESS_REMOTE_WRITE |
    IBV_ACCESS_REMOTE_READ
);

// 3. RDMA ç½‘å¡ç°åœ¨å¯ä»¥ç›´æ¥è®¿é—® GPU å†…å­˜!
// ä¼ è¾“æ—¶ä½¿ç”¨ mr->rkey (Remote Key)
```

#### 6.3 RDMA æ“ä½œç±»å‹

Mooncake ä½¿ç”¨çš„ RDMA æ“ä½œ:

**1. RDMA Write (å•è¾¹æ“ä½œ)**

```cpp
// åœºæ™¯: Prefill å®Œæˆå,å°† KV Cache ä» GPU å†™å…¥è¿œç¨‹ DRAM

// æœ¬åœ°: Worker-1 GPU
void *local_kv_cache = gpu_kv_cache_addr;

// è¿œç¨‹: Storage Node A DRAM
uint64_t remote_addr = 0x7fffffff0000;
uint32_t remote_rkey = 0x12345678;  // ä» Master Service è·å–

// æäº¤ RDMA Write
struct ibv_sge sge = {
    .addr = (uint64_t)local_kv_cache,
    .length = 10 * 1024 * 1024 * 1024UL,
    .lkey = local_mr->lkey
};

struct ibv_send_wr wr = {
    .sg_list = &sge,
    .num_sge = 1,
    .opcode = IBV_WR_RDMA_WRITE,  // RDMA Write
    .send_flags = IBV_SEND_SIGNALED,
    .wr = {
        .rdma = {
            .remote_addr = remote_addr,
            .rkey = remote_rkey
        }
    }
};

// å‘é€è¯·æ±‚ (å¼‚æ­¥)
ibv_post_send(qp, &wr, &bad_wr);

// ç‰¹ç‚¹:
// - å•è¾¹æ“ä½œ: è¿œç¨‹ CPU ä¸å‚ä¸!
// - å¼‚æ­¥æ‰§è¡Œ: ç«‹å³è¿”å›
// - å®Œæˆé€šçŸ¥: é€šè¿‡ Completion Queue (CQ)
```

**2. RDMA Read (å•è¾¹æ“ä½œ)**

```cpp
// åœºæ™¯: Decode æ—¶,ä»è¿œç¨‹ DRAM è¯»å– KV Cache åˆ°æœ¬åœ° GPU

// æœ¬åœ°: Worker-2 GPU
void *local_gpu_buffer = gpu_buffer_addr;

// è¿œç¨‹: Storage Node A DRAM (KV Cache ä½ç½®)
uint64_t remote_kv_addr = 0x7fffffff0000;
uint32_t remote_rkey = 0x12345678;

// æäº¤ RDMA Read
struct ibv_send_wr wr = {
    .opcode = IBV_WR_RDMA_READ,  // RDMA Read
    .wr = {
        .rdma = {
            .remote_addr = remote_kv_addr,
            .rkey = remote_rkey
        }
    }
};

ibv_post_send(qp, &wr, &bad_wr);

// æ•°æ®ä¼šç›´æ¥ä»è¿œç¨‹ DRAM ä¼ è¾“åˆ°æœ¬åœ° GPU!
```

**3. æ€§èƒ½å¯¹æ¯”**

```python
# åœºæ™¯: ä¼ è¾“ 10 GB KV Cache

# TCP Socket (ä¼ ç»Ÿæ–¹å¼)
tcp_bandwidth = 1.25 * 1024**3  # 10 Gbps = 1.25 GB/s
tcp_time = 10 / 1.25  # = 8 ç§’
tcp_cpu_usage = 100%  # CPU å…¨ç¨‹å‚ä¸

# RDMA Write/Read
rdma_bandwidth = 25 * 1024**3  # 200 Gbps = 25 GB/s
rdma_time = 10 / 25  # = 0.4 ç§’
rdma_cpu_usage = 0%  # CPU å®Œå…¨é‡Šæ”¾!

# æå‡:
# - é€Ÿåº¦: 8 / 0.4 = 20x
# - CPU: ä» 100% â†’ 0%
```

#### 6.4 Mooncake ä¸­çš„ RDMA å®ç°

**RdmaTransport ç±» (mooncake-transfer-engine/include/transport/rdma_transport/rdma_transport.h:41)**

```cpp
class RdmaTransport : public Transport {
public:
    // æäº¤ RDMA ä¼ è¾“è¯·æ±‚
    Status submitTransfer(BatchID batch_id,
                         const std::vector<TransferRequest> &entries) override;

private:
    // RDMA Context åˆ—è¡¨ (æ¯ä¸ª RDMA ç½‘å¡ä¸€ä¸ª)
    std::vector<std::shared_ptr<RdmaContext>> context_list_;

    // æœ¬åœ°æ‹“æ‰‘ä¿¡æ¯ (ç”¨äºé€‰æ‹©æœ€ä¼˜ç½‘å¡)
    std::shared_ptr<Topology> local_topology_;
};
```

**RdmaContext:ç®¡ç†å•ä¸ª RDMA ç½‘å¡**

```cpp
class RdmaContext {
public:
    // InfiniBand Verbs èµ„æº
    ibv_context *context_;       // RDMA è®¾å¤‡ä¸Šä¸‹æ–‡
    ibv_pd *protection_domain_;  // Protection Domain
    ibv_cq *completion_queue_;   // Completion Queue (æ¥æ”¶å®Œæˆé€šçŸ¥)

    // Queue Pair (QP) æ± : ä¸æ¯ä¸ªè¿œç¨‹èŠ‚ç‚¹å»ºç«‹ä¸€ä¸ª QP
    std::unordered_map<SegmentID, ibv_qp*> qp_map_;

    // å†…å­˜æ³¨å†Œè¡¨
    std::unordered_map<void*, ibv_mr*> mr_map_;
};
```

**å®Œæ•´ä¼ è¾“æµç¨‹ (ç®€åŒ–ä»£ç )**

```cpp
Status RdmaTransport::submitTransfer(
    BatchID batch_id,
    const std::vector<TransferRequest> &entries) {

    for (auto &req : entries) {
        // 1. æ ¹æ®æ‹“æ‰‘é€‰æ‹©æœ€ä¼˜çš„ RdmaContext
        auto ctx = selectContext(req.source, req.target_id);

        // 2. è·å–æˆ–åˆ›å»ºä¸ç›®æ ‡èŠ‚ç‚¹çš„ QP
        ibv_qp *qp = ctx->getOrCreateQP(req.target_id);

        // 3. æŸ¥æ‰¾æœ¬åœ°å†…å­˜çš„ Memory Region
        ibv_mr *local_mr = ctx->getMR(req.source);

        // 4. ä»å…ƒæ•°æ®æœåŠ¡å™¨è·å–è¿œç¨‹å†…å­˜ä¿¡æ¯
        auto remote_info = metadata_->getRemoteBuffer(
            req.target_id,
            req.target_offset
        );

        // 5. æ„é€  RDMA Work Request
        struct ibv_send_wr wr = {};
        wr.opcode = (req.opcode == TransferOpcode::WRITE)
                    ? IBV_WR_RDMA_WRITE
                    : IBV_WR_RDMA_READ;
        wr.wr.rdma.remote_addr = remote_info.addr;
        wr.wr.rdma.rkey = remote_info.rkey;

        struct ibv_sge sge = {
            .addr = (uint64_t)req.source,
            .length = req.length,
            .lkey = local_mr->lkey
        };
        wr.sg_list = &sge;
        wr.num_sge = 1;

        // 6. æäº¤åˆ° RDMA ç½‘å¡ (å¼‚æ­¥)
        ibv_post_send(qp, &wr, nullptr);

        // 7. è®°å½• BatchID,ç”¨äºåç»­æŸ¥è¯¢çŠ¶æ€
        registerTransfer(batch_id, qp, wr.wr_id);
    }

    return Status::OK();
}
```

---

### 7. å…ƒæ•°æ®ç®¡ç†ä¸é©±é€ç­–ç•¥

#### 7.1 TransferMetadata:åˆ†å¸ƒå¼å…ƒæ•°æ®æœåŠ¡

TransferMetadata è´Ÿè´£ç®¡ç†**èŠ‚ç‚¹å‘ç°**å’Œ**å†…å­˜æ®µæ³¨å†Œ**:

```cpp
class TransferMetadata {
public:
    // æ³¨å†Œæœ¬åœ°å†…å­˜æ®µåˆ° etcd
    int registerSegment(const std::string &segment_name,
                        const SegmentDesc &desc);

    // æŸ¥è¯¢è¿œç¨‹æ®µä¿¡æ¯
    SegmentDesc *getSegment(const std::string &segment_name);

    // åŒæ­¥æ®µç¼“å­˜ (ä» etcd æ‹‰å–æœ€æ–°ä¿¡æ¯)
    int syncSegmentCache(const std::string &segment_name = "");
};
```

**SegmentDesc ç»“æ„**

```cpp
struct SegmentDesc {
    std::string segment_name;    // æ®µåç§° (å¦‚ "worker-1")
    std::string server_name;     // æœåŠ¡å™¨åç§°
    uint64_t segment_id;         // æ®µ ID

    // å¤šä¸ª Buffer (æ”¯æŒå¤š GPU)
    std::vector<BufferDesc> buffer_list;

    // RDMA è¿æ¥ä¿¡æ¯
    std::string rdma_device_name;  // "mlx5_0"
    uint16_t rdma_lid;             // Local ID
    uint32_t rdma_qpn;             // Queue Pair Number
};

struct BufferDesc {
    uint64_t addr;       // å†…å­˜åœ°å€
    uint64_t length;     // å¤§å°
    uint32_t rkey;       // RDMA Remote Key
    std::string location;  // "cuda:0", "cpu", etc.
};
```

**etcd ä¸­çš„æ•°æ®ç»“æ„**

```
etcd é”®å€¼å¯¹:

/mooncake/segments/worker-1 = {
    "segment_id": 1,
    "server_name": "worker-1",
    "buffers": [
        {
            "addr": "0x7fff00000000",
            "length": 42949672960,  // 40 GB
            "rkey": 305419896,
            "location": "cuda:0"
        },
        {
            "addr": "0x7ffe00000000",
            "length": 42949672960,
            "rkey": 305419897,
            "location": "cuda:1"
        }
    ],
    "rdma_device": "mlx5_0",
    "rdma_lid": 12,
    "rdma_qpn": 456
}

/mooncake/segments/worker-2 = { ... }
/mooncake/segments/storage-node-1 = { ... }
```

#### 7.2 Lease ç§Ÿçº¦æœºåˆ¶è¯¦è§£

**ä¸ºä»€ä¹ˆéœ€è¦ Lease?**

```python
# é—®é¢˜: å¦‚æœ Decode èŠ‚ç‚¹å´©æºƒ,KV Cache å¦‚ä½•æ¸…ç†?

# ä¼ ç»Ÿæ–¹å¼: æ˜¾å¼åˆ é™¤
client.delete(key="prompt_hash_123")
# âŒ å¦‚æœå®¢æˆ·ç«¯å´©æºƒ,æ°¸è¿œä¸ä¼šè°ƒç”¨ delete
# âŒ KV Cache æ°¸ä¹…å ç”¨å­˜å‚¨ç©ºé—´

# Lease æ–¹å¼: è‡ªåŠ¨è¿‡æœŸ
master.put(key="prompt_hash_123", ttl=60)  # 60 ç§’åè‡ªåŠ¨åˆ é™¤
# âœ… å³ä½¿å®¢æˆ·ç«¯å´©æºƒ,60 ç§’åè‡ªåŠ¨æ¸…ç†
# âœ… æ­£å¸¸æƒ…å†µä¸‹,å®¢æˆ·ç«¯å®šæœŸç»­çº¦

# ç»­çº¦
master.get(key="prompt_hash_123")  # è‡ªåŠ¨ç»­çº¦ 60 ç§’
```

**Lease çŠ¶æ€æœº**

```
KV Cache ç”Ÿå‘½å‘¨æœŸ:

1. PutStart
   â†“
   åˆ›å»º ObjectMetadata
   lease_timeout = now() + 60s
   status = WRITING

2. PutEnd
   â†“
   status = COMPLETE
   lease_timeout = now() + 60s  (é‡ç½®)

3. GetReplicaList (Decode è®¿é—®)
   â†“
   GrantLease(60s)
   lease_timeout = max(lease_timeout, now() + 60s)  (ç»­çº¦)

4. æŒç»­è®¿é—®
   â†“
   æ¯æ¬¡ Get éƒ½ç»­çº¦
   lease_timeout ä¸æ–­å»¶é•¿

5. åœæ­¢è®¿é—®
   â†“
   60 ç§’å†…æ—  Get è¯·æ±‚
   lease_timeout åˆ°æœŸ

6. é©±é€çº¿ç¨‹æ£€æµ‹
   â†“
   IsLeaseExpired() == true
   â†“
   Remove(key)  (è‡ªåŠ¨åˆ é™¤)
```

**Soft Pin:VIP å¯¹è±¡ä¿æŠ¤**

```cpp
// æŸäº› KV Cache å¯èƒ½éœ€è¦æ›´é•¿çš„ä¿ç•™æ—¶é—´
// ä¾‹å¦‚: ç³»ç»Ÿ prompt (å¦‚ "ä½ æ˜¯ä¸€ä¸ªAIåŠ©æ‰‹")

ObjectMetadata {
    lease_timeout: now() + 60s,         // ç¡¬è¿‡æœŸæ—¶é—´ (60 ç§’)
    soft_pin_timeout: now() + 300s      // è½¯é’‰ä½æ—¶é—´ (5 åˆ†é’Ÿ)
}

// é©±é€ç­–ç•¥:
// - ç¬¬ä¸€é: åªé©±é€ lease_timeout è¿‡æœŸä¸”æœª soft_pinned çš„å¯¹è±¡
// - ç¬¬äºŒé: å¦‚æœç©ºé—´ä»ä¸è¶³,é©±é€ soft_pinned å¯¹è±¡

// æ•ˆæœ:
// - å¸¸è§„å¯¹è±¡: 60 ç§’ä¸è®¿é—®å°±é©±é€
// - VIP å¯¹è±¡: 5 åˆ†é’Ÿä¸è®¿é—®æ‰è€ƒè™‘é©±é€
```

#### 7.3 Near-LRU é©±é€ç®—æ³•

**ä¼ ç»Ÿ LRU vs Near-LRU**

```python
# ä¼ ç»Ÿ LRU (Least Recently Used)
# éœ€è¦ç»´æŠ¤è®¿é—®æ—¶é—´æˆ³,æ¯æ¬¡è®¿é—®éƒ½æ›´æ–°

class TraditionalLRU:
    def __init__(self):
        self.cache = {}
        self.access_order = []  # åŒå‘é“¾è¡¨,è®°å½•è®¿é—®é¡ºåº

    def get(self, key):
        # æ¯æ¬¡è®¿é—®éƒ½è¦ç§»åŠ¨åˆ°é“¾è¡¨å°¾éƒ¨
        self.access_order.remove(key)  # O(1) if doubly linked list
        self.access_order.append(key)
        return self.cache[key]

    def evict(self):
        # é©±é€é“¾è¡¨å¤´éƒ¨ (æœ€ä¹…æœªè®¿é—®)
        oldest_key = self.access_order.pop(0)
        del self.cache[oldest_key]

# é—®é¢˜:
# âŒ æ¯æ¬¡ Get éƒ½è¦æ›´æ–°é“¾è¡¨ (éœ€è¦åŠ é”)
# âŒ é«˜å¹¶å‘ä¸‹æ€§èƒ½å·®
```

```python
# Mooncake Near-LRU
# åˆ©ç”¨ lease_timeout è¿‘ä¼¼ LRU

class MooncakeNearLRU:
    def __init__(self):
        self.cache = {}  # key â†’ ObjectMetadata

    def get(self, key):
        metadata = self.cache[key]
        # åªæ›´æ–° lease_timeout (å¿«é€Ÿæ“ä½œ)
        metadata.lease_timeout = now() + 60s
        return metadata

    def evict(self, ratio=0.3):
        # æ”¶é›†æ‰€æœ‰å¯¹è±¡
        candidates = list(self.cache.items())

        # æŒ‰ lease_timeout æ’åº (æœ€æ—©è¿‡æœŸçš„åœ¨å‰é¢)
        candidates.sort(key=lambda x: x[1].lease_timeout)

        # é©±é€å‰ 30%
        evict_count = int(len(candidates) * ratio)
        for i in range(evict_count):
            key, metadata = candidates[i]
            if metadata.IsLeaseExpired():
                del self.cache[key]

# ä¼˜åŠ¿:
# âœ… Get æ“ä½œåªæ›´æ–°æ—¶é—´æˆ³,æ— éœ€ç§»åŠ¨é“¾è¡¨
# âœ… é©±é€æ—¶æ‰¹é‡æ’åº,åˆ†æ‘Šæˆæœ¬
# âœ… è¿‘ä¼¼ LRU,å®é™…æ•ˆæœæ¥è¿‘
```

**é©±é€æ€§èƒ½åˆ†æ**

```python
# å‡è®¾: 100 ä¸‡ä¸ª KV Cache å¯¹è±¡

# ä¼ ç»Ÿ LRU:
# - Get æ“ä½œ: O(1) ä½†éœ€è¦åŠ é”æ›´æ–°é“¾è¡¨
# - é©±é€æ“ä½œ: O(1) ä½†éœ€è¦é€ä¸ªé©±é€
# - å¹¶å‘ç“¶é¢ˆ: é“¾è¡¨é”ç«äº‰

# Mooncake Near-LRU:
# - Get æ“ä½œ: O(1) åªæ›´æ–°æ—¶é—´æˆ³ (åŸå­æ“ä½œ)
# - é©±é€æ“ä½œ: O(N log N) æ’åº,ä½†æ‰¹é‡æ‰§è¡Œ
# - å¹¶å‘ä¼˜åŒ–: 1024 ä¸ªåˆ†ç‰‡ç‹¬ç«‹é©±é€

# å®é™…æµ‹è¯•:
# - å•åˆ†ç‰‡é©±é€: 1000 ä¸ªå¯¹è±¡,è€—æ—¶ ~1ms
# - å…¨å±€é©±é€: 100 ä¸‡ä¸ªå¯¹è±¡,è€—æ—¶ ~1s (å¹¶è¡Œ)
# - Get QPS: 500 ä¸‡+ (å¾—ç›Šäºåˆ†ç‰‡)
```

---

### 8. å®Œæ•´è¯·æ±‚æµç¨‹

#### 8.1 Prefill æµç¨‹:å­˜å‚¨ KV Cache

```
å®Œæ•´æµç¨‹: vLLM Prefill â†’ Mooncake å­˜å‚¨

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. vLLM Prefill (Worker-1, GPU 0)                      â”‚
â”‚                                                         â”‚
â”‚  User Request:                                          â”‚
â”‚    prompt = "è¯·ç”¨ Python å®ç°å¿«é€Ÿæ’åºç®—æ³•"              â”‚
â”‚    model = "Qwen2.5-72B"                                â”‚
â”‚                                                         â”‚
â”‚  vLLM æ‰§è¡Œ:                                             â”‚
â”‚    tokens = tokenizer.encode(prompt)  # [101, 234, ...] â”‚
â”‚    kv_cache = model.prefill(tokens)                     â”‚
â”‚                                                         â”‚
â”‚  KV Cache ä¿¡æ¯:                                         â”‚
â”‚    - GPU åœ°å€: 0x7f8000000000                           â”‚
â”‚    - å¤§å°: 10 GB                                        â”‚
â”‚    - å±‚æ•°: 80                                           â”‚
â”‚    - éšè—ç»´åº¦: 8192                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. LMCache æ‹¦æˆª (L3 Remote Backend = Mooncake)         â”‚
â”‚                                                         â”‚
â”‚  cache_engine.put(                                      â”‚
â”‚      key = hash(tokens),  # "prompt_hash_abc123"       â”‚
â”‚      value = kv_cache     # GPU åœ°å€                    â”‚
â”‚  )                                                      â”‚
â”‚                                                         â”‚
â”‚  LMCache å†³ç­–:                                          â”‚
â”‚    - L1 (GPU) å·²æ»¡ â†’ è·³è¿‡                              â”‚
â”‚    - L2 (CPU) å·²æ»¡ â†’ è·³è¿‡                              â”‚
â”‚    - L3 (Mooncake) â†’ å­˜å‚¨!                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Mooncake Client: PutStart                           â”‚
â”‚                                                         â”‚
â”‚  client.put_start(                                      â”‚
â”‚      key = "prompt_hash_abc123",                        â”‚
â”‚      size = 10 * 1024**3,  # 10 GB                     â”‚
â”‚      num_replicas = 2                                   â”‚
â”‚  )                                                      â”‚
â”‚  â†“                                                      â”‚
â”‚  RPC â†’ Master Service                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Master Service: åˆ†é…å­˜å‚¨ç©ºé—´                         â”‚
â”‚                                                         â”‚
â”‚  MasterService::PutStart() {                            â”‚
â”‚      // æ£€æŸ¥ç©ºé—´                                        â”‚
â”‚      if (free_space < 10 GB) {                          â”‚
â”‚          trigger_eviction();                            â”‚
â”‚      }                                                  â”‚
â”‚                                                         â”‚
â”‚      // é€‰æ‹©å­˜å‚¨èŠ‚ç‚¹                                    â”‚
â”‚      replicas = [                                       â”‚
â”‚          {node: "storage-1", offset: 0, size: 10GB},   â”‚
â”‚          {node: "storage-2", offset: 0, size: 10GB}    â”‚
â”‚      ]                                                  â”‚
â”‚                                                         â”‚
â”‚      // åˆ›å»ºå…ƒæ•°æ®                                      â”‚
â”‚      metadata["prompt_hash_abc123"] = {                 â”‚
â”‚          replicas: replicas,                            â”‚
â”‚          status: WRITING,                               â”‚
â”‚          lease_timeout: now() + 60s                     â”‚
â”‚      }                                                  â”‚
â”‚                                                         â”‚
â”‚      return replicas;                                   â”‚
â”‚  }                                                      â”‚
â”‚  â†“                                                      â”‚
â”‚  è¿”å›å‰¯æœ¬åˆ—è¡¨ â†’ Client                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Transfer Engine: RDMA ä¼ è¾“                           â”‚
â”‚                                                         â”‚
â”‚  engine.submitTransfer({                                â”‚
â”‚      source: 0x7f8000000000,  # GPU 0 åœ°å€             â”‚
â”‚      targets: [                                         â”‚
â”‚          {node: "storage-1", addr: 0x7fff..., size: 10GB}, â”‚
â”‚          {node: "storage-2", addr: 0x7ffe..., size: 10GB}  â”‚
â”‚      ]                                                  â”‚
â”‚  })                                                     â”‚
â”‚                                                         â”‚
â”‚  æ‰§è¡Œæµç¨‹:                                              â”‚
â”‚    1. é€‰æ‹© RDMA NIC (æ‹“æ‰‘æ„ŸçŸ¥)                          â”‚
â”‚    2. å»ºç«‹ QP è¿æ¥ (å¦‚æœå°šæœªè¿æ¥)                       â”‚
â”‚    3. æäº¤ RDMA Write                                   â”‚
â”‚       GPU 0 â†’ storage-1 DRAM (å¹¶è¡Œ)                    â”‚
â”‚       GPU 0 â†’ storage-2 DRAM (å¹¶è¡Œ)                    â”‚
â”‚    4. ç­‰å¾… Completion Queue é€šçŸ¥                        â”‚
â”‚                                                         â”‚
â”‚  ä¼ è¾“æ—¶é—´: 10GB Ã· 25GB/s = 0.4 ç§’                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Mooncake Client: PutEnd                             â”‚
â”‚                                                         â”‚
â”‚  client.put_end(key = "prompt_hash_abc123")            â”‚
â”‚  â†“                                                      â”‚
â”‚  RPC â†’ Master Service                                   â”‚
â”‚                                                         â”‚
â”‚  MasterService::PutEnd() {                              â”‚
â”‚      metadata["prompt_hash_abc123"].status = COMPLETE;  â”‚
â”‚      metadata["prompt_hash_abc123"].GrantLease(60s);    â”‚
â”‚  }                                                      â”‚
â”‚                                                         â”‚
â”‚  âœ… å­˜å‚¨å®Œæˆ! KV Cache ç°åœ¨å¯è¢«å…¶ä»–èŠ‚ç‚¹è®¿é—®             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 8.2 Decode æµç¨‹:è¯»å– KV Cache

**é‡è¦è¯´æ˜**: æœ¬ä¾‹å±•ç¤º**è·¨èŠ‚ç‚¹è®¿é—®**åœºæ™¯ (Worker-2 è®¿é—® Worker-1 å­˜å‚¨çš„ KV Cache)

```
å®Œæ•´æµç¨‹: vLLM Decode â†’ Mooncake è¯»å–

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. vLLM Decode (Worker-2, GPU 1)                       â”‚
â”‚                                                         â”‚
â”‚  User Request (è¿½é—®):                                   â”‚
â”‚    prompt = "è¯·ç”¨ Python å®ç°å¿«é€Ÿæ’åºç®—æ³•,å¹¶åŠ ä¸Šè¯¦ç»†æ³¨é‡Š" â”‚
â”‚                                                         â”‚
â”‚  LMCache æŸ¥æ‰¾:                                          â”‚
â”‚    prefix_tokens = tokens[0:90%]  # å‰ 90% åŒ¹é…         â”‚
â”‚    key = hash(prefix_tokens)      # "prompt_hash_abc123" â”‚
â”‚                                                         â”‚
â”‚  æ³¨æ„: KV Cache æ˜¯åœ¨ Worker-1 ä¸Šç”Ÿæˆå¹¶å­˜å‚¨çš„!           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. LMCache ä¸‰å±‚æŸ¥æ‰¾ (Worker-2 æœ¬åœ°)                    â”‚
â”‚                                                         â”‚
â”‚  L1 (Worker-2 GPU 1): æœªå‘½ä¸­ (æœ¬åœ°æ²¡æœ‰)                â”‚
â”‚  L2 (Worker-2 CPU å†…å­˜): æœªå‘½ä¸­ (æœ¬åœ°æ²¡æœ‰)             â”‚
â”‚  L3 (Mooncake å…¨å±€): æŸ¥è¯¢...                           â”‚
â”‚                                                         â”‚
â”‚  â†’ Mooncake æ˜¯**å…¨å±€åˆ†å¸ƒå¼å­˜å‚¨**                        â”‚
â”‚  â†’ å¯ä»¥æ‰¾åˆ° Worker-1 å­˜å‚¨çš„ KV Cache                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Mooncake Client: GetReplicaList                     â”‚
â”‚                                                         â”‚
â”‚  replicas = client.get_replica_list("prompt_hash_abc123") â”‚
â”‚  â†“                                                      â”‚
â”‚  RPC â†’ Master Service                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Master Service: è¿”å›å‰¯æœ¬ä¿¡æ¯                         â”‚
â”‚                                                         â”‚
â”‚  MasterService::GetReplicaList() {                      â”‚
â”‚      metadata = metadata["prompt_hash_abc123"];         â”‚
â”‚                                                         â”‚
â”‚      if (metadata.status != COMPLETE) {                 â”‚
â”‚          return ERROR_NOT_READY;                        â”‚
â”‚      }                                                  â”‚
â”‚                                                         â”‚
â”‚      // ç»­çº¦ (å…³é”®!)                                    â”‚
â”‚      metadata.GrantLease(60s);                          â”‚
â”‚                                                         â”‚
â”‚      return {                                           â”‚
â”‚          replicas: [                                    â”‚
â”‚              {node: "storage-1", addr: 0x7fff..., size: 10GB}, â”‚
â”‚              {node: "storage-2", addr: 0x7ffe..., size: 10GB}  â”‚
â”‚          ],                                             â”‚
â”‚          remaining_ttl: 58s                             â”‚
â”‚      };                                                 â”‚
â”‚  }                                                      â”‚
â”‚  â†“                                                      â”‚
â”‚  è¿”å›å‰¯æœ¬åˆ—è¡¨ â†’ Client                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. é€‰æ‹©æœ€ä¼˜å‰¯æœ¬ (å°±è¿‘åŸåˆ™)                              â”‚
â”‚                                                         â”‚
â”‚  ç­–ç•¥:                                                  â”‚
â”‚    - å¦‚æœæœ¬æœºæœ‰å‰¯æœ¬ â†’ é€‰æ‹©æœ¬æœº (L1 è®¿é—®)               â”‚
â”‚    - å¦åˆ™é€‰æ‹©ç½‘ç»œæœ€è¿‘çš„å‰¯æœ¬ (L3 è·¨èŠ‚ç‚¹è®¿é—®)            â”‚
â”‚                                                         â”‚
â”‚  æœ¬ä¾‹: Worker-2 ä¸Šæ²¡æœ‰è¿™ä¸ª KV Cache                     â”‚
â”‚  â†’ é€‰æ‹© storage-1 (Worker-1) è·¨èŠ‚ç‚¹æ‹‰å–                â”‚
â”‚  â†’ è¿™æ˜¯ L3 (Mooncake å…¨å±€) è®¿é—®,éœ€è¦ RDMA ä¼ è¾“         â”‚
â”‚                                                         â”‚
â”‚  æ³¨æ„åŒºåˆ†:                                              â”‚
â”‚  - L1 æœ¬åœ°è®¿é—®: Worker-1 è®¿é—®è‡ªå·±çš„ storage â†’ 0 å»¶è¿Ÿ   â”‚
â”‚  - L3 è·¨èŠ‚ç‚¹è®¿é—®: Worker-2 è®¿é—® Worker-1 â†’ RDMA 0.4s  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Transfer Engine: RDMA Read                           â”‚
â”‚                                                         â”‚
â”‚  engine.submitTransfer({                                â”‚
â”‚      opcode: READ,                                      â”‚
â”‚      source: storage-1 @ 0x7fff...,  # è¿œç¨‹åœ°å€         â”‚
â”‚      target: GPU 1 @ 0x7f9000000000,  # æœ¬åœ° GPU        â”‚
â”‚      length: 10 GB                                      â”‚
â”‚  })                                                     â”‚
â”‚                                                         â”‚
â”‚  æ‰§è¡Œæµç¨‹:                                              â”‚
â”‚    1. å»ºç«‹ä¸ storage-1 çš„ RDMA è¿æ¥                     â”‚
â”‚    2. æäº¤ RDMA Read                                    â”‚
â”‚       storage-1 DRAM â†’ Worker-2 GPU 1                   â”‚
â”‚    3. ç­‰å¾…æ•°æ®åˆ°è¾¾                                      â”‚
â”‚                                                         â”‚
â”‚  ä¼ è¾“æ—¶é—´: 10GB Ã· 25GB/s = 0.4 ç§’                       â”‚
â”‚                                                         â”‚
â”‚  âœ… KV Cache å·²åŠ è½½åˆ° GPU 1!                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. vLLM ç»§ç»­ Decode                                     â”‚
â”‚                                                         â”‚
â”‚  cached_kv = kv_cache[0:90%]   # ä» Mooncake è·å–       â”‚
â”‚  new_tokens = tokens[90%:100%]  # æ–°å¢ 10%             â”‚
â”‚                                                         â”‚
â”‚  new_kv = model.prefill(new_tokens, past_kv=cached_kv) â”‚
â”‚  full_kv = concat(cached_kv, new_kv)                   â”‚
â”‚                                                         â”‚
â”‚  output = model.decode(full_kv)                         â”‚
â”‚                                                         â”‚
â”‚  èŠ‚çœæ—¶é—´:                                              â”‚
â”‚    - ä¼ ç»Ÿ: Prefill 100% tokens = 10 ç§’                  â”‚
â”‚    - Mooncake: Prefill 10% + RDMA ä¼ è¾“ = 1 + 0.4 = 1.4 ç§’ â”‚
â”‚    - åŠ é€Ÿæ¯”: 10 / 1.4 = 7.1x                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¡¥å……è¯´æ˜: å¤šå‰¯æœ¬å­˜å‚¨ä¸æœ¬åœ°ä¼˜å…ˆè®¿é—®**

#### 8.2.1 å¤šå‰¯æœ¬é…ç½® (replica_num=2) çš„çœŸå®åœºæ™¯

å½“é…ç½® `replica_num=2` æ—¶,åŒä¸€ä¸ª KV Cache ä¼šå­˜å‚¨åœ¨**ä¸¤ä¸ªä¸åŒçš„èŠ‚ç‚¹**ä¸Šã€‚è¿™æ˜¯ Mooncake çš„é«˜å¯ç”¨ç‰¹æ€§,ä¹Ÿæ˜¯æ€§èƒ½ä¼˜åŒ–çš„å…³é”®ã€‚

**çœŸå®æ¡ˆä¾‹: 143.30 MB çš„ KV Cache å¤šå‰¯æœ¬å­˜å‚¨**

```
Master Service å…ƒæ•°æ®:

Key: "prompt_hash_abc123"
Size: 143.30 MB
Replicas: [
    {
        node: "wntest-2:13546",
        buffers: [
            {addr: 0x7fff00000000, length: 30MB, location: "cuda:0"},
            {addr: 0x7fff01e00000, length: 28MB, location: "cuda:1"},
            {addr: 0x7fff03c00000, length: 25MB, location: "cpu"},
            {addr: 0x7fff05a00000, length: 20MB, location: "cpu"},
            {addr: 0x7fff0780000, length: 20MB, location: "cpu"}
        ],
        total_buffers: 5,
        total_size: 123 MB
    },
    {
        node: "wntets-1:13947",
        buffers: [
            {addr: 0x7ffe00000000, length: 35MB, location: "cuda:0"},
            {addr: 0x7ffe02300000, length: 32MB, location: "cuda:1"},
            {addr: 0x7ffe04600000, length: 28MB, location: "cpu"},
            {addr: 0x7ffe06800000, length: 25MB, location: "cpu"}
        ],
        total_buffers: 4,
        total_size: 120 MB
    }
]
Status: COMPLETE
Lease: 60s

è¯´æ˜:
- åŒä¸€ä»½ KV Cache åˆ†åˆ«å­˜å‚¨åœ¨ä¸¤ä¸ªèŠ‚ç‚¹ä¸Š
- æ¯ä¸ªèŠ‚ç‚¹å¯èƒ½ä½¿ç”¨ä¸åŒæ•°é‡çš„ buffer (5 vs 4)
- æ¯ä¸ªèŠ‚ç‚¹çš„ buffer åˆ†å¸ƒå¯èƒ½ä¸åŒ (GPU + CPU æ··åˆ)
- æ€»å¤§å°ç›¸åŒ (143.30 MB),ä½†åˆ†ç‰‡ç­–ç•¥å¯èƒ½ç•¥æœ‰å·®å¼‚
```

#### 8.2.2 è®¿é—®ç­–ç•¥: æœ¬åœ°ä¼˜å…ˆ (Local First)

å½“æœ‰å¤šä¸ªå‰¯æœ¬æ—¶,**LMCache ä¼šä¼˜å…ˆé€‰æ‹©æœ¬åœ°å‰¯æœ¬**,é¿å…è·¨èŠ‚ç‚¹ RDMA ä¼ è¾“ã€‚

```
è®¿é—®å†³ç­–æ ‘:

LMCache L3 æŸ¥è¯¢ KV Cache
    â†“
æŸ¥è¯¢ Master Service è·å–å‰¯æœ¬åˆ—è¡¨
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰¯æœ¬é€‰æ‹©ç­–ç•¥                         â”‚
â”‚                                      â”‚
â”‚ 1. æ£€æŸ¥æ˜¯å¦æœ‰æœ¬åœ°å‰¯æœ¬                â”‚
â”‚    if (replica.node == current_node):â”‚
â”‚        â†’ ä½¿ç”¨æœ¬åœ°å‰¯æœ¬ (L1 è®¿é—®)      â”‚
â”‚        â†’ å»¶è¿Ÿ: < 0.001s (å¾®ç§’çº§)    â”‚
â”‚        â†’ å¸¦å®½: å†…å­˜å¸¦å®½ (100+ GB/s) â”‚
â”‚                                      â”‚
â”‚ 2. å¦‚æœæœ¬åœ°æ— å‰¯æœ¬                    â”‚
â”‚    â†’ é€‰æ‹©ç½‘ç»œæœ€è¿‘çš„è¿œç¨‹å‰¯æœ¬          â”‚
â”‚    â†’ ä½¿ç”¨ RDMA ä¼ è¾“ (L3 è®¿é—®)       â”‚
â”‚    â†’ å»¶è¿Ÿ: ~0.4s                    â”‚
â”‚    â†’ å¸¦å®½: RDMA 25 GB/s             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 8.2.3 åœºæ™¯å¯¹æ¯”: æœ¬åœ°å‰¯æœ¬ vs è¿œç¨‹å‰¯æœ¬

**ã€åœºæ™¯ Aã€‘wntest-2 èŠ‚ç‚¹è®¿é—® KV Cache (æœ¬åœ°å‰¯æœ¬å‘½ä¸­)**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Node: wntest-2:13546                                    â”‚
â”‚                                                         â”‚
â”‚  è¯·æ±‚: Worker éœ€è¦ "prompt_hash_abc123"                 â”‚
â”‚                                                         â”‚
â”‚  LMCache æŸ¥æ‰¾æµç¨‹:                                      â”‚
â”‚    1. L1 (GPU æ˜¾å­˜): æœªå‘½ä¸­                             â”‚
â”‚    2. L2 (CPU å†…å­˜): æœªå‘½ä¸­                             â”‚
â”‚    3. L3 (Mooncake): æŸ¥è¯¢ Master Service                â”‚
â”‚       â†“                                                 â”‚
â”‚    Master è¿”å›å‰¯æœ¬åˆ—è¡¨:                                 â”‚
â”‚      - wntest-2:13546 (5 buffers, 123 MB) âœ“ æœ¬åœ°!      â”‚
â”‚      - wntets-1:13947 (4 buffers, 120 MB)              â”‚
â”‚       â†“                                                 â”‚
â”‚    é€‰æ‹©æœ¬åœ°å‰¯æœ¬ wntest-2:13546                          â”‚
â”‚       â†“                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ ç›´æ¥ä»æœ¬åœ° Mooncake Storage è¯»å–             â”‚      â”‚
â”‚  â”‚                                              â”‚      â”‚
â”‚  â”‚  addr: 0x7fff00000000 (cuda:0) - 30 MB      â”‚      â”‚
â”‚  â”‚  addr: 0x7fff01e00000 (cuda:1) - 28 MB      â”‚      â”‚
â”‚  â”‚  addr: 0x7fff03c00000 (cpu)    - 25 MB      â”‚      â”‚
â”‚  â”‚  addr: 0x7fff05a00000 (cpu)    - 20 MB      â”‚      â”‚
â”‚  â”‚  addr: 0x7fff07800000 (cpu)    - 20 MB      â”‚      â”‚
â”‚  â”‚                                              â”‚      â”‚
â”‚  â”‚  æ“ä½œ: memcpy() æˆ– cudaMemcpy()              â”‚      â”‚
â”‚  â”‚  å»¶è¿Ÿ: < 0.001s (å¾®ç§’çº§)                     â”‚      â”‚
â”‚  â”‚  å¸¦å®½: 100+ GB/s (PCIe/å†…å­˜å¸¦å®½)             â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                         â”‚
â”‚  âœ… è¿™æ˜¯ L1 è®¿é—®! ä¸éœ€è¦ RDMA ç½‘ç»œ!                     â”‚
â”‚  âœ… æ€§èƒ½ç­‰åŒäºæœ¬åœ°å†…å­˜/GPU è®¿é—®                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ€»è€—æ—¶: < 0.001s (å‡ ä¹ä¸º 0)
```

**ã€åœºæ™¯ Bã€‘wntets-1 èŠ‚ç‚¹è®¿é—® KV Cache (è¿œç¨‹å‰¯æœ¬,éœ€è¦ RDMA)**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Node: wntets-3:14000 (æ²¡æœ‰å‰¯æœ¬çš„ç¬¬ä¸‰ä¸ªèŠ‚ç‚¹)             â”‚
â”‚                                                         â”‚
â”‚  è¯·æ±‚: Worker éœ€è¦ "prompt_hash_abc123"                 â”‚
â”‚                                                         â”‚
â”‚  LMCache æŸ¥æ‰¾æµç¨‹:                                      â”‚
â”‚    1. L1 (GPU æ˜¾å­˜): æœªå‘½ä¸­                             â”‚
â”‚    2. L2 (CPU å†…å­˜): æœªå‘½ä¸­                             â”‚
â”‚    3. L3 (Mooncake): æŸ¥è¯¢ Master Service                â”‚
â”‚       â†“                                                 â”‚
â”‚    Master è¿”å›å‰¯æœ¬åˆ—è¡¨:                                 â”‚
â”‚      - wntest-2:13546 (5 buffers, 123 MB)              â”‚
â”‚      - wntets-1:13947 (4 buffers, 120 MB)              â”‚
â”‚       â†“                                                 â”‚
â”‚    âŒ æœ¬åœ°æ— å‰¯æœ¬! é€‰æ‹©ç½‘ç»œæœ€è¿‘çš„è¿œç¨‹å‰¯æœ¬                â”‚
â”‚    â†’ é€‰æ‹© wntets-1:13947                                â”‚
â”‚       â†“                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ é€šè¿‡ RDMA ä»è¿œç¨‹èŠ‚ç‚¹æ‹‰å–                     â”‚      â”‚
â”‚  â”‚                                              â”‚      â”‚
â”‚  â”‚  æºåœ°å€ (wntets-1:13947):                    â”‚      â”‚
â”‚  â”‚    0x7ffe00000000 (cuda:0) - 35 MB          â”‚      â”‚
â”‚  â”‚    0x7ffe02300000 (cuda:1) - 32 MB          â”‚      â”‚
â”‚  â”‚    0x7ffe04600000 (cpu)    - 28 MB          â”‚      â”‚
â”‚  â”‚    0x7ffe06800000 (cpu)    - 25 MB          â”‚      â”‚
â”‚  â”‚                                              â”‚      â”‚
â”‚  â”‚  ç›®æ ‡åœ°å€ (wntets-3, æœ¬åœ° GPU):              â”‚      â”‚
â”‚  â”‚    0x7ffd00000000                            â”‚      â”‚
â”‚  â”‚                                              â”‚      â”‚
â”‚  â”‚  æ“ä½œ: RDMA Read (4 ä¸ª buffer å¹¶è¡Œä¼ è¾“)     â”‚      â”‚
â”‚  â”‚  å»¶è¿Ÿ: 120 MB Ã· 25 GB/s â‰ˆ 0.005s            â”‚      â”‚
â”‚  â”‚  å¸¦å®½: 25 GB/s (RDMA 200 Gbps)              â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                         â”‚
â”‚  âœ… è¿™æ˜¯ L3 è®¿é—®! éœ€è¦ RDMA è·¨èŠ‚ç‚¹ä¼ è¾“                  â”‚
â”‚  âš ï¸ æ¯”æœ¬åœ°è®¿é—®æ…¢,ä½†æ¯”é‡æ–° Prefill å¿«å¾—å¤š!              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ€»è€—æ—¶: ~0.005s (5 æ¯«ç§’,å¯¹äº 120 MB)
å¯¹æ¯”é‡æ–° Prefill: ~10s â†’ èŠ‚çœ 10 / 0.005 = 2000x!
```

**ã€åœºæ™¯ Cã€‘åŒèŠ‚ç‚¹ä½†ä¸åŒ Worker è¿›ç¨‹è®¿é—®**

å³ä½¿åœ¨åŒä¸€ä¸ªç‰©ç†èŠ‚ç‚¹ä¸Š,ä¸åŒçš„ Worker è¿›ç¨‹ä¹Ÿä¼šéµå¾ªç›¸åŒçš„æŸ¥æ‰¾é€»è¾‘:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Node: wntest-2:13546                                    â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ Worker-A     â”‚          â”‚ Worker-B     â”‚            â”‚
â”‚  â”‚ (GPU 0)      â”‚          â”‚ (GPU 1)      â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚         â”‚                         â”‚                    â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                    â†“                                    â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚         â”‚ Mooncake Storage    â”‚                        â”‚
â”‚         â”‚ (æœ¬èŠ‚ç‚¹ DRAM)       â”‚                        â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                                         â”‚
â”‚  Worker-A æŸ¥æ‰¾:                                         â”‚
â”‚    L1 (Worker-A GPU 0): æœªå‘½ä¸­                          â”‚
â”‚    L2 (Worker-A CPU å†…å­˜): æœªå‘½ä¸­                       â”‚
â”‚    L3 (Mooncake): æŸ¥è¯¢ Master â†’ å‘ç°æœ¬åœ°æœ‰å‰¯æœ¬          â”‚
â”‚    â†’ ä»æœ¬åœ° Mooncake Storage è¯»å–åˆ° GPU 0               â”‚
â”‚    â†’ å»¶è¿Ÿ: < 0.001s                                     â”‚
â”‚                                                         â”‚
â”‚  Worker-B æŸ¥æ‰¾:                                         â”‚
â”‚    L1 (Worker-B GPU 1): æœªå‘½ä¸­                          â”‚
â”‚    L2 (Worker-B CPU å†…å­˜): æœªå‘½ä¸­                       â”‚
â”‚    L3 (Mooncake): æŸ¥è¯¢ Master â†’ å‘ç°æœ¬åœ°æœ‰å‰¯æœ¬          â”‚
â”‚    â†’ ä»æœ¬åœ° Mooncake Storage è¯»å–åˆ° GPU 1               â”‚
â”‚    â†’ å»¶è¿Ÿ: < 0.001s                                     â”‚
â”‚                                                         â”‚
â”‚  âœ… ä¸¤ä¸ª Worker éƒ½èµ° L1 æœ¬åœ°è®¿é—®,å…±äº«åŒä¸€ä»½å‰¯æœ¬!        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 8.2.4 å…³é”®ç†è§£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é‡è¦æ¦‚å¿µæ¾„æ¸…                                             â”‚
â”‚                                                          â”‚
â”‚ 1. L1/L2/L3 æ˜¯ LMCache çš„**é€»è¾‘å±‚çº§**:                  â”‚
â”‚    - L1: å½“å‰ Worker çš„ GPU æ˜¾å­˜                        â”‚
â”‚    - L2: å½“å‰ Worker çš„ CPU å†…å­˜                        â”‚
â”‚    - L3: Mooncake å…¨å±€åˆ†å¸ƒå¼å­˜å‚¨                        â”‚
â”‚                                                          â”‚
â”‚ 2. Mooncake æ˜¯**å…¨å±€å­˜å‚¨æ± **,ä½†è®¿é—®æ–¹å¼æœ‰ä¸¤ç§:          â”‚
â”‚    - æœ¬åœ°è®¿é—®: å¦‚æœæœ¬èŠ‚ç‚¹æœ‰å‰¯æœ¬ â†’ å†…å­˜é€Ÿåº¦              â”‚
â”‚    - è¿œç¨‹è®¿é—®: å¦‚æœæœ¬èŠ‚ç‚¹æ— å‰¯æœ¬ â†’ RDMA é€Ÿåº¦             â”‚
â”‚                                                          â”‚
â”‚ 3. å¤šå‰¯æœ¬çš„å¥½å¤„:                                         â”‚
â”‚    - é«˜å¯ç”¨: ä¸€ä¸ªèŠ‚ç‚¹æ•…éšœ,å…¶ä»–å‰¯æœ¬ä»å¯ç”¨                â”‚
â”‚    - é«˜æ€§èƒ½: å¤šä¸ªèŠ‚ç‚¹å¯å¹¶è¡Œè®¿é—®,å„ç”¨æœ¬åœ°å‰¯æœ¬            â”‚
â”‚    - è´Ÿè½½å‡è¡¡: é¿å…å•èŠ‚ç‚¹æˆä¸ºè®¿é—®çƒ­ç‚¹                   â”‚
â”‚                                                          â”‚
â”‚ 4. è®¿é—®å†³ç­–æ€»ç»“:                                         â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚    â”‚ LMCache L3 æŸ¥è¯¢ "key"                       â”‚     â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                    â†“                                    â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚    â”‚ Master Service è¿”å›å‰¯æœ¬åˆ—è¡¨                 â”‚     â”‚
â”‚    â”‚ replicas = [node1, node2, ...]              â”‚     â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                    â†“                                    â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚         â†“                     â†“                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ æœ‰æœ¬åœ°å‰¯æœ¬? â”‚      â”‚ æ— æœ¬åœ°å‰¯æœ¬  â”‚                 â”‚
â”‚  â”‚   âœ“ YES     â”‚      â”‚   âœ— NO      â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚         â†“                     â†“                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ æœ¬åœ°å†…å­˜è¯»å–â”‚      â”‚ RDMA è¿œç¨‹è¯»â”‚                 â”‚
â”‚  â”‚ < 0.001s    â”‚      â”‚ ~0.001-0.5s â”‚                 â”‚
â”‚  â”‚ (L1 è®¿é—®)   â”‚      â”‚ (L3 è®¿é—®)   â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                          â”‚
â”‚ 5. ä¸ºä»€ä¹ˆå‰é¢çš„ä¾‹å­æ˜¾ç¤º L3 = RDMA?                      â”‚
â”‚    å› ä¸ºå‰é¢çš„ä¾‹å­**ç‰¹æ„å±•ç¤ºè·¨èŠ‚ç‚¹è®¿é—®åœºæ™¯**,              â”‚
â”‚    å³ Worker-2 è®¿é—® Worker-1 å­˜å‚¨çš„æ•°æ®,                 â”‚
â”‚    Worker-2 æœ¬åœ°æ²¡æœ‰å‰¯æœ¬,æ‰€ä»¥å¿…é¡»èµ° RDMAã€‚              â”‚
â”‚                                                          â”‚
â”‚    åœ¨ replica_num=2 çš„é…ç½®ä¸‹,å¦‚æœ Worker-2 æ‰€åœ¨          â”‚
â”‚    èŠ‚ç‚¹ä¹Ÿå­˜å‚¨äº†å‰¯æœ¬,åˆ™ä¼šç›´æ¥æœ¬åœ°è®¿é—®,ä¸èµ° RDMA!          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç¬¬å››éƒ¨åˆ†:å®æˆ˜è½åœ°

### 9. éƒ¨ç½²æ¶æ„è®¾è®¡

#### 9.1 æ¨èéƒ¨ç½²æ‹“æ‰‘

**å°è§„æ¨¡éƒ¨ç½² (10-50 èŠ‚ç‚¹)**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æœºæˆ¿æ‹“æ‰‘                             â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           etcd é›†ç¾¤ (3 èŠ‚ç‚¹)                     â”‚  â”‚
â”‚  â”‚  - å…ƒæ•°æ®æŒä¹…åŒ–                                  â”‚  â”‚
â”‚  â”‚  - Master Service é€‰ä¸¾ (å¦‚å¯ç”¨ HA)               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â†•                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         Mooncake Master Service                  â”‚  â”‚
â”‚  â”‚  - å•ç‚¹éƒ¨ç½²(æˆ– HA åŒæ´»)                          â”‚  â”‚
â”‚  â”‚  - 16 æ ¸ CPU, 64 GB å†…å­˜                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â†•                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚          è®¡ç®—èŠ‚ç‚¹ (10 èŠ‚ç‚¹)                       â”‚  â”‚
â”‚  â”‚                                                   â”‚  â”‚
â”‚  â”‚  æ¯èŠ‚ç‚¹é…ç½®:                                      â”‚  â”‚
â”‚  â”‚  - 8x NVIDIA A100 80GB GPU                       â”‚  â”‚
â”‚  â”‚  - 2x Intel Xeon CPU (64 cores)                  â”‚  â”‚
â”‚  â”‚  - 512 GB DDR4 RAM                               â”‚  â”‚
â”‚  â”‚  - 2x Mellanox CX-6 200Gbps RDMA NIC            â”‚  â”‚
â”‚  â”‚  - 4 TB NVMe SSD (å¯é€‰,ç”¨äºç£ç›˜å‰¯æœ¬)             â”‚  â”‚
â”‚  â”‚                                                   â”‚  â”‚
â”‚  â”‚  è§’è‰²æ··åˆéƒ¨ç½²:                                    â”‚  â”‚
â”‚  â”‚  - vLLM Prefill Instance (ä½¿ç”¨ GPU)             â”‚  â”‚
â”‚  â”‚  - vLLM Decode Instance (ä½¿ç”¨ GPU)              â”‚  â”‚
â”‚  â”‚  - Mooncake Storage Node (ä½¿ç”¨ DRAM)            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                         â”‚
â”‚  ç½‘ç»œ:                                                  â”‚
â”‚  - 200 Gbps RDMA äº’è¿ (InfiniBand æˆ– RoCE)             â”‚
â”‚  - äº¤æ¢æœº: Mellanox Quantum Switch                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¤§è§„æ¨¡éƒ¨ç½² (100+ èŠ‚ç‚¹)**

```
åˆ†å±‚æ¶æ„:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ§åˆ¶å¹³é¢                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ etcd Cluster   â”‚  â”‚ Master Service â”‚                â”‚
â”‚  â”‚ (5-7 èŠ‚ç‚¹)     â”‚  â”‚ (HA 3 èŠ‚ç‚¹)    â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è®¡ç®—å¹³é¢ (Prefill é›†ç¾¤)                                â”‚
â”‚  - 50 èŠ‚ç‚¹,æ¯èŠ‚ç‚¹ 8x A100                               â”‚
â”‚  - ä¸“æ³¨äº Prefill è®¡ç®—                                  â”‚
â”‚  - KV Cache å†™å…¥ Mooncake                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å­˜å‚¨å¹³é¢ (Mooncake Storage)                            â”‚
â”‚  - 20 èŠ‚ç‚¹,æ¯èŠ‚ç‚¹ 1 TB DRAM + 10 TB NVMe               â”‚
â”‚  - ä¸“ç”¨å­˜å‚¨èŠ‚ç‚¹,ä¸è¿è¡Œæ¨ç†                              â”‚
â”‚  - æ€»å®¹é‡: 20 TB å†…å­˜, 200 TB ç£ç›˜                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¨ç†å¹³é¢ (Decode é›†ç¾¤)                                 â”‚
â”‚  - 50 èŠ‚ç‚¹,æ¯èŠ‚ç‚¹ 8x A100                               â”‚
â”‚  - ä¸“æ³¨äº Decode ç”Ÿæˆ                                   â”‚
â”‚  - ä» Mooncake è¯»å– KV Cache                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 9.2 ç¡¬ä»¶é€‰å‹å»ºè®®

| ç»„ä»¶ | æ¨èé…ç½® | è¯´æ˜ |
|------|---------|------|
| **GPU** | NVIDIA A100 80GB / H100 80GB | æ”¯æŒ GPUDirect RDMA |
| **CPU** | Intel Xeon Ice Lake+ / AMD EPYC Milan+ | æ”¯æŒ PCIe 4.0/5.0 |
| **å†…å­˜** | 512 GB - 2 TB DDR4/DDR5 | å­˜å‚¨èŠ‚ç‚¹éœ€è¦å¤§å†…å­˜ |
| **RDMA ç½‘å¡** | Mellanox CX-6/CX-7 (200/400 Gbps) | å¿…é¡»æ”¯æŒ GPUDirect |
| **äº¤æ¢æœº** | Mellanox Quantum / NVIDIA Spectrum-4 | æ— é˜»å¡ RDMA äº¤æ¢ |
| **å­˜å‚¨** | NVMe SSD (å¯é€‰) | ç”¨äºç£ç›˜å‰¯æœ¬,æ¨è Samsung PM9A3 |

**å…³é”®é…ç½®æ£€æŸ¥**

```bash
# 1. æ£€æŸ¥ RDMA ç½‘å¡
ibv_devinfo | grep -E "hca_id|state|link_layer"
# è¾“å‡ºåº”åŒ…å«: state: PORT_ACTIVE, link_layer: InfiniBand æˆ– Ethernet

# 2. æ£€æŸ¥ GPUDirect RDMA æ”¯æŒ
nvidia-smi topo -m
# åº”æ˜¾ç¤º GPU å’Œ RDMA ç½‘å¡çš„ PCIe æ‹“æ‰‘,æœ€å¥½åœ¨åŒä¸€ NUMA èŠ‚ç‚¹

# 3. æ£€æŸ¥ NUMA æ‹“æ‰‘
numactl --hardware
# è®°å½• CPU/GPU/NIC çš„ NUMA åˆ†å¸ƒ,ç”¨äºä¼˜åŒ–é…ç½®
```

---

### 10. ä¸ vLLM + LMCache é›†æˆ

#### 10.1 å®‰è£…ä¾èµ–

```bash
# 1. å®‰è£… Mooncake (C++ æ ¸å¿ƒ)
git clone https://github.com/kvcache-ai/Mooncake.git
cd Mooncake

# å®‰è£…ä¾èµ–
sudo apt install -y \
    libibverbs-dev \
    librdmacm-dev \
    rdma-core \
    cmake \
    build-essential

# ç¼–è¯‘
mkdir build && cd build
cmake .. -DCMAKE_BUILD_TYPE=Release
make -j$(nproc)
sudo make install

# 2. å®‰è£… LMCache
pip install lmcache

# 3. å®‰è£… vLLM (æ”¯æŒ Prefix Caching)
pip install vllm>=0.3.0
```

#### 10.2 é…ç½® etcd

```bash
# å¯åŠ¨ etcd é›†ç¾¤ (å•èŠ‚ç‚¹ç¤ºä¾‹)
docker run -d \
    --name etcd \
    --net=host \
    quay.io/coreos/etcd:v3.5.9 \
    /usr/local/bin/etcd \
    --advertise-client-urls http://0.0.0.0:2379 \
    --listen-client-urls http://0.0.0.0:2379 \
    --data-dir /etcd-data
```

#### 10.3 å¯åŠ¨ Mooncake Master Service

```bash
# master_config.json
cat > master_config.json <<EOF
{
    "rpc_port": 12347,
    "metadata_uri": "etcd://127.0.0.1:2379",
    "cluster_id": "mooncake-cluster-1",

    "kv_lease_ttl_ms": 60000,           // 60 ç§’ç§Ÿçº¦
    "kv_soft_pin_ttl_ms": 300000,       // 5 åˆ†é’Ÿè½¯é’‰ä½

    "eviction_ratio": 0.3,              // é©±é€ 30%
    "eviction_high_watermark": 0.8,     // 80% è§¦å‘é©±é€

    "enable_ha": false,                 // é«˜å¯ç”¨(å¯é€‰)
    "enable_disk_replica": false        // ç£ç›˜å‰¯æœ¬(å¯é€‰)
}
EOF

# å¯åŠ¨ Master Service
mooncake-master --config master_config.json
```

#### 10.4 å¯åŠ¨ Storage Node

```bash
# æ¯ä¸ªè®¡ç®—èŠ‚ç‚¹éƒ½éœ€è¦å¯åŠ¨ Storage Node
# (ä½¿ç”¨æœ¬åœ° DRAM ä½œä¸ºå­˜å‚¨æ± )

# storage_config.json
cat > storage_config.json <<EOF
{
    "master_uri": "127.0.0.1:12347",
    "metadata_uri": "etcd://127.0.0.1:2379",
    "local_server_name": "worker-1",
    "rpc_port": 12345,

    "segment_size": 536870912000,  // 500 GB (ä½¿ç”¨ DRAM)
    "mount_path": "/dev/shm/mooncake"  // ä½¿ç”¨å…±äº«å†…å­˜
}
EOF

# åˆ›å»ºæŒ‚è½½ç‚¹
mkdir -p /dev/shm/mooncake

# å¯åŠ¨ Storage Node
mooncake-storage --config storage_config.json
```

#### 10.5 é…ç½® LMCache

```python
# lmcache_config.yaml
chunk_size: 256  # æ¯ä¸ª chunk çš„ token æ•°

# æœ¬åœ°ç¼“å­˜é…ç½®
local_device: "cuda"
local_size: "40GB"  # L1: GPU å†…å­˜

cpu_cache_size: "100GB"  # L2: CPU å†…å­˜

# è¿œç¨‹ç¼“å­˜é…ç½® (Mooncake)
remote_backend: "mooncake"
mooncake_config:
  metadata_uri: "etcd://127.0.0.1:2379"
  local_server_name: "worker-1"
  transfer_engine_config:
    auto_discover: true  # è‡ªåŠ¨å‘ç° RDMA ç½‘å¡
    filter: []           # ç½‘å¡è¿‡æ»¤(ç•™ç©ºè¡¨ç¤ºä½¿ç”¨æ‰€æœ‰ç½‘å¡)
```

#### 10.6 å¯åŠ¨ vLLM with LMCache

**Prefill å®ä¾‹ (å†™å…¥ KV Cache)**

```python
# prefill_server.py
from vllm import LLM, SamplingParams
from lmcache import LMCacheEngine, LMCacheEngineBuilder, LMCacheEngineConfig

# 1. åˆå§‹åŒ– LMCache
cache_config = LMCacheEngineConfig.from_file("lmcache_config.yaml")
cache_engine = LMCacheEngineBuilder.get_or_create(cache_config)

# 2. åˆå§‹åŒ– vLLM
llm = LLM(
    model="Qwen/Qwen2.5-72B",
    tensor_parallel_size=8,      # 8 GPU å¹¶è¡Œ
    enable_prefix_caching=True,  # å¯ç”¨å‰ç¼€ç¼“å­˜
    cache_engine=cache_engine    # é›†æˆ LMCache
)

# 3. Prefill æ¨ç†
prompts = [
    "è¯·ç”¨ Python å®ç°å¿«é€Ÿæ’åºç®—æ³•",
    "è¯·ç”¨ Python å®ç°å¿«é€Ÿæ’åºç®—æ³•,å¹¶åŠ ä¸Šè¯¦ç»†æ³¨é‡Š",  # å‰ç¼€åŒ¹é…!
]

sampling_params = SamplingParams(
    temperature=0.7,
    max_tokens=512
)

outputs = llm.generate(prompts, sampling_params)

# KV Cache ä¼šè‡ªåŠ¨å†™å…¥ Mooncake!
for output in outputs:
    print(f"Generated: {output.outputs[0].text}")
```

**Decode å®ä¾‹ (è¯»å– KV Cache)**

```python
# decode_server.py
from vllm import LLM, SamplingParams
from lmcache import LMCacheEngine, LMCacheEngineBuilder, LMCacheEngineConfig

# 1. åˆå§‹åŒ– LMCache (ç›¸åŒé…ç½®)
cache_config = LMCacheEngineConfig.from_file("lmcache_config.yaml")
cache_engine = LMCacheEngineBuilder.get_or_create(cache_config)

# 2. åˆå§‹åŒ– vLLM
llm = LLM(
    model="Qwen/Qwen2.5-72B",
    tensor_parallel_size=8,
    enable_prefix_caching=True,
    cache_engine=cache_engine
)

# 3. Decode æ¨ç† (ä¼šä» Mooncake è¯»å– KV Cache)
prompt = "è¯·ç”¨ Python å®ç°å¿«é€Ÿæ’åºç®—æ³•,å¹¶åŠ ä¸Šè¯¦ç»†æ³¨é‡Šå’Œæ€§èƒ½åˆ†æ"

# LMCache ä¼šè‡ªåŠ¨:
# 1. æŸ¥æ‰¾å‰ç¼€ "è¯·ç”¨ Python å®ç°å¿«é€Ÿæ’åºç®—æ³•,å¹¶åŠ ä¸Šè¯¦ç»†æ³¨é‡Š"
# 2. ä» Mooncake æ‹‰å– KV Cache
# 3. åª Prefill "å’Œæ€§èƒ½åˆ†æ" éƒ¨åˆ†

outputs = llm.generate([prompt], sampling_params)
print(f"Generated: {outputs[0].outputs[0].text}")
```

#### 10.7 API Server æ¨¡å¼

```bash
# å¯åŠ¨ vLLM API Server (Prefill èŠ‚ç‚¹)
python -m vllm.entrypoints.openai.api_server \
    --model Qwen/Qwen2.5-72B \
    --tensor-parallel-size 8 \
    --enable-prefix-caching \
    --lmcache-config lmcache_config.yaml \
    --host 0.0.0.0 \
    --port 8000

# å®¢æˆ·ç«¯è°ƒç”¨
curl http://localhost:8000/v1/completions \
    -H "Content-Type: application/json" \
    -d '{
        "model": "Qwen/Qwen2.5-72B",
        "prompt": "è¯·ç”¨ Python å®ç°å¿«é€Ÿæ’åºç®—æ³•",
        "max_tokens": 512
    }'
```

---

### 11. æ€§èƒ½æµ‹è¯•ä¸è°ƒä¼˜

#### 11.1 æ€§èƒ½åŸºå‡†æµ‹è¯•

**æµ‹è¯•ç¯å¢ƒå‡†å¤‡**

```bash
# ç¡¬ä»¶é…ç½®
- GPU: 8x NVIDIA A100 80GB
- CPU: 2x Intel Xeon Platinum 8358 (64 cores)
- å†…å­˜: 1 TB DDR4
- ç½‘ç»œ: 2x Mellanox CX-6 200Gbps RDMA NIC
- å­˜å‚¨: æ¯èŠ‚ç‚¹ 512 GB DRAM ç”¨äº Mooncake

# è½¯ä»¶ç‰ˆæœ¬
- vLLM: v0.3.0
- LMCache: latest
- Mooncake: v1.0
- æ¨¡å‹: Qwen/Qwen2.5-72B
```

**æµ‹è¯•åœºæ™¯è®¾è®¡**

```python
# benchmark.py - æµ‹è¯•æ¡†æ¶
import time
import numpy as np
from vllm import LLM, SamplingParams

# åˆå§‹åŒ–
llm = LLM(
    model="Qwen/Qwen2.5-72B",
    tensor_parallel_size=8,
    enable_prefix_caching=True
)

# ========== åœºæ™¯ 1: å¤šè½®å¯¹è¯ (æ¸è¿›å¼å‰ç¼€åŒ¹é…) ==========
def test_multi_turn_conversation():
    """
    æµ‹è¯•ç›®æ ‡: éªŒè¯å¤šè½®å¯¹è¯ä¸­çš„ KV Cache å¤ç”¨æ•ˆæœ
    é¢„æœŸ: éšç€å¯¹è¯è½®æ¬¡å¢åŠ ,å‰ç¼€åŒ¹é…ç‡æå‡,åŠ é€Ÿæ¯”é€’å¢
    """
    base_prompt = "ä½ æ˜¯ä¸€ä¸ªAIåŠ©æ‰‹ã€‚ç”¨æˆ·é—®é¢˜: "
    questions = [
        "ä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½?",
        "ä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½? å®ƒæœ‰å“ªäº›åº”ç”¨?",
        "ä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½? å®ƒæœ‰å“ªäº›åº”ç”¨? å…·ä½“è¯´è¯´åŒ»ç–—é¢†åŸŸã€‚",
        "ä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½? å®ƒæœ‰å“ªäº›åº”ç”¨? å…·ä½“è¯´è¯´åŒ»ç–—é¢†åŸŸã€‚æœ‰å“ªäº›æˆåŠŸæ¡ˆä¾‹?",
    ]

    prompts = [base_prompt + q for q in questions]

    # Warm-up
    _ = llm.generate([prompts[0]], SamplingParams(max_tokens=1))

    # æµ‹è¯•
    results = []
    for i, prompt in enumerate(prompts):
        start = time.time()
        output = llm.generate([prompt], SamplingParams(max_tokens=512))
        elapsed = time.time() - start

        token_count = len(output[0].outputs[0].token_ids)
        throughput = token_count / elapsed

        results.append({
            "round": i + 1,
            "input_tokens": len(llm.get_tokenizer().encode(prompt)),
            "output_tokens": token_count,
            "time": elapsed,
            "throughput": throughput
        })

        print(f"Round {i+1}: {elapsed:.2f}s, {throughput:.2f} tokens/s")

    # åˆ†æå‰ç¼€ç¼“å­˜æ•ˆæœ
    print("\n=== Prefix Caching Analysis ===")
    for i in range(1, len(results)):
        prev = results[i-1]
        curr = results[i]
        speedup = prev["time"] / curr["time"]
        print(f"Round {i} â†’ {i+1}: {speedup:.2f}x speedup")

    return results

# ========== åœºæ™¯ 2: RAG æ–‡æ¡£é—®ç­” ==========
def test_rag_qa():
    """
    æµ‹è¯•ç›®æ ‡: éªŒè¯ RAG åœºæ™¯ä¸‹é•¿ Context çš„å¤ç”¨æ•ˆæœ
    é¢„æœŸ: Context éƒ¨åˆ† KV Cache å®Œå…¨å¤ç”¨,åªéœ€ Prefill ç”¨æˆ·é—®é¢˜
    """
    # TODO: æ›¿æ¢ä¸ºæ‚¨çš„çœŸå® RAG Context
    long_context = """
    [è¿™é‡Œæ”¾ç½®æ‚¨çš„çœŸå®æ–‡æ¡£å†…å®¹,ä¾‹å¦‚å…¬å¸å†…éƒ¨æŠ€æœ¯æ–‡æ¡£]
    é•¿åº¦å»ºè®®: 5000-10000 tokens
    """

    questions = [
        "é—®é¢˜ 1: [æ‚¨çš„çœŸå®é—®é¢˜]",
        "é—®é¢˜ 2: [æ‚¨çš„çœŸå®é—®é¢˜]",
        "é—®é¢˜ 3: [æ‚¨çš„çœŸå®é—®é¢˜]",
    ]

    results = []
    for i, question in enumerate(questions):
        prompt = long_context + "\nç”¨æˆ·é—®é¢˜: " + question
        # ... æµ‹è¯•é€»è¾‘åŒä¸Š

    return results

# è¿è¡Œæµ‹è¯•
if __name__ == "__main__":
    print("=" * 60)
    print("Mooncake æ€§èƒ½åŸºå‡†æµ‹è¯•")
    print("=" * 60)

    print("\nã€åœºæ™¯ 1ã€‘å¤šè½®å¯¹è¯æµ‹è¯•")
    multi_turn_results = test_multi_turn_conversation()

    # print("\nã€åœºæ™¯ 2ã€‘RAG é—®ç­”æµ‹è¯•")
    # rag_results = test_rag_qa()
```

**é¢„æœŸç»“æœä¸å®é™…ç»“æœå¯¹æ¯”**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            åœºæ™¯ 1: å¤šè½®å¯¹è¯æ€§èƒ½æµ‹è¯•                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æµ‹è¯•é…ç½®:                                                  â”‚
â”‚ - æ¨¡å‹: Qwen2.5-72B                                        â”‚
â”‚ - GPU: 8x A100 (Tensor Parallel)                          â”‚
â”‚ - åŸºç¡€ Prompt: 50 tokens                                   â”‚
â”‚ - è¾“å‡ºé•¿åº¦: 512 tokens                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€é¢„æœŸç»“æœã€‘(ç†è®ºè®¡ç®—)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Round â”‚ Input    â”‚ è€—æ—¶(s)  â”‚ ååé‡   â”‚ åŠ é€Ÿæ¯”     â”‚
â”‚       â”‚ Tokens   â”‚          â”‚ (tok/s)  â”‚            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1     â”‚  100     â”‚  5.2     â”‚  98.5    â”‚ 1.0x       â”‚
â”‚ 2     â”‚  300     â”‚  2.1     â”‚ 243.8    â”‚ 2.5x       â”‚
â”‚ 3     â”‚  500     â”‚  1.4     â”‚ 365.7    â”‚ 3.7x       â”‚
â”‚ 4     â”‚  700     â”‚  1.1     â”‚ 465.5    â”‚ 4.7x       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€å®é™…ç»“æœã€‘(TODO: è¯·å¡«å†™æ‚¨çš„æµ‹è¯•æ•°æ®)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Round â”‚ Input    â”‚ è€—æ—¶(s)  â”‚ ååé‡   â”‚ åŠ é€Ÿæ¯”     â”‚
â”‚       â”‚ Tokens   â”‚          â”‚ (tok/s)  â”‚            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1     â”‚          â”‚          â”‚          â”‚            â”‚
â”‚ 2     â”‚          â”‚          â”‚          â”‚            â”‚
â”‚ 3     â”‚          â”‚          â”‚          â”‚            â”‚
â”‚ 4     â”‚          â”‚          â”‚          â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åˆ†æè¯´æ˜:
- Round 1: æ— ç¼“å­˜å‘½ä¸­,å®Œæ•´ Prefill
- Round 2+: å‰ç¼€éƒ¨åˆ†å‘½ä¸­ Mooncake,åªéœ€ Prefill æ–°å¢å†…å®¹
- åŠ é€Ÿæ¯”: å®é™…è€—æ—¶ / Round 1 è€—æ—¶
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            åœºæ™¯ 2: RAG æ–‡æ¡£é—®ç­”æ€§èƒ½æµ‹è¯•                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æµ‹è¯•é…ç½®:                                                  â”‚
â”‚ - Context é•¿åº¦: [TODO: å¡«å†™å®é™…é•¿åº¦] tokens               â”‚
â”‚ - ç”¨æˆ·é—®é¢˜é•¿åº¦: ~100 tokens                                â”‚
â”‚ - è¾“å‡ºé•¿åº¦: 512 tokens                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€é¢„æœŸç»“æœã€‘
Context éƒ¨åˆ† KV Cache å®Œå…¨å¤ç”¨,å“åº”æ—¶é—´é™ä½ 70-85%

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æµ‹è¯•é¡¹        â”‚ ä¼ ç»Ÿæ–¹å¼ â”‚ Mooncake â”‚ æå‡       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Prefill æ—¶é—´  â”‚ 10.0s    â”‚  1.5s    â”‚ 6.7x       â”‚
â”‚ RDMA ä¼ è¾“     â”‚ N/A      â”‚  0.4s    â”‚ -          â”‚
â”‚ æ€»å“åº”æ—¶é—´    â”‚ 10.0s    â”‚  1.9s    â”‚ 5.3x       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€å®é™…ç»“æœã€‘(TODO: è¯·å¡«å†™æ‚¨çš„æµ‹è¯•æ•°æ®)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æµ‹è¯•é¡¹        â”‚ ä¼ ç»Ÿæ–¹å¼ â”‚ Mooncake â”‚ æå‡       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Prefill æ—¶é—´  â”‚          â”‚          â”‚            â”‚
â”‚ RDMA ä¼ è¾“     â”‚ N/A      â”‚          â”‚            â”‚
â”‚ æ€»å“åº”æ—¶é—´    â”‚          â”‚          â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            åœºæ™¯ 3: [æ‚¨çš„çœŸå®ä¸šåŠ¡åœºæ™¯]                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åœºæ™¯æè¿°: [TODO: æè¿°æ‚¨çš„å®é™…åº”ç”¨åœºæ™¯]                     â”‚
â”‚                                                            â”‚
â”‚ ä¸šåŠ¡ç‰¹å¾:                                                  â”‚
â”‚ - æ—¥å‡è¯·æ±‚é‡: [TODO]                                       â”‚
â”‚ - å¹³å‡ Prompt é•¿åº¦: [TODO] tokens                          â”‚
â”‚ - é‡å¤ç‡: [TODO]%                                          â”‚
â”‚ - å¹¶å‘é‡: [TODO] QPS                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€æµ‹è¯•ç»“æœã€‘(TODO: è¯·å¡«å†™æ‚¨çš„æµ‹è¯•æ•°æ®)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æŒ‡æ ‡            â”‚ ä¼ ç»Ÿæ–¹å¼ â”‚ Mooncake â”‚ æå‡     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¹³å‡å“åº”æ—¶é—´    â”‚          â”‚          â”‚          â”‚
â”‚ P99 å“åº”æ—¶é—´    â”‚          â”‚          â”‚          â”‚
â”‚ ååé‡ (QPS)    â”‚          â”‚          â”‚          â”‚
â”‚ GPU åˆ©ç”¨ç‡      â”‚          â”‚          â”‚          â”‚
â”‚ ç¼“å­˜å‘½ä¸­ç‡      â”‚ N/A      â”‚          â”‚ -        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æˆæœ¬åˆ†æ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æˆæœ¬é¡¹          â”‚ ä¼ ç»Ÿæ–¹å¼ â”‚ Mooncake â”‚ èŠ‚çœ     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ GPU æ•°é‡        â”‚          â”‚          â”‚          â”‚
â”‚ å†…å­˜æˆæœ¬ (DRAM) â”‚ N/A      â”‚          â”‚ +        â”‚
â”‚ æ€»æˆæœ¬ ($/æœˆ)   â”‚          â”‚          â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ROI åˆ†æ:
- ä¸€æ¬¡æ€§æŠ•å…¥: [TODO] (DRAM + RDMA ç½‘å¡)
- æœˆåº¦èŠ‚çœ: [TODO] (GPU ç§Ÿèµæˆæœ¬)
- å›æœ¬å‘¨æœŸ: [TODO] ä¸ªæœˆ
```

#### 11.2 æ€§èƒ½è°ƒä¼˜å‚æ•°

**Mooncake Master Service è°ƒä¼˜**

```json
{
    // ç§Ÿçº¦æ—¶é—´è°ƒæ•´ (æ ¹æ®å®é™…è®¿é—®æ¨¡å¼)
    "kv_lease_ttl_ms": 60000,        // é»˜è®¤ 60s
    // - é«˜é¢‘è®¿é—®åœºæ™¯: å¢åŠ åˆ° 300s (5 åˆ†é’Ÿ)
    // - ä½é¢‘è®¿é—®åœºæ™¯: é™ä½åˆ° 30s

    "kv_soft_pin_ttl_ms": 300000,    // é»˜è®¤ 5 åˆ†é’Ÿ
    // - ç³»ç»Ÿ prompt ç­‰ VIP å¯¹è±¡: å¢åŠ åˆ° 3600s (1 å°æ—¶)

    // é©±é€ç­–ç•¥è°ƒæ•´
    "eviction_ratio": 0.3,           // æ¯æ¬¡é©±é€ 30%
    "eviction_high_watermark": 0.8,  // 80% è§¦å‘
    // - å†…å­˜å……è¶³: æé«˜æ°´ä½çº¿åˆ° 0.9
    // - å†…å­˜ç´§å¼ : é™ä½æ°´ä½çº¿åˆ° 0.7

    // åˆ†ç‰‡æ•°è°ƒæ•´ (é»˜è®¤ 1024)
    "num_shards": 1024,
    // - é«˜å¹¶å‘åœºæ™¯: å¢åŠ åˆ° 2048 æˆ– 4096
    // - ä½å¹¶å‘åœºæ™¯: é™ä½åˆ° 512 ä»¥èŠ‚çœå†…å­˜
}
```

**Transfer Engine è°ƒä¼˜**

```python
# åœ¨ lmcache_config.yaml ä¸­æ·»åŠ 
mooncake_config:
  transfer_engine_config:
    # RDMA ç½‘å¡é€‰æ‹©
    auto_discover: true
    filter: ["mlx5_0", "mlx5_1"]  # åªä½¿ç”¨æŒ‡å®šç½‘å¡

    # æ‰¹é‡ä¼ è¾“ä¼˜åŒ–
    batch_size: 16            # æ‰¹é‡ä¼ è¾“å¤§å°
    max_inflight_batches: 32  # æœ€å¤§å¹¶å‘æ‰¹æ¬¡

    # æ‹“æ‰‘æ„ŸçŸ¥ä¼˜åŒ–
    enable_topology_aware_routing: true
    numa_binding: true        # ç»‘å®šåˆ° NUMA èŠ‚ç‚¹
```

**vLLM Prefix Caching è°ƒä¼˜**

```python
llm = LLM(
    model="Qwen/Qwen2.5-72B",

    # Prefix Caching å‚æ•°
    enable_prefix_caching=True,
    prefix_cache_hit_rate_threshold=0.8,  # å‘½ä¸­ç‡é˜ˆå€¼ 80%

    # Block Manager å‚æ•°
    block_size=16,              # æ¯ä¸ª block çš„ token æ•°
    gpu_memory_utilization=0.9, # GPU æ˜¾å­˜åˆ©ç”¨ç‡

    # Tensor Parallel
    tensor_parallel_size=8,     # 8 GPU å¹¶è¡Œ

    # é›†æˆ LMCache
    cache_engine=cache_engine
)
```

#### 11.3 ç›‘æ§ä¸è¯Šæ–­

**Mooncake æŒ‡æ ‡ç›‘æ§**

```bash
# æŸ¥è¯¢ Master Service ç»Ÿè®¡ä¿¡æ¯
curl http://localhost:12347/metrics

# è¾“å‡ºç¤ºä¾‹:
# mooncake_total_keys: 12543
# mooncake_total_size_bytes: 1342177280000  // 1.2 TB
# mooncake_cache_hit_rate: 0.85
# mooncake_eviction_count: 234
# mooncake_avg_lease_ttl_ms: 45000
```

**æ€§èƒ½åˆ†æå·¥å…·**

```python
# profiling.py
from lmcache.profiling import LMCacheProfiler

# å¯ç”¨ Profiling
profiler = LMCacheProfiler(cache_engine)

with profiler.profile():
    outputs = llm.generate(prompts, sampling_params)

# è¾“å‡ºç»Ÿè®¡
stats = profiler.get_stats()
print(f"L1 (GPU) hit rate: {stats['l1_hit_rate']:.2%}")
print(f"L2 (CPU) hit rate: {stats['l2_hit_rate']:.2%}")
print(f"L3 (Mooncake) hit rate: {stats['l3_hit_rate']:.2%}")
print(f"Avg fetch time (L3): {stats['l3_avg_fetch_ms']:.2f} ms")
```

**RDMA æ€§èƒ½æµ‹è¯•**

```bash
# ä½¿ç”¨ ib_send_bw æµ‹è¯• RDMA å¸¦å®½
# æœåŠ¡ç«¯
ib_send_bw --use_cuda=0

# å®¢æˆ·ç«¯ (å¦ä¸€å°æœºå™¨)
ib_send_bw --use_cuda=0 <server_ip>

# é¢„æœŸè¾“å‡º:
# 23.5 GB/s (æ¥è¿‘ç†è®º 25 GB/s)
```

---

### 12. Mooncake vs Dynamoï¼šæŠ€æœ¯å¯¹æ¯”

#### 12.1 é¡¹ç›®å®šä½å·®å¼‚

| ç»´åº¦ | Mooncake | Dynamo |
|------|----------|--------|
| **æ ¸å¿ƒå®šä½** | KV Cache åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿ | æ•°æ®ä¸­å¿ƒçº§æ¨ç†ç¼–æ’æ¡†æ¶ |
| **ä¸»è¦èŒè´£** | å­˜å‚¨ + ä¼ è¾“ KV Cache | è¯·æ±‚è·¯ç”± + è´Ÿè½½å‡è¡¡ + KV Cache ç¼–æ’ |
| **æŠ½è±¡å±‚çº§** | åº•å±‚å­˜å‚¨åŸºç¡€è®¾æ–½ | ä¸Šå±‚æœåŠ¡ç¼–æ’å¹³å° |
| **ç‹¬ç«‹æ€§** | å¯ç‹¬ç«‹ä½¿ç”¨ï¼Œä½œä¸ºå­˜å‚¨å±‚ | éœ€è¦é…åˆæ¨ç†å¼•æ“ï¼ˆvLLM/SGLang/TRT-LLMï¼‰ |

**ç®€å•ç±»æ¯”**ï¼š
- **Mooncake** = åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿï¼ˆå¦‚ Cephã€GlusterFSï¼‰ï¼Œä¸“æ³¨æ•°æ®å­˜å‚¨å’Œä¼ è¾“
- **Dynamo** = å®¹å™¨ç¼–æ’å¹³å°ï¼ˆå¦‚ Kubernetesï¼‰ï¼Œä¸“æ³¨æœåŠ¡è°ƒåº¦å’Œåè°ƒ

#### 12.2 æŠ€æœ¯æ¶æ„å¯¹æ¯”

**Mooncake æ¶æ„**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Mooncake                        â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Master Service (etcd)                 â”‚     â”‚
â”‚  â”‚  - å…ƒæ•°æ®ç®¡ç†                           â”‚     â”‚
â”‚  â”‚  - å‰¯æœ¬åˆ†é…                             â”‚     â”‚
â”‚  â”‚  - Lease ç®¡ç†                           â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                      â†•                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Storage Nodes (DRAM Pool)             â”‚     â”‚
â”‚  â”‚  - å­˜å‚¨ KV Cache                        â”‚     â”‚
â”‚  â”‚  - LRU Eviction                         â”‚     â”‚
â”‚  â”‚  - å‰¯æœ¬ç®¡ç†                             â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                      â†•                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Transfer Engine (RDMA/TCP/NVMe-oF)    â”‚     â”‚
â”‚  â”‚  - é›¶æ‹·è´ä¼ è¾“                           â”‚     â”‚
â”‚  â”‚  - GPUDirect RDMA                       â”‚     â”‚
â”‚  â”‚  - æ‹“æ‰‘æ„ŸçŸ¥è·¯ç”±                         â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Dynamo æ¶æ„**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Dynamo                         â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Frontend (Rust HTTP Server)           â”‚     â”‚
â”‚  â”‚  - OpenAI API å…¼å®¹                      â”‚     â”‚
â”‚  â”‚  - è¯·æ±‚é¢„å¤„ç†                           â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                      â†•                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Router + Planner                      â”‚     â”‚
â”‚  â”‚  - KV-Aware Routing                    â”‚     â”‚
â”‚  â”‚  - Load/SLA-Based Scheduling           â”‚     â”‚
â”‚  â”‚  - Conditional Disaggregation          â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                      â†•                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  NATS Jetstream (æ¶ˆæ¯é˜Ÿåˆ—)             â”‚     â”‚
â”‚  â”‚  - è¯·æ±‚åˆ†å‘                             â”‚     â”‚
â”‚  â”‚  - æ¶ˆæ¯æŒä¹…åŒ–                           â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                      â†•                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Backend Workers                       â”‚     â”‚
â”‚  â”‚  - vLLM Instances                      â”‚     â”‚
â”‚  â”‚  - SGLang Instances                    â”‚     â”‚
â”‚  â”‚  - TensorRT-LLM Instances              â”‚     â”‚
â”‚  â”‚  (æ¯ä¸ªå¼•æ“æœ‰è‡ªå·±çš„ KV Cache ç®¡ç†)       â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  NIXL (åŠ é€Ÿä¼ è¾“å±‚)                      â”‚     â”‚
â”‚  â”‚  - GPU é—´é«˜é€Ÿé€šä¿¡                       â”‚     â”‚
â”‚  â”‚  - è·¨èŠ‚ç‚¹æ•°æ®ä¼ è¾“                       â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 12.3 KV Cache ç®¡ç†ç­–ç•¥å¯¹æ¯”

| ç‰¹æ€§ | Mooncake | Dynamo |
|------|----------|--------|
| **å­˜å‚¨å±‚** | ç‹¬ç«‹çš„åˆ†å¸ƒå¼å­˜å‚¨æ± ï¼ˆDRAM/NVMeï¼‰ | ä¾èµ–æ¨ç†å¼•æ“è‡ªèº«çš„ Cache ç®¡ç† |
| **å­˜å‚¨å®¹é‡** | TB çº§ï¼ˆä¸“ç”¨å­˜å‚¨èŠ‚ç‚¹ï¼‰ | GB-ç™¾ GB çº§ï¼ˆå— GPU èŠ‚ç‚¹å†…å­˜é™åˆ¶ï¼‰ |
| **è·¨èŠ‚ç‚¹å…±äº«** | âœ… åŸç”Ÿæ”¯æŒï¼Œä»»æ„èŠ‚ç‚¹å¯è®¿é—® | âš ï¸ é€šè¿‡è·¯ç”±å®ç°ï¼Œéœ€è¦è¯·æ±‚è½¬å‘ |
| **å‰¯æœ¬ç­–ç•¥** | å¤šå‰¯æœ¬å­˜å‚¨ï¼ˆreplica_num=2/3ï¼‰ | ä¾èµ–å¼•æ“è‡ªèº«æœºåˆ¶ |
| **Eviction** | Near-LRU + TTL Lease | ä¾èµ–å¼•æ“ï¼ˆå¦‚ vLLM PagedAttentionï¼‰ |
| **æŒä¹…åŒ–** | å¯é€‰ NVMe æŒä¹…åŒ– | å†…å­˜ä¸ºä¸» |

**å…³é”®åŒºåˆ«**ï¼š

1. **Mooncake**ï¼š
```python
# Mooncake å°† KV Cache å­˜å‚¨åœ¨å¤–éƒ¨
# ä»»ä½• Worker éƒ½å¯ä»¥é€šè¿‡ RDMA è®¿é—®

Worker-1:
  prefill() â†’ ç”Ÿæˆ KV Cache â†’ å­˜åˆ° Mooncake Storage Node-A

Worker-2 (å¦ä¸€å°æœºå™¨):
  decode() â†’ ä» Mooncake Storage Node-A è¯»å– KV Cache (RDMA)
  â†’ æ— éœ€ Worker-1 å‚ä¸!
```

2. **Dynamo**ï¼š
```python
# Dynamo çš„ KV Cache å­˜åœ¨å„ä¸ª Worker æœ¬åœ°
# é€šè¿‡è·¯ç”±å°†è¯·æ±‚å‘åˆ°æœ‰ Cache çš„ Worker

Worker-1:
  prefill() â†’ ç”Ÿæˆ KV Cache â†’ å­˜åœ¨ Worker-1 GPU/å†…å­˜

æ–°è¯·æ±‚éœ€è¦è¿™ä¸ª Cache:
  Router â†’ æŸ¥è¯¢ KVBM â†’ å‘ç° Worker-1 æœ‰ Cache
  â†’ å°†è¯·æ±‚è·¯ç”±åˆ° Worker-1 å¤„ç†
  â†’ Worker-1 å¿…é¡»å‚ä¸å¤„ç†!
```

#### 12.4 ç½‘ç»œä¼ è¾“å¯¹æ¯”

| æŠ€æœ¯ | Mooncake | Dynamo |
|------|----------|--------|
| **ä¼ è¾“åè®®** | RDMA (InfiniBand/RoCE) | NIXL (NVIDIA ä¸“æœ‰) |
| **é›¶æ‹·è´** | âœ… GPUDirect RDMA | âœ… NIXL åŠ é€Ÿ |
| **å¸¦å®½** | 200 Gbps (CX-6) / 400 Gbps (CX-7) | å–å†³äº NIXL å®ç° |
| **å»¶è¿Ÿ** | 1-2 us (RDMA) | æœªå…¬å¼€è¯¦ç»†æ•°æ® |
| **ç¡¬ä»¶ä¾èµ–** | Mellanox/NVIDIA RDMA ç½‘å¡ | NVIDIA GPU + ç½‘ç»œæ ˆ |
| **è·¨æ•°æ®ä¸­å¿ƒ** | âš ï¸ RDMA å¯¹ç½‘ç»œè¦æ±‚é«˜ | âš ï¸ NIXL è·¨ DC èƒ½åŠ›æœªçŸ¥ |

#### 12.5 éƒ¨ç½²ä¸é›†æˆå¯¹æ¯”

| ç»´åº¦ | Mooncake | Dynamo |
|------|----------|--------|
| **éƒ¨ç½²å¤æ‚åº¦** | ä¸­ç­‰ï¼ˆéœ€è¦ç‹¬ç«‹ Storage èŠ‚ç‚¹ + etcdï¼‰ | ä¸­ç­‰ï¼ˆéœ€è¦ NATS + etcd + Frontendï¼‰ |
| **æ¨ç†å¼•æ“** | é€šè¿‡ LMCache é›†æˆï¼ˆvLLM/SGLangï¼‰ | åŸç”Ÿé›†æˆï¼ˆvLLM/SGLang/TRT-LLMï¼‰ |
| **K8s æ”¯æŒ** | âœ… å¯éƒ¨ç½²åœ¨ K8s | âœ… æä¾› K8s å¿«é€Ÿå…¥é—¨ |
| **äº‘åŸç”Ÿ** | âš ï¸ RDMA åœ¨äº‘ä¸Šæ”¯æŒæœ‰é™ | âœ… æ›´çµæ´»ï¼Œå¯ç”¨ TCP fallback |
| **è¿ç»´æˆæœ¬** | é«˜ï¼ˆéœ€è¦ä¸“ä¸šç½‘ç»œè¿ç»´ï¼‰ | ä¸­ï¼ˆä¾èµ–æ¨ç†å¼•æ“è¿ç»´ï¼‰ |

#### 12.6 ä½¿ç”¨åœºæ™¯å»ºè®®

**é€‰æ‹© Mooncake çš„åœºæ™¯**ï¼š

```
âœ… é€‚ç”¨åœºæ™¯:
1. æœ‰ä¸“ç”¨ GPU é›†ç¾¤ï¼Œç½‘ç»œæ¡ä»¶å¥½ï¼ˆRDMA å¯ç”¨ï¼‰
2. KV Cache å¤ç”¨ç‡æé«˜ï¼ˆå¦‚å®¢æœã€FAQï¼‰
3. éœ€è¦å¤§å®¹é‡ Cache æ± ï¼ˆTB çº§ï¼‰
4. PD å®Œå…¨åˆ†ç¦»æ¶æ„ï¼ˆPrefill å’Œ Decode åœ¨ä¸åŒèŠ‚ç‚¹ï¼‰
5. è¿½æ±‚æè‡´çš„è·¨èŠ‚ç‚¹ Cache å…±äº«æ€§èƒ½

âŒ ä¸é€‚ç”¨åœºæ™¯:
1. äº‘ä¸Šç¯å¢ƒï¼Œæ²¡æœ‰ RDMA æ”¯æŒ
2. å¤šç§Ÿæˆ·ç¯å¢ƒï¼Œç½‘ç»œéš”ç¦»ä¸¥æ ¼
3. Cache å¤ç”¨ç‡ä½ï¼ˆæ¯ä¸ªè¯·æ±‚éƒ½æ˜¯æ–°çš„ï¼‰
4. è¿ç»´å›¢é˜Ÿä¸ç†Ÿæ‚‰ RDMA ç½‘ç»œ
```

**é€‰æ‹© Dynamo çš„åœºæ™¯**ï¼š

```
âœ… é€‚ç”¨åœºæ™¯:
1. éœ€è¦ç»Ÿä¸€çš„æ¨ç†æœåŠ¡ç¼–æ’å¹³å°
2. å¤šæ¨¡å‹ã€å¤šå¼•æ“æ··åˆéƒ¨ç½²
3. å¤æ‚çš„è´Ÿè½½å‡è¡¡å’Œ SLA ä¿è¯éœ€æ±‚
4. äº‘åŸç”Ÿç¯å¢ƒï¼ŒK8s ç®¡ç†
5. éœ€è¦ PD åˆ†ç¦»ä½†ä¸æƒ³ç®¡ç†ç‹¬ç«‹å­˜å‚¨å±‚

âŒ ä¸é€‚ç”¨åœºæ™¯:
1. åªéœ€è¦ç®€å•çš„æ¨ç†æœåŠ¡ï¼ˆç”¨ vLLM è‡ªå¸¦ API å³å¯ï¼‰
2. ä¸éœ€è¦è·¨èŠ‚ç‚¹ KV Cache å…±äº«
3. å›¢é˜Ÿä¸ç†Ÿæ‚‰ NATS/etcd ç­‰ç»„ä»¶
4. è¿½æ±‚æç®€æ¶æ„
```

#### 12.7 ç»„åˆä½¿ç”¨çš„å¯èƒ½æ€§

**Dynamo + Mooncake ç»„åˆæ¶æ„**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Dynamo                         â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Frontend + Router + NATS                â”‚      â”‚
â”‚  â”‚  (è¯·æ±‚ç¼–æ’ã€è´Ÿè½½å‡è¡¡)                     â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                      â†•                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  vLLM Workers (Prefill é›†ç¾¤)              â”‚      â”‚
â”‚  â”‚  - ç”Ÿæˆ KV Cache                          â”‚      â”‚
â”‚  â”‚  - å†™å…¥ Mooncake â†“                        â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  vLLM Workers (Decode é›†ç¾¤)               â”‚      â”‚
â”‚  â”‚  - ä» Mooncake è¯»å– KV Cache â†‘            â”‚      â”‚
â”‚  â”‚  - ç”Ÿæˆè¾“å‡º                               â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Mooncake                          â”‚
â”‚  (æä¾›å¤§å®¹é‡ã€é«˜æ€§èƒ½çš„ KV Cache å­˜å‚¨æ± )              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜åŠ¿:
- Dynamo æä¾›æœåŠ¡ç¼–æ’å’Œè´Ÿè½½å‡è¡¡
- Mooncake æä¾›å¤§å®¹é‡é«˜æ€§èƒ½ KV Cache å­˜å‚¨
- ç»“åˆä¸¤è€…ä¼˜åŠ¿
```

#### 12.8 æ€»ç»“å¯¹æ¯”è¡¨

| å¯¹æ¯”é¡¹ | Mooncake | Dynamo |
|--------|----------|--------|
| **æ ¸å¿ƒä»·å€¼** | ä¸“æ³¨ KV Cache å­˜å‚¨å’Œä¼ è¾“ | ä¸“æ³¨æ¨ç†æœåŠ¡ç¼–æ’ |
| **æŠ€æœ¯éš¾ç‚¹** | RDMA ç½‘ç»œä¼˜åŒ– | å¤šå¼•æ“ç»Ÿä¸€è°ƒåº¦ |
| **å­¦ä¹ æ›²çº¿** | é™¡ï¼ˆéœ€è¦ç½‘ç»œçŸ¥è¯†ï¼‰ | ä¸­ï¼ˆéœ€è¦åˆ†å¸ƒå¼ç³»ç»ŸçŸ¥è¯†ï¼‰ |
| **æ€§èƒ½ä¸Šé™** | æé«˜ï¼ˆRDMA ç¡¬ä»¶åŠ é€Ÿï¼‰ | é«˜ï¼ˆä¾èµ–å¼•æ“æ€§èƒ½ï¼‰ |
| **çµæ´»æ€§** | ä½ï¼ˆç»‘å®š RDMAï¼‰ | é«˜ï¼ˆæ”¯æŒå¤šå¼•æ“ï¼‰ |
| **ç¤¾åŒºæ´»è·ƒåº¦** | ä¸­ï¼ˆKVCache.AIï¼‰ | é«˜ï¼ˆNVIDIA å®˜æ–¹ï¼‰ |
| **ç”Ÿäº§å°±ç»ª** | âœ… | âœ… |

---

### 13. å¤šé›†ç¾¤è·¨äº‘ K8s ç¯å¢ƒä¸‹çš„å·¥ç¨‹è½åœ°

> **ä¸šåŠ¡èƒŒæ™¯**ï¼šå…¬å¸é‡‡ç”¨å¤šé›†ç¾¤æ¶æ„ï¼Œåˆ†å¸ƒåœ¨ä¸åŒäº‘å‚å•†ï¼ˆé˜¿é‡Œäº‘ã€AWSã€åä¸ºäº‘ï¼‰ï¼Œä½¿ç”¨ K8s ç®¡ç†ã€‚éœ€è¦å®ç° Prefill-Decode åˆ†ç¦» + KVCache å…±äº«çš„æ¨ç†æ¶æ„ã€‚

#### 13.1 ä¸šåŠ¡åœºæ™¯åˆ†æ

**å½“å‰ç¯å¢ƒ**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           å…¬å¸å¤šäº‘å¤šé›†ç¾¤æ¶æ„                          â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  é˜¿é‡Œäº‘ K8s      â”‚  â”‚  AWS EKS         â”‚        â”‚
â”‚  â”‚  - Cluster-A     â”‚  â”‚  - Cluster-B     â”‚        â”‚
â”‚  â”‚  - 8x A100 èŠ‚ç‚¹  â”‚  â”‚  - 10x A100 èŠ‚ç‚¹ â”‚        â”‚
â”‚  â”‚  - VPC: 10.1.x.x â”‚  â”‚  - VPC: 10.2.x.x â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚          â†•                      â†•                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  åä¸ºäº‘ CCE      â”‚  â”‚  å†…ç½‘ IDC        â”‚        â”‚
â”‚  â”‚  - Cluster-C     â”‚  â”‚  - Cluster-D     â”‚        â”‚
â”‚  â”‚  - 6x A100 èŠ‚ç‚¹  â”‚  â”‚  - 12x A100 èŠ‚ç‚¹ â”‚        â”‚
â”‚  â”‚  - VPC: 10.3.x.x â”‚  â”‚  - 192.168.x.x   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                     â”‚
â”‚  è·¨äº‘ç½‘ç»œ: VPN / ä¸“çº¿ / å…¬ç½‘ (ä¸ç¨³å®š)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒæŒ‘æˆ˜**ï¼š

1. **ç½‘ç»œå¼‚æ„**ï¼š
   - é›†ç¾¤å†…ï¼šK8s Pod ç½‘ç»œï¼ˆFlannel/Calicoï¼‰
   - é›†ç¾¤é—´ï¼šVPN/ä¸“çº¿/å…¬ç½‘æ··åˆ
   - âŒ RDMA ä¸å¯ç”¨ï¼ˆäº‘ç¯å¢ƒé™åˆ¶ï¼‰

2. **å»¶è¿Ÿå·®å¼‚**ï¼š
   - åŒé›†ç¾¤å†…ï¼š< 1ms
   - åŒäº‘ä¸åŒé›†ç¾¤ï¼š1-5ms
   - è·¨äº‘ï¼š10-50ms
   - è·¨å›½ï¼š100-200ms

3. **æˆæœ¬çº¦æŸ**ï¼š
   - GPU èŠ‚ç‚¹æ˜‚è´µï¼Œéœ€è¦å¤ç”¨
   - ä¸èƒ½ä¸º Mooncake Storage å•ç‹¬ç”³è¯·å¤§é‡èŠ‚ç‚¹

4. **è¿ç»´å¤æ‚åº¦**ï¼š
   - K8s ç¯å¢ƒåŠ¨æ€è°ƒåº¦
   - IP åœ°å€ä¸å›ºå®š
   - éœ€è¦ Service Discovery

#### 13.2 æ¶æ„è®¾è®¡æ–¹æ¡ˆ

**æ–¹æ¡ˆ Aï¼šå•é›†ç¾¤å†… PD åˆ†ç¦» + Mooncakeï¼ˆæ¨èï¼‰**

```
æ¯ä¸ª K8s é›†ç¾¤ç‹¬ç«‹éƒ¨ç½²å®Œæ•´çš„ Prefill + Decode + Mooncakeï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Cluster-A (é˜¿é‡Œäº‘ K8s)                     â”‚
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Namespace: llm-inference                   â”‚    â”‚
â”‚  â”‚                                             â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚  Mooncake Master Service             â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  - Deployment (1 replica)            â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  - StatefulSet with etcd             â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  - Service: mooncake-master:12345    â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â”‚                                             â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚  Mooncake Storage Nodes              â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  - DaemonSet (æ¯ä¸ª GPU èŠ‚ç‚¹ 1 ä¸ª)    â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  - hostNetwork: true                 â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  - ä½¿ç”¨èŠ‚ç‚¹ DRAM (256GB per node)    â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  - æ€»å®¹é‡: 8 nodes Ã— 256GB = 2TB     â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â”‚                                             â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚  vLLM Prefill Workers                â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  - Deployment (4 replicas)           â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  - æ¯ä¸ª Pod: 2 Ã— A100 GPU            â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  - LMCache Remote: mooncake://...    â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  - Service: vllm-prefill:8001        â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â”‚                                             â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚  vLLM Decode Workers                 â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  - Deployment (4 replicas)           â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  - æ¯ä¸ª Pod: 2 Ã— A100 GPU            â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  - LMCache Remote: mooncake://...    â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  - Service: vllm-decode:8002         â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â”‚                                             â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚  Ingress / API Gateway               â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  - è·¯ç”±è§„åˆ™:                          â”‚  â”‚    â”‚
â”‚  â”‚  â”‚    /v1/completions â†’ Prefill         â”‚  â”‚    â”‚
â”‚  â”‚  â”‚    /v1/chat â†’ Decode (if cache hit)  â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Cluster-B, C, D éƒ¨ç½²ç›¸åŒæ¶æ„ï¼ˆæ¯ä¸ªé›†ç¾¤ç‹¬ç«‹ï¼‰
```

**ä¸ºä»€ä¹ˆæ¨èè¿™ä¸ªæ–¹æ¡ˆï¼Ÿ**

```
âœ… ä¼˜ç‚¹:
1. ç½‘ç»œå»¶è¿Ÿä½ï¼šæ‰€æœ‰é€šä¿¡åœ¨é›†ç¾¤å†…ï¼Œ< 1ms
2. æ— éœ€ RDMAï¼šä½¿ç”¨ TCPï¼ŒK8s åŸç”Ÿæ”¯æŒ
3. æ•…éšœéš”ç¦»ï¼šä¸€ä¸ªé›†ç¾¤æ•…éšœä¸å½±å“å…¶ä»–
4. æˆæœ¬å¯æ§ï¼šå¤ç”¨ GPU èŠ‚ç‚¹çš„å†…å­˜ï¼Œæ— éœ€ä¸“ç”¨å­˜å‚¨èŠ‚ç‚¹
5. è¿ç»´ç®€å•ï¼šæ ‡å‡† K8s éƒ¨ç½²ï¼Œæ— éœ€ç‰¹æ®Šç½‘ç»œé…ç½®

âŒ ç¼ºç‚¹:
1. KV Cache ä¸èƒ½è·¨é›†ç¾¤å…±äº«
2. æ¯ä¸ªé›†ç¾¤éœ€è¦ç‹¬ç«‹çš„ Mooncake å­˜å‚¨æ± 
3. èµ„æºåˆ©ç”¨ç‡ç•¥ä½ï¼ˆæ¯ä¸ªé›†ç¾¤ç‹¬ç«‹å­˜å‚¨ï¼‰
```

**è¯¦ç»†é…ç½®ç¤ºä¾‹**ï¼š

**1. Mooncake Master Service éƒ¨ç½²**

```yaml
# mooncake-master.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: mooncake-master-config
  namespace: llm-inference
data:
  config.yaml: |
    etcd_endpoints:
      - http://mooncake-etcd:2379
    metadata_key_prefix: "/mooncake/cluster-a/"
    listen_address: "0.0.0.0:12345"
    segment_size_gb: 40
    default_replica_num: 2
    eviction_high_watermark: 0.8
    eviction_low_watermark: 0.6
    lease_ttl_seconds: 300

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mooncake-etcd
  namespace: llm-inference
spec:
  serviceName: mooncake-etcd
  replicas: 3
  selector:
    matchLabels:
      app: mooncake-etcd
  template:
    metadata:
      labels:
        app: mooncake-etcd
    spec:
      containers:
      - name: etcd
        image: quay.io/coreos/etcd:v3.5.9
        command:
        - /usr/local/bin/etcd
        - --name=$(POD_NAME)
        - --listen-client-urls=http://0.0.0.0:2379
        - --advertise-client-urls=http://$(POD_NAME).mooncake-etcd:2379
        - --listen-peer-urls=http://0.0.0.0:2380
        - --initial-advertise-peer-urls=http://$(POD_NAME).mooncake-etcd:2380
        - --initial-cluster=mooncake-etcd-0=http://mooncake-etcd-0.mooncake-etcd:2380,mooncake-etcd-1=http://mooncake-etcd-1.mooncake-etcd:2380,mooncake-etcd-2=http://mooncake-etcd-2.mooncake-etcd:2380
        - --initial-cluster-state=new
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        ports:
        - containerPort: 2379
          name: client
        - containerPort: 2380
          name: peer
        volumeMounts:
        - name: data
          mountPath: /var/run/etcd
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 10Gi

---
apiVersion: v1
kind: Service
metadata:
  name: mooncake-etcd
  namespace: llm-inference
spec:
  clusterIP: None
  ports:
  - port: 2379
    name: client
  - port: 2380
    name: peer
  selector:
    app: mooncake-etcd

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mooncake-master
  namespace: llm-inference
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mooncake-master
  template:
    metadata:
      labels:
        app: mooncake-master
    spec:
      containers:
      - name: master
        image: your-registry/mooncake-master:latest
        command:
        - /usr/local/bin/mooncake_master_service
        - --config=/etc/mooncake/config.yaml
        ports:
        - containerPort: 12345
          name: grpc
        volumeMounts:
        - name: config
          mountPath: /etc/mooncake
        resources:
          requests:
            cpu: "4"
            memory: "8Gi"
          limits:
            cpu: "8"
            memory: "16Gi"
      volumes:
      - name: config
        configMap:
          name: mooncake-master-config

---
apiVersion: v1
kind: Service
metadata:
  name: mooncake-master
  namespace: llm-inference
spec:
  type: ClusterIP
  ports:
  - port: 12345
    targetPort: 12345
    name: grpc
  selector:
    app: mooncake-master
```

**2. Mooncake Storage DaemonSet éƒ¨ç½²**

```yaml
# mooncake-storage.yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: mooncake-storage
  namespace: llm-inference
spec:
  selector:
    matchLabels:
      app: mooncake-storage
  template:
    metadata:
      labels:
        app: mooncake-storage
    spec:
      hostNetwork: true  # ä½¿ç”¨å®¿ä¸»æœºç½‘ç»œ,æé«˜æ€§èƒ½
      dnsPolicy: ClusterFirstWithHostNet
      nodeSelector:
        node-role.kubernetes.io/gpu-worker: "true"  # åªéƒ¨ç½²åœ¨ GPU èŠ‚ç‚¹
      containers:
      - name: storage
        image: your-registry/mooncake-storage:latest
        command:
        - /usr/local/bin/mooncake_storage_node
        - --master-address=mooncake-master.llm-inference.svc.cluster.local:12345
        - --segment-name=$(NODE_NAME)
        - --memory-size=256GB  # ä½¿ç”¨ 256GB DRAM
        - --transport=tcp  # K8s ç¯å¢ƒä½¿ç”¨ TCP
        - --listen-port=13546
        env:
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        ports:
        - containerPort: 13546
          name: data
          hostPort: 13546  # æ˜ å°„åˆ°å®¿ä¸»æœºç«¯å£
        resources:
          requests:
            cpu: "4"
            memory: "260Gi"  # 256GB for cache + 4GB overhead
          limits:
            cpu: "8"
            memory: "260Gi"
        volumeMounts:
        - name: hugepages
          mountPath: /dev/hugepages
      volumes:
      - name: hugepages
        emptyDir:
          medium: HugePages-2Mi
```

**3. vLLM Prefill Worker éƒ¨ç½²**

```yaml
# vllm-prefill.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: vllm-prefill-config
  namespace: llm-inference
data:
  lmcache_config.yaml: |
    chunk_size: 256
    local_device: "cuda"
    remote_config:
      url: "mooncake://mooncake-master.llm-inference.svc.cluster.local:12345"
      replica_num: 2
      lease_time_seconds: 300

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: vllm-prefill
  namespace: llm-inference
spec:
  replicas: 4
  selector:
    matchLabels:
      app: vllm-prefill
  template:
    metadata:
      labels:
        app: vllm-prefill
        role: prefill
    spec:
      containers:
      - name: vllm
        image: your-registry/vllm:latest-lmcache
        command:
        - python
        - -m
        - vllm.entrypoints.openai.api_server
        args:
        - --model=/models/Qwen2.5-72B
        - --tensor-parallel-size=2
        - --gpu-memory-utilization=0.9
        - --max-model-len=8192
        - --enable-prefix-caching
        - --kv-cache-dtype=fp8
        - --port=8001
        env:
        - name: LMCACHE_CONFIG_FILE
          value: /etc/lmcache/lmcache_config.yaml
        - name: VLLM_WORKER_ROLE
          value: "prefill"
        ports:
        - containerPort: 8001
          name: http
        resources:
          requests:
            nvidia.com/gpu: "2"  # 2 Ã— A100
            cpu: "16"
            memory: "64Gi"
          limits:
            nvidia.com/gpu: "2"
            cpu: "32"
            memory: "128Gi"
        volumeMounts:
        - name: lmcache-config
          mountPath: /etc/lmcache
        - name: model-storage
          mountPath: /models
      volumes:
      - name: lmcache-config
        configMap:
          name: vllm-prefill-config
      - name: model-storage
        persistentVolumeClaim:
          claimName: model-pvc

---
apiVersion: v1
kind: Service
metadata:
  name: vllm-prefill
  namespace: llm-inference
spec:
  type: ClusterIP
  ports:
  - port: 8001
    targetPort: 8001
    name: http
  selector:
    app: vllm-prefill
```

**4. vLLM Decode Worker éƒ¨ç½²**

```yaml
# vllm-decode.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: vllm-decode-config
  namespace: llm-inference
data:
  lmcache_config.yaml: |
    chunk_size: 256
    local_device: "cuda"
    remote_config:
      url: "mooncake://mooncake-master.llm-inference.svc.cluster.local:12345"
      replica_num: 2
      lease_time_seconds: 300

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: vllm-decode
  namespace: llm-inference
spec:
  replicas: 4
  selector:
    matchLabels:
      app: vllm-decode
  template:
    metadata:
      labels:
        app: vllm-decode
        role: decode
    spec:
      containers:
      - name: vllm
        image: your-registry/vllm:latest-lmcache
        command:
        - python
        - -m
        - vllm.entrypoints.openai.api_server
        args:
        - --model=/models/Qwen2.5-72B
        - --tensor-parallel-size=2
        - --gpu-memory-utilization=0.9
        - --max-model-len=32768  # Decode æ”¯æŒæ›´é•¿åºåˆ—
        - --enable-prefix-caching
        - --kv-cache-dtype=fp8
        - --port=8002
        env:
        - name: LMCACHE_CONFIG_FILE
          value: /etc/lmcache/lmcache_config.yaml
        - name: VLLM_WORKER_ROLE
          value: "decode"
        ports:
        - containerPort: 8002
          name: http
        resources:
          requests:
            nvidia.com/gpu: "2"
            cpu: "16"
            memory: "64Gi"
          limits:
            nvidia.com/gpu: "2"
            cpu: "32"
            memory: "128Gi"
        volumeMounts:
        - name: lmcache-config
          mountPath: /etc/lmcache
        - name: model-storage
          mountPath: /models
      volumes:
      - name: lmcache-config
        configMap:
          name: vllm-decode-config
      - name: model-storage
        persistentVolumeClaim:
          claimName: model-pvc

---
apiVersion: v1
kind: Service
metadata:
  name: vllm-decode
  namespace: llm-inference
spec:
  type: ClusterIP
  ports:
  - port: 8002
    targetPort: 8002
    name: http
  selector:
    app: vllm-decode
```

#### 13.3 è·¨é›†ç¾¤åœºæ™¯çš„æ–¹æ¡ˆ

**æ–¹æ¡ˆ Bï¼šè·¨é›†ç¾¤ KV Cache è”é‚¦ï¼ˆé«˜çº§æ–¹æ¡ˆï¼‰**

å¦‚æœç¡®å®éœ€è¦è·¨é›†ç¾¤å…±äº« KV Cacheï¼ˆä¸æ¨èï¼Œä½†å¯èƒ½æœ‰ç‰¹æ®Šéœ€æ±‚ï¼‰ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               å…¨å±€ etcd é›†ç¾¤ (è·¨äº‘éƒ¨ç½²)                 â”‚
â”‚  - ä½¿ç”¨ä¸“çº¿/VPN è¿æ¥                                   â”‚
â”‚  - 3-5 èŠ‚ç‚¹åˆ†å¸ƒåœ¨ä¸åŒäº‘                                â”‚
â”‚  - æä¾›å…¨å±€å…ƒæ•°æ®æœåŠ¡                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†•
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â†“                                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cluster-A   â”‚                          â”‚  Cluster-B   â”‚
â”‚  (é˜¿é‡Œäº‘)    â”‚ â†â”€â”€â”€ è·¨äº‘ä¸“çº¿/VPN â”€â”€â”€â”€â†’  â”‚  (AWS)       â”‚
â”‚              â”‚      (10-50ms)           â”‚              â”‚
â”‚  Mooncake    â”‚                          â”‚  Mooncake    â”‚
â”‚  Storage     â”‚                          â”‚  Storage     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ³¨æ„:
âŒ å»¶è¿Ÿé«˜ (10-50ms)ï¼Œå½±å“æ¨ç†æ€§èƒ½
âŒ ç½‘ç»œä¸ç¨³å®šï¼Œå¯èƒ½å¯¼è‡´ Cache ä¸å¯ç”¨
âŒ æˆæœ¬é«˜ (ä¸“çº¿è´¹ç”¨)
âŒ è¿ç»´å¤æ‚ (è·¨äº‘ç½‘ç»œæ•…éšœæ’æŸ¥)

ä»…åœ¨ä»¥ä¸‹æƒ…å†µè€ƒè™‘:
- æŸä¸ªé›†ç¾¤çš„ Prefill ç»“æœéœ€è¦åœ¨å¦ä¸€ä¸ªé›†ç¾¤ Decode
- æœ‰ä¸“çº¿ä¸”å»¶è¿Ÿ < 10ms
- æœ‰ä¸“ä¸šçš„è·¨äº‘ç½‘ç»œè¿ç»´å›¢é˜Ÿ
```

#### 13.4 éƒ¨ç½²æµç¨‹

**Step 1: ç¯å¢ƒå‡†å¤‡**

```bash
# 1. åˆ›å»º namespace
kubectl create namespace llm-inference

# 2. é…ç½® GPU Operator (å¦‚æœè¿˜æ²¡æœ‰)
helm repo add nvidia https://helm.ngc.nvidia.com/nvidia
helm install --wait --generate-name \
  -n gpu-operator --create-namespace \
  nvidia/gpu-operator

# 3. ç»™ GPU èŠ‚ç‚¹æ‰“æ ‡ç­¾
kubectl label nodes <gpu-node-1> node-role.kubernetes.io/gpu-worker=true
kubectl label nodes <gpu-node-2> node-role.kubernetes.io/gpu-worker=true
# ... å¯¹æ‰€æœ‰ GPU èŠ‚ç‚¹é‡å¤

# 4. é…ç½® HugePages (å¯é€‰ï¼Œæå‡æ€§èƒ½)
# åœ¨æ¯ä¸ª GPU èŠ‚ç‚¹ä¸Šæ‰§è¡Œ:
echo 65536 > /proc/sys/vm/nr_hugepages
# æ°¸ä¹…ç”Ÿæ•ˆ: æ·»åŠ åˆ° /etc/sysctl.conf
# vm.nr_hugepages = 65536
```

**Step 2: éƒ¨ç½² Mooncake**

```bash
# 1. éƒ¨ç½² etcd
kubectl apply -f mooncake-master.yaml

# ç­‰å¾… etcd å°±ç»ª
kubectl wait --for=condition=ready pod -l app=mooncake-etcd -n llm-inference --timeout=300s

# 2. éƒ¨ç½² Master Service
kubectl apply -f mooncake-master.yaml

# 3. éƒ¨ç½² Storage Nodes
kubectl apply -f mooncake-storage.yaml

# éªŒè¯éƒ¨ç½²
kubectl get pods -n llm-inference
# åº”è¯¥çœ‹åˆ°:
# mooncake-etcd-0, mooncake-etcd-1, mooncake-etcd-2
# mooncake-master-xxx
# mooncake-storage-xxx (æ¯ä¸ª GPU èŠ‚ç‚¹ä¸€ä¸ª)
```

**Step 3: éƒ¨ç½² vLLM Workers**

```bash
# 1. å‡†å¤‡æ¨¡å‹ PVC (å‡è®¾å·²æœ‰å…±äº«å­˜å‚¨)
kubectl apply -f model-pvc.yaml

# 2. éƒ¨ç½² Prefill Workers
kubectl apply -f vllm-prefill.yaml

# 3. éƒ¨ç½² Decode Workers
kubectl apply -f vllm-decode.yaml

# éªŒè¯
kubectl get pods -n llm-inference -l app=vllm-prefill
kubectl get pods -n llm-inference -l app=vllm-decode
```

**Step 4: é…ç½® Ingress å’Œè·¯ç”±**

```yaml
# ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: llm-inference-ingress
  namespace: llm-inference
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  rules:
  - host: llm-api.your-company.com
    http:
      paths:
      - path: /v1/completions
        pathType: Prefix
        backend:
          service:
            name: vllm-prefill
            port:
              number: 8001
      - path: /v1/chat/completions
        pathType: Prefix
        backend:
          service:
            name: vllm-decode
            port:
              number: 8002
```

#### 13.5 ç›‘æ§ä¸è¿ç»´

**Prometheus ç›‘æ§æŒ‡æ ‡**ï¼š

```yaml
# servicemonitor.yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: mooncake-monitoring
  namespace: llm-inference
spec:
  selector:
    matchLabels:
      app: mooncake-storage
  endpoints:
  - port: metrics
    interval: 15s

---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: vllm-monitoring
  namespace: llm-inference
spec:
  selector:
    matchLabels:
      app: vllm-prefill
  endpoints:
  - port: http
    path: /metrics
    interval: 15s
```

**å…³é”®ç›‘æ§æŒ‡æ ‡**ï¼š

```
Mooncake:
- mooncake_storage_used_bytes: å·²ä½¿ç”¨å­˜å‚¨
- mooncake_storage_total_bytes: æ€»å­˜å‚¨å®¹é‡
- mooncake_cache_hit_rate: KV Cache å‘½ä¸­ç‡
- mooncake_rdma_transfer_bytes: æ•°æ®ä¼ è¾“é‡
- mooncake_eviction_total: é©±é€æ¬¡æ•°

vLLM:
- vllm_request_duration_seconds: è¯·æ±‚å»¶è¿Ÿ
- vllm_gpu_memory_usage: GPU æ˜¾å­˜ä½¿ç”¨
- vllm_kv_cache_hit_rate: KV Cache å‘½ä¸­ç‡
- vllm_tokens_per_second: ååé‡
```

**Grafana Dashboard**ï¼š

```json
{
  "dashboard": {
    "title": "Mooncake + vLLM Monitoring",
    "panels": [
      {
        "title": "KV Cache Hit Rate",
        "targets": [
          {
            "expr": "rate(mooncake_cache_hit_total[5m]) / rate(mooncake_cache_access_total[5m])"
          }
        ]
      },
      {
        "title": "Storage Usage",
        "targets": [
          {
            "expr": "mooncake_storage_used_bytes / mooncake_storage_total_bytes * 100"
          }
        ]
      },
      {
        "title": "Request Latency (P95)",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(vllm_request_duration_seconds_bucket[5m]))"
          }
        ]
      }
    ]
  }
}
```

#### 13.6 æˆæœ¬åˆ†æ

**å•é›†ç¾¤æˆæœ¬ä¼°ç®— (Cluster-A, 8 nodes)**ï¼š

```
GPU æˆæœ¬:
- 8 nodes Ã— 8 A100 (80GB) = 64 GPUs
- é˜¿é‡Œäº‘æŒ‰éœ€: ~Â¥50/GPU/å°æ—¶
- æ¯æœˆ: Â¥50 Ã— 64 Ã— 24 Ã— 30 = Â¥2,304,000

Mooncake å­˜å‚¨æˆæœ¬:
- å¤ç”¨ GPU èŠ‚ç‚¹å†…å­˜ï¼Œæ— é¢å¤–æˆæœ¬
- ä»…éœ€å°‘é‡ CPU/å†…å­˜è¿è¡Œ Storage Daemon

ç½‘ç»œæˆæœ¬:
- é›†ç¾¤å†…é€šä¿¡å…è´¹
- è·¨é›†ç¾¤é€šä¿¡: Â¥0.8/GB (VPN) æˆ– Â¥5-10/GB (å…¬ç½‘)
- å»ºè®®å•é›†ç¾¤éƒ¨ç½²ï¼Œé¿å…è·¨é›†ç¾¤é€šä¿¡

ROI è®¡ç®—:
- æ—  Mooncake: GPU åˆ©ç”¨ç‡ 30%, æœ‰æ•ˆ GPU = 64 Ã— 0.3 = 19.2
- æœ‰ Mooncake: GPU åˆ©ç”¨ç‡ 75%, æœ‰æ•ˆ GPU = 64 Ã— 0.75 = 48
- èŠ‚çœæˆæœ¬: (64 - 48) / 64 Ã— Â¥2,304,000 = Â¥576,000/æœˆ
```

#### 13.7 æ•…éšœå¤„ç†

**å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ**ï¼š

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| Storage Node å¯åŠ¨å¤±è´¥ | å†…å­˜ä¸è¶³ | è°ƒæ•´ `--memory-size` å‚æ•°ï¼Œç¡®ä¿èŠ‚ç‚¹æœ‰è¶³å¤Ÿ DRAM |
| vLLM æ— æ³•è¿æ¥ Mooncake | DNS è§£æé—®é¢˜ | æ£€æŸ¥ Service æ˜¯å¦åˆ›å»ºï¼Œä½¿ç”¨ FQDN è®¿é—® |
| Cache å‘½ä¸­ç‡ä½ | Replica æ•°é‡ä¸è¶³ | å¢åŠ  `replica_num` åˆ° 2 æˆ– 3 |
| è·¨é›†ç¾¤å»¶è¿Ÿé«˜ | ç½‘ç»œè·¯å¾„ä¸ä¼˜ | ä½¿ç”¨ä¸“çº¿ï¼Œæˆ–æ”¹ä¸ºå•é›†ç¾¤éƒ¨ç½² |
| etcd æ•…éšœå¯¼è‡´æœåŠ¡ä¸å¯ç”¨ | å•ç‚¹æ•…éšœ | éƒ¨ç½² 3 æˆ– 5 èŠ‚ç‚¹ etcd é›†ç¾¤ |

---

## ç¬¬äº”éƒ¨åˆ†:æ€»ç»“ä¸å±•æœ›

### 14. é€‚ç”¨åœºæ™¯åˆ†æ

#### 12.1 æœ€é€‚åˆçš„åœºæ™¯

**1. é«˜é‡å¤æ€§é—®ç­”åœºæ™¯**

```
å…¸å‹åœºæ™¯: å®¢æœæœºå™¨äºº,FAQ ç³»ç»Ÿ

ç‰¹å¾:
- ç”¨æˆ·é—®é¢˜é«˜åº¦ç›¸ä¼¼ (80%+ é‡å¤ç‡)
- System Prompt å›ºå®šä¸”é•¿ (1000+ tokens)
- å¤šè½®å¯¹è¯,å†å²å¯¹è¯ä¸æ–­ç´¯ç§¯

æ”¶ç›Š:
âœ… KV Cache å‘½ä¸­ç‡ > 85%
âœ… Prefill æ—¶é—´é™ä½ 80-90%
âœ… ååé‡æå‡ 5-10x
âœ… GPU åˆ©ç”¨ç‡æå‡ 3-5x

æ¡ˆä¾‹:
æŸç”µå•†å®¢æœç³»ç»Ÿ,10000 æ¬¡/å¤©å’¨è¯¢
- ä¼ ç»Ÿ: éœ€è¦ 20 å¼  A100 GPU
- Mooncake: åªéœ€ 4 å¼  A100 GPU
- æˆæœ¬èŠ‚çœ: 80% ($500K â†’ $100K/å¹´)
```

**2. RAG (Retrieval-Augmented Generation)**

```
å…¸å‹åœºæ™¯: æ–‡æ¡£é—®ç­”,çŸ¥è¯†åº“æ£€ç´¢

ç‰¹å¾:
- æ£€ç´¢åˆ°çš„ Context é•¿åº¦å¤§ (5000-10000 tokens)
- Context åœ¨ä¸€æ®µæ—¶é—´å†…ä¸å˜
- ä¸åŒç”¨æˆ·å¯èƒ½æ£€ç´¢åˆ°ç›¸åŒæ–‡æ¡£

æ”¶ç›Š:
âœ… Context éƒ¨åˆ†çš„ KV Cache å®Œå…¨å¤ç”¨
âœ… åªéœ€ Prefill ç”¨æˆ·é—®é¢˜ (100 tokens)
âœ… å“åº”æ—¶é—´ä» 10s â†’ 1.5s (6.7x æå‡)

æ¡ˆä¾‹:
æŸä¼ä¸šçŸ¥è¯†åº“ç³»ç»Ÿ (10 TB æ–‡æ¡£)
- å¸¸è§æ–‡æ¡£ (20%) å  80% è®¿é—®é‡
- è¿™ 20% æ–‡æ¡£çš„ KV Cache å¸¸é©» Mooncake
- Prefill æ—¶é—´é™ä½ 85%
```

**3. å¤šè½®å¯¹è¯ (Multi-turn Conversation)**

```
å…¸å‹åœºæ™¯: AI åŠ©æ‰‹,å¯¹è¯å¼ç¼–ç¨‹åŠ©æ‰‹

ç‰¹å¾:
- æ¯è½®å¯¹è¯éƒ½éœ€è¦å†å²ä¸Šä¸‹æ–‡
- å†å²é•¿åº¦éšè½®æ¬¡çº¿æ€§å¢é•¿
- ç¬¬ N è½®åªå¢åŠ å°‘é‡æ–° tokens

æ”¶ç›Š:
âœ… å†å²å¯¹è¯ KV Cache å…¨éƒ¨å¤ç”¨
âœ… åª Prefill å½“å‰è½®æ–°å¢å†…å®¹
âœ… éšå¯¹è¯è½®æ¬¡æå‡,åŠ é€Ÿæ¯”é€’å¢

æ¡ˆä¾‹:
GitHub Copilot ç±»ç¼–ç¨‹åŠ©æ‰‹
- ç¬¬ 1 è½®: å®Œæ•´ Prefill (5s)
- ç¬¬ 5 è½®: åª Prefill æ–°å¢ (0.5s)
- ç¬¬ 10 è½®: åŠ é€Ÿ 10x+
```

#### 12.2 ä¸é€‚åˆçš„åœºæ™¯

**1. ä½é‡å¤æ€§ç”Ÿæˆä»»åŠ¡**

```
åœºæ™¯: åˆ›æ„å†™ä½œ,å°è¯´ç”Ÿæˆ

é—®é¢˜:
âŒ æ¯æ¬¡ prompt éƒ½ä¸åŒ,æ— æ³•å‘½ä¸­ç¼“å­˜
âŒ Mooncake å¼€é”€ (RDMA ä¼ è¾“) åè€Œé™ä½æ€§èƒ½
âŒ ä¸å¦‚ç›´æ¥ç”¨ GPU æœ¬åœ°ç¼“å­˜

ç»“è®º: ä¸æ¨èä½¿ç”¨
```

**2. çŸ­æ–‡æœ¬æ¨ç† (< 1000 tokens)**

```
åœºæ™¯: çŸ­æ–‡æœ¬åˆ†ç±»,æƒ…æ„Ÿåˆ†æ

é—®é¢˜:
âŒ Prefill æ—¶é—´æœ¬èº«å¾ˆçŸ­ (< 1s)
âŒ RDMA ä¼ è¾“å»¶è¿Ÿ (0.4s) å æ¯”è¿‡é«˜
âŒ æ”¶ç›Šä¸æ˜æ˜¾

ç»“è®º: ä»…æ¨èåœ¨æé«˜ QPS ä¸‹ä½¿ç”¨
```

**3. æ—  RDMA ç¯å¢ƒ**

```
åœºæ™¯: å…¬æœ‰äº‘,ä¸æ”¯æŒ RDMA çš„æœºæˆ¿

é—®é¢˜:
âŒ TCP ä¼ è¾“å¸¦å®½ä½ (1 GB/s vs 25 GB/s)
âŒ ä¼ è¾“ 10 GB KV Cache éœ€è¦ 10 ç§’
âŒ æ¯”é‡æ–° Prefill æ›´æ…¢

ç»“è®º: å¿…é¡»æœ‰ RDMA æ”¯æŒæ‰æ¨èä½¿ç”¨
```

#### 12.3 ROI è®¡ç®—æ¨¡å‹

```python
# ROI è®¡ç®—å…¬å¼

# å‚æ•°
avg_prompt_length = 5000  # å¹³å‡ prompt é•¿åº¦ (tokens)
cache_hit_rate = 0.7      # ç¼“å­˜å‘½ä¸­ç‡
qps = 100                 # æ¯ç§’è¯·æ±‚æ•°
gpu_cost_per_hour = 3.5   # A100 æ¯å°æ—¶æˆæœ¬ ($)

# ä¼ ç»Ÿæ¶æ„
prefill_time_traditional = avg_prompt_length * 0.01  # 50 ç§’
gpu_needed_traditional = qps * prefill_time_traditional / 3600  # éœ€è¦çš„ GPU æ•°

# Mooncake æ¶æ„
prefill_time_mooncake = avg_prompt_length * 0.01 * (1 - cache_hit_rate)  # 15 ç§’ (å‘½ä¸­æ—¶)
rdma_transfer_time = 0.4  # ç§’
total_time_mooncake = prefill_time_mooncake + rdma_transfer_time  # 15.4 ç§’

gpu_needed_mooncake = qps * total_time_mooncake / 3600

# æˆæœ¬å¯¹æ¯”
cost_traditional = gpu_needed_traditional * gpu_cost_per_hour * 24 * 365
cost_mooncake = gpu_needed_mooncake * gpu_cost_per_hour * 24 * 365

roi = (cost_traditional - cost_mooncake) / cost_mooncake

print(f"ä¼ ç»Ÿæ¶æ„éœ€è¦ GPU: {gpu_needed_traditional:.1f} å¼ ")
print(f"Mooncake éœ€è¦ GPU: {gpu_needed_mooncake:.1f} å¼ ")
print(f"èŠ‚çœæˆæœ¬: ${cost_traditional - cost_mooncake:.0f}/å¹´")
print(f"ROI: {roi:.1%}")

# è¾“å‡ºç¤ºä¾‹:
# ä¼ ç»Ÿæ¶æ„éœ€è¦ GPU: 138.9 å¼ 
# Mooncake éœ€è¦ GPU: 42.8 å¼ 
# èŠ‚çœæˆæœ¬: $2,943,780/å¹´
# ROI: 324%
```

---

### 13. è¸©å‘ç»éªŒåˆ†äº«

#### 13.1 RDMA é…ç½®é—®é¢˜

**é—®é¢˜ 1: GPUDirect RDMA ä¸ç”Ÿæ•ˆ**

```bash
# ç—‡çŠ¶
# - RDMA ä¼ è¾“é€Ÿåº¦æ…¢ (< 5 GB/s)
# - nvidia-smi æ˜¾ç¤º GPU åˆ©ç”¨ç‡ä½

# æ’æŸ¥
# 1. æ£€æŸ¥ GPU é©±åŠ¨æ˜¯å¦æ”¯æŒ GPUDirect
nvidia-smi -q | grep "GPU Direct"
# åº”è¾“å‡º: GPU Direct: Enabled

# 2. æ£€æŸ¥ RDMA ç½‘å¡é©±åŠ¨
modprobe nv_peer_mem
lsmod | grep nv_peer_mem
# åº”æœ‰è¾“å‡º

# 3. æ£€æŸ¥ GPU å’Œ RDMA NIC çš„ PCIe æ‹“æ‰‘
nvidia-smi topo -m
# GPU å’Œ NIC åº”é€šè¿‡ PCIe Switch è¿æ¥,æœ€å¥½åœ¨åŒä¸€ NUMA

# è§£å†³æ–¹æ¡ˆ
sudo modprobe nv_peer_mem
sudo systemctl restart mooncake-storage
```

**é—®é¢˜ 2: RDMA Connection Timeout**

```bash
# ç—‡çŠ¶
# TransferEngine æŠ¥é”™: "Failed to establish RDMA connection"

# åŸå› 
# - é˜²ç«å¢™é˜»æ­¢ RDMA ç«¯å£
# - InfiniBand Subnet Manager æœªè¿è¡Œ

# è§£å†³æ–¹æ¡ˆ
# 1. å…³é—­é˜²ç«å¢™ (æˆ–æ”¾è¡Œ RDMA ç«¯å£)
sudo ufw disable

# 2. å¯åŠ¨ OpenSM (InfiniBand Subnet Manager)
sudo systemctl start opensm
sudo systemctl enable opensm

# 3. æ£€æŸ¥ RDMA è¿æ¥çŠ¶æ€
ibstat | grep "State"
# åº”è¾“å‡º: State: Active
```

#### 13.2 å…ƒæ•°æ®ä¸€è‡´æ€§é—®é¢˜

**é—®é¢˜ 3: etcd é›†ç¾¤è„‘è£‚**

```bash
# ç—‡çŠ¶
# Master Service æ— æ³•å¯åŠ¨,æŠ¥é”™: "etcd cluster unhealthy"

# åŸå› 
# etcd é›†ç¾¤èŠ‚ç‚¹æ•°ä¸ºå¶æ•° (å¦‚ 2 æˆ– 4),å¯¼è‡´è„‘è£‚

# è§£å†³æ–¹æ¡ˆ
# etcd é›†ç¾¤å¿…é¡»æ˜¯å¥‡æ•°èŠ‚ç‚¹ (3, 5, 7)
# æ¨è 3 èŠ‚ç‚¹ (å°è§„æ¨¡) æˆ– 5 èŠ‚ç‚¹ (å¤§è§„æ¨¡)

# æ£€æŸ¥ etcd å¥åº·çŠ¶æ€
etcdctl endpoint health --cluster

# æ¢å¤è„‘è£‚
# 1. åœæ­¢æ‰€æœ‰ etcd èŠ‚ç‚¹
# 2. åˆ é™¤ data-dir
# 3. é‡æ–°å¯åŠ¨ (æŒ‰ èŠ‚ç‚¹ 1 â†’ èŠ‚ç‚¹ 2 â†’ èŠ‚ç‚¹ 3 é¡ºåº)
```

**é—®é¢˜ 4: Segment ä¿¡æ¯ä¸åŒæ­¥**

```bash
# ç—‡çŠ¶
# Transfer Engine æŠ¥é”™: "Segment not found"

# åŸå› 
# Storage Node å¯åŠ¨åæœªæ­£ç¡®æ³¨å†Œåˆ° etcd

# è§£å†³æ–¹æ¡ˆ
# æ‰‹åŠ¨è§¦å‘åŒæ­¥
mooncake-cli sync-segments --metadata-uri etcd://127.0.0.1:2379

# æˆ–é‡å¯ Storage Node
sudo systemctl restart mooncake-storage
```

#### 13.3 æ€§èƒ½ä¼˜åŒ–é—®é¢˜

**é—®é¢˜ 5: KV Cache å‘½ä¸­ç‡ä½**

```python
# ç—‡çŠ¶
# Mooncake ç›‘æ§æ˜¾ç¤ºå‘½ä¸­ç‡ < 20%

# åŸå›  1: LMCache chunk_size è®¾ç½®è¿‡å°
# è§£å†³æ–¹æ¡ˆ: å¢å¤§ chunk_size
chunk_size: 256  # æ”¹ä¸º 512 æˆ– 1024

# åŸå›  2: ç§Ÿçº¦æ—¶é—´å¤ªçŸ­,KV Cache è¢«æå‰é©±é€
# è§£å†³æ–¹æ¡ˆ: å¢å¤§ kv_lease_ttl_ms
"kv_lease_ttl_ms": 300000  # ä» 60s æ”¹ä¸º 5 åˆ†é’Ÿ

# åŸå›  3: é©±é€é˜ˆå€¼å¤ªä½
# è§£å†³æ–¹æ¡ˆ: æé«˜ eviction_high_watermark
"eviction_high_watermark": 0.9  # ä» 0.8 æ”¹ä¸º 0.9
```

**é—®é¢˜ 6: RDMA ä¼ è¾“æ…¢**

```bash
# ç—‡çŠ¶
# ä¼ è¾“ 10 GB éœ€è¦ 2 ç§’+ (é¢„æœŸ 0.4 ç§’)

# æ’æŸ¥
# 1. æ£€æŸ¥ RDMA ç½‘å¡é€Ÿç‡
ibstat | grep "Rate"
# åº”è¾“å‡º: Rate: 200 Gbps

# 2. æµ‹è¯•è£¸ RDMA æ€§èƒ½
ib_send_bw --use_cuda=0
# åº” > 23 GB/s

# 3. æ£€æŸ¥ NUMA ç»‘å®š
numactl --show
# Transfer Engine åº”ç»‘å®šåˆ°ä¸ RDMA NIC ç›¸åŒçš„ NUMA èŠ‚ç‚¹

# è§£å†³æ–¹æ¡ˆ
# å¯åŠ¨æ—¶ç»‘å®š NUMA
numactl --cpunodebind=0 --membind=0 mooncake-storage --config ...
```

#### 13.4 ç¨³å®šæ€§é—®é¢˜

**é—®é¢˜ 7: å†…å­˜æ³„æ¼**

```bash
# ç—‡çŠ¶
# Storage Node å†…å­˜å ç”¨æŒç»­å¢é•¿,æœ€ç»ˆ OOM

# åŸå› 
# é©±é€çº¿ç¨‹æœªæ­£å¸¸å·¥ä½œ,KV Cache æœªè¢«åŠæ—¶æ¸…ç†

# æ’æŸ¥
# æŸ¥çœ‹é©±é€ç»Ÿè®¡
curl http://localhost:12347/metrics | grep eviction_count
# å¦‚æœä¸º 0,è¯´æ˜é©±é€æœªè§¦å‘

# è§£å†³æ–¹æ¡ˆ
# 1. é™ä½é©±é€é˜ˆå€¼
"eviction_high_watermark": 0.7  # ä» 0.8 æ”¹ä¸º 0.7

# 2. æ‰‹åŠ¨è§¦å‘é©±é€
mooncake-cli evict --ratio 0.5

# 3. é‡å¯ Master Service (æœ€åæ‰‹æ®µ)
sudo systemctl restart mooncake-master
```

**é—®é¢˜ 8: Master Service å•ç‚¹æ•…éšœ**

```bash
# ç—‡çŠ¶
# Master Service æŒ‚æ‰,æ•´ä¸ªé›†ç¾¤ä¸å¯ç”¨

# è§£å†³æ–¹æ¡ˆ: å¯ç”¨ HA (é«˜å¯ç”¨)
# master_config.json
{
    "enable_ha": true,
    "ha_config": {
        "election_timeout_ms": 3000,
        "heartbeat_interval_ms": 500
    }
}

# éƒ¨ç½² 3 ä¸ª Master Service å®ä¾‹
# - åªæœ‰ 1 ä¸ª Leader,å…¶ä½™ä¸º Follower
# - Leader æ•…éšœæ—¶è‡ªåŠ¨é€‰ä¸¾æ–° Leader
# - å¯¹å®¢æˆ·ç«¯é€æ˜
```

---

### 14. åç»­ä¼˜åŒ–æ–¹å‘

#### 14.1 çŸ­æœŸä¼˜åŒ– (3-6 ä¸ªæœˆ)

**1. æ™ºèƒ½é¢„å– (Prefetching)**

```python
# å½“å‰: è¢«åŠ¨è·å– KV Cache (ç”¨æˆ·è¯·æ±‚æ—¶æ‰æ‹‰å–)
# ä¼˜åŒ–: ä¸»åŠ¨é¢„å– (é¢„æµ‹ç”¨æˆ·ä¸‹ä¸€è½®å¯¹è¯)

class SmartPrefetcher:
    def predict_next_prompt(self, conversation_history):
        # ä½¿ç”¨å°æ¨¡å‹é¢„æµ‹ç”¨æˆ·ä¸‹ä¸€è½®å¯èƒ½çš„é—®é¢˜
        candidates = predictor_model.generate(conversation_history, num_candidates=5)

        # åå°é¢„å–è¿™äº›å€™é€‰ prompt çš„ KV Cache
        for candidate in candidates:
            key = hash(candidate)
            mooncake_client.prefetch(key, priority="low")

# æ”¶ç›Š:
# - é¢„å–å‘½ä¸­æ—¶å»¶è¿Ÿ < 100 ms (vs 400 ms RDMA ä¼ è¾“)
# - ç”¨æˆ·æ„ŸçŸ¥å»¶è¿Ÿé™ä½ 75%
```

**2. å‹ç¼©ä¼ è¾“**

```cpp
// å½“å‰: ä¼ è¾“åŸå§‹ KV Cache (FP16)
// ä¼˜åŒ–: å‹ç¼©åä¼ è¾“

// ä½¿ç”¨ INT8 é‡åŒ– + LZ4 å‹ç¼©
// - KV Cache å¤§å°: 10 GB â†’ 3 GB (å‹ç¼©ç‡ 70%)
// - ä¼ è¾“æ—¶é—´: 0.4s â†’ 0.12s (3.3x æå‡)
// - è§£å‹æ—¶é—´: ~20ms (GPU åŠ é€Ÿ)

// æƒè¡¡:
// âœ… ä¼ è¾“å¿« 3x
// âœ… å­˜å‚¨èŠ‚çœ 70%
// âŒ ç²¾åº¦ç•¥å¾®æŸå¤± (< 1% å½±å“)
```

**3. åˆ†å±‚å­˜å‚¨ä¼˜åŒ–**

```
å½“å‰: å†…å­˜å‰¯æœ¬ + ç£ç›˜å‰¯æœ¬ (å¯é€‰)

ä¼˜åŒ–: å¤šçº§ç¼“å­˜æ¶æ„
L0: GPU HBM (æœ€çƒ­æ•°æ®,100 GB)
L1: CPU DRAM (çƒ­æ•°æ®,1 TB)
L2: NVMe SSD (æ¸©æ•°æ®,10 TB)
L3: HDD (å†·æ•°æ®,100 TB)

ç­–ç•¥:
- æ ¹æ®è®¿é—®é¢‘ç‡è‡ªåŠ¨è¿ç§»
- L0/L1 Miss â†’ L2/L3 å¼‚æ­¥é¢„å–
- æˆæœ¬ä¼˜åŒ–: 80% æ•°æ®åœ¨ L2/L3,èŠ‚çœ DRAM æˆæœ¬
```

#### 14.2 ä¸­æœŸä¼˜åŒ– (6-12 ä¸ªæœˆ)

**1. è·¨æ•°æ®ä¸­å¿ƒåŒæ­¥**

```
åœºæ™¯: å¤šåœ°åŸŸéƒ¨ç½² (åŒ—äº¬,ä¸Šæµ·,æ·±åœ³)

æŒ‘æˆ˜:
- è·¨åœ°åŸŸ RDMA ä¸å¯ç”¨
- TCP å¹¿åŸŸç½‘å»¶è¿Ÿé«˜ (50-100 ms)

æ–¹æ¡ˆ: å¼‚æ­¥å¤åˆ¶ + æœ€ç»ˆä¸€è‡´æ€§
1. çƒ­æ•°æ®ä¸»åŠ¨å¤åˆ¶åˆ°å…¶ä»–åœ°åŸŸ
2. å†·æ•°æ®æŒ‰éœ€æ‹‰å– + æœ¬åœ°ç¼“å­˜
3. å…¨å±€å…ƒæ•°æ®ä½¿ç”¨ Multi-Region etcd

æ”¶ç›Š:
- ç”¨æˆ·å°±è¿‘è®¿é—®,å»¶è¿Ÿé™ä½ 80%
- è·¨åœ°åŸŸå®¹ç¾
```

**2. GPU å†…å­˜æ± åŒ–**

```cpp
// å½“å‰: æ¯ä¸ª GPU ç‹¬ç«‹ç®¡ç† KV Cache
// ä¼˜åŒ–: æ‰€æœ‰ GPU çš„æ˜¾å­˜ç»Ÿä¸€ç®¡ç†

class GPUMemoryPool {
    // è·¨ GPU å…±äº« KV Cache
    // ä½¿ç”¨ NVLink / NVSwitch å®ç° GPU é—´é›¶æ‹·è´

    // åœºæ™¯:
    // - GPU 0 çš„ KV Cache å¯ä»¥ç›´æ¥è¢« GPU 7 è®¿é—®
    // - æ— éœ€ç»è¿‡ CPU/DRAM
    // - å»¶è¿Ÿ < 10 us (vs 400 ms RDMA)
};

// æ”¶ç›Š:
// - GPU å†…åˆ©ç”¨ç‡æå‡ 2-3x
// - å»¶è¿Ÿé™ä½ 40x
```

**3. æ™ºèƒ½é©±é€ç­–ç•¥**

```python
# å½“å‰: Near-LRU (åŸºäº lease_timeout)
# ä¼˜åŒ–: æœºå™¨å­¦ä¹ é©±é€ç­–ç•¥

class MLEvictionStrategy:
    def predict_access_probability(self, key):
        features = [
            access_count_last_1h,
            access_count_last_24h,
            object_size,
            creation_time,
            user_tier,  # VIP ç”¨æˆ·
            content_type  # system_prompt, rag_context, etc.
        ]

        return ml_model.predict(features)  # 0-1 ä¹‹é—´

    def evict(self):
        # é©±é€è®¿é—®æ¦‚ç‡æœ€ä½çš„å¯¹è±¡
        candidates = sorted(cache.items(), key=lambda x: self.predict_access_probability(x[0]))
        for key, _ in candidates[:evict_count]:
            cache.remove(key)

# æ”¶ç›Š:
# - å‘½ä¸­ç‡æå‡ 10-15%
# - é©±é€æ›´ç²¾å‡†,å‡å°‘è¯¯é©±é€
```

#### 14.3 é•¿æœŸå±•æœ› (1-2 å¹´)

**1. ç¡¬ä»¶ååŒè®¾è®¡**

```
- å®šåˆ¶ RDMA ç½‘å¡: å†…ç½® KV Cache å‹ç¼©/è§£å‹
- CXL å†…å­˜æ‰©å±•: ä½¿ç”¨ CXL 3.0 æ‰©å±• TB çº§å†…å­˜
- SmartNIC å¸è½½: å…ƒæ•°æ®æŸ¥è¯¢å¸è½½åˆ° SmartNIC
```

**2. ä¸æ¨ç†å¼•æ“æ·±åº¦é›†æˆ**

```
- vLLM åŸç”Ÿæ”¯æŒ Mooncake (æ— éœ€ LMCache ä¸­é—´å±‚)
- TensorRT-LLM é›†æˆ
- æ¨ç†æ¡†æ¶è‡ªåŠ¨æ„ŸçŸ¥ KV Cache ä½ç½®
```

**3. æ ‡å‡†åŒ–ä¸å¼€æºç”Ÿæ€**

```
- KV Cache ä¼ è¾“åè®®æ ‡å‡†åŒ–
- ä¸ ONNX Runtime é›†æˆ
- æ”¯æŒæ›´å¤šæ¨¡å‹æ¶æ„ (Mixtral, Llama, etc.)
```

---

## æ€»ç»“

Mooncake æ˜¯ä¸€ä¸ª**é©å‘½æ€§çš„ KV Cache ç®¡ç†ç³»ç»Ÿ**,é€šè¿‡ä»¥ä¸‹æ ¸å¿ƒæŠ€æœ¯å®ç°äº† LLM æ¨ç†çš„è´¨å˜:

### æ ¸å¿ƒä»·å€¼

**æœ¬è´¨: ç‰ºç‰²å†…å­˜æ¢å–è®¡ç®—æ•ˆç‡**

Mooncake çš„æ ¸å¿ƒè®¾è®¡å“²å­¦æ˜¯: ç”¨**å»‰ä»·çš„ DRAM** å­˜å‚¨ KV Cache,é¿å…**æ˜‚è´µçš„ GPU** é‡å¤è®¡ç®—ã€‚è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„**ç©ºé—´æ¢æ—¶é—´**ç­–ç•¥,ä½†åœ¨ LLM æ¨ç†åœºæ™¯ä¸‹,è¿™ä¸ªæƒè¡¡éå¸¸åˆ’ç®—ã€‚

1. **å†…å­˜æ¢æ•ˆç‡** â†’ ç”¨ TB çº§ DRAM ($4K/TB) ä»£æ›¿é‡å¤è®¡ç®— (èŠ‚çœ 10+ GPU = $150K+)
2. **Prefill-Decode è§£è€¦** â†’ èµ„æºç‹¬ç«‹ä¼˜åŒ–,å¼¹æ€§æ‰©å±•
3. **RDMA é›¶æ‹·è´ä¼ è¾“** â†’ 200 Gbps å¸¦å®½,æ¥è¿‘æœ¬åœ°è®¿é—®
4. **åˆ†å¸ƒå¼ KV Cache æ± ** â†’ TB çº§å®¹é‡,å…¨å±€å¤ç”¨
5. **æ™ºèƒ½å…ƒæ•°æ®ç®¡ç†** â†’ é«˜å¹¶å‘ (500 ä¸‡ QPS),è‡ªåŠ¨é©±é€

### æ€§èƒ½æ”¶ç›Š

| æŒ‡æ ‡ | ä¼ ç»Ÿæ¶æ„ | Mooncake | æå‡ |
|------|---------|----------|------|
| **Prefill æ—¶é—´** | 10 ç§’ | 1.4 ç§’ | 7.1x |
| **GPU åˆ©ç”¨ç‡** | 20% | 70%+ | 3.5x |
| **å¹¶å‘èƒ½åŠ›** | å•è¯·æ±‚ | 10-100 è¯·æ±‚ | 10-100x |
| **æˆæœ¬** | 100 GPU | 20 GPU | èŠ‚çœ 80% |

### é€‚ç”¨åœºæ™¯

âœ… **å¼ºçƒˆæ¨è**: å®¢æœæœºå™¨äºº,RAG é—®ç­”,å¤šè½®å¯¹è¯
âœ… **æ¨è**: é«˜é‡å¤æ€§ä»»åŠ¡,é•¿æ–‡æœ¬æ¨ç†
âŒ **ä¸æ¨è**: åˆ›æ„å†™ä½œ,çŸ­æ–‡æœ¬åˆ†ç±»,æ—  RDMA ç¯å¢ƒ

### å…³é”®è¦æ±‚

- å¿…é¡»æœ‰ **RDMA ç½‘å¡** (200+ Gbps)
- å¿…é¡»æœ‰ **å¤§å†…å­˜** (512 GB+ per node)
- å¿…é¡»æœ‰ **é«˜é‡å¤æ€§** åœºæ™¯ (ç¼“å­˜å‘½ä¸­ç‡ > 60%)

---

**æ–‡æ¡£ç»“æŸ**

> æœ¬æ–‡æ¡£é€‚ç”¨äºå…¬å¸å†…éƒ¨æŠ€æœ¯åˆ†äº«,æ¶µç›– Mooncake çš„æ¶æ„è®¾è®¡ã€æºç åˆ†æã€éƒ¨ç½²å®è·µå’Œæ€§èƒ½è°ƒä¼˜ã€‚å¦‚æœ‰ç–‘é—®,è¯·è”ç³»åŸºç¡€è®¾æ–½å›¢é˜Ÿã€‚

